<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注专转  砖转 RM-CPA</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
        }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .user-info { display: flex; align-items: center; gap: 15px; }
        .notification-bell { position: relative; cursor: pointer; font-size: 1.5em; color: #667eea; }
        .notification-count {
            position: absolute; top: -8px; right: -8px; background: #e74c3c; color: white;
            border-radius: 50%; width: 20px; height: 20px; font-size: 0.7em;
            display: flex; align-items: center; justify-content: center;
        }
        
        .auth-container, .main-app {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .hidden { display: none !important; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 600; }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 12px 15px; border: 2px solid #e1e8ed; border-radius: 10px;
            font-size: 16px; transition: all 0.3s ease; background: rgba(255, 255, 255, 0.9);
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .checkbox-group { display: flex; align-items: center; gap: 10px; margin-top: 15px; }
        .checkbox-group input[type="checkbox"] { width: auto; }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none;
            padding: 12px 25px; border-radius: 10px; cursor: pointer; font-size: 16px;
            font-weight: 600; transition: all 0.3s ease; margin: 5px;
        }
        
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: linear-gradient(45deg, #95a5a6, #34495e); }
        .btn-danger { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .btn-success { background: linear-gradient(45deg, #27ae60, #2ecc71); }
        .btn-warning { background: linear-gradient(45deg, #f39c12, #e67e22); }
        
        .nav-tabs {
            display: flex; background: rgba(255, 255, 255, 0.1); border-radius: 15px;
            padding: 5px; margin-bottom: 30px;
        }
        
        .nav-tab {
            flex: 1; padding: 15px; text-align: center; border-radius: 10px; cursor: pointer;
            transition: all 0.3s ease; color: #2c3e50; font-weight: 600;
        }
        
        .nav-tab.active { background: white; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
        
        .dashboard-stats {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            padding: 20px; border-radius: 15px; text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); cursor: pointer; transition: all 0.3s ease;
        }
        
        .stat-card:hover { transform: translateY(-3px); }
        .stat-number { font-size: 2em; font-weight: bold; color: #667eea; margin-bottom: 5px; }
        
        .task-form-container {
            background: rgba(255, 255, 255, 0.9); border-radius: 15px; padding: 30px;
            margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .form-row {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; margin-bottom: 20px;
        }
        
        .task-list { background: rgba(255, 255, 255, 0.9); border-radius: 15px; padding: 20px; margin-top: 20px; }
        
        .task-item {
            background: white; border: 1px solid #e1e8ed; border-radius: 10px; padding: 20px;
            margin-bottom: 15px; transition: all 0.3s ease; position: relative;
        }
        
        .task-item:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .task-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .task-title { font-weight: bold; color: #2c3e50; font-size: 1.2em; flex: 1; }
        
        .task-status {
            padding: 6px 12px; border-radius: 20px; font-size: 0.8em;
            font-weight: bold; white-space: nowrap; margin-right: 10px;
        }
        
        .status-not-started { background: #95a5a6; color: white; }
        .status-in-progress { background: #3498db; color: white; }
        .status-waiting-client { background: #f39c12; color: white; }
        .status-partner-review { background: #9b59b6; color: white; }
        .status-completed { background: #27ae60; color: white; }
        
        .task-details-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px; margin-bottom: 15px; color: #7f8c8d; font-size: 0.9em;
        }
        
        .task-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
        
        .filters { background: rgba(255, 255, 255, 0.9); padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        .filters-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end; }
        
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        
        .modal-content {
            background: white; padding: 30px; border-radius: 20px; max-width: 600px;
            width: 90%; max-height: 80vh; overflow-y: auto;
        }
        
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e1e8ed;
        }
        
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #7f8c8d; }
        
        .success-message, .error-message {
            padding: 10px 15px; border-radius: 10px; margin: 10px 0; text-align: center;
        }
        
        .success-message { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error-message { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        
        .autocomplete-container { position: relative; }
        .autocomplete-list {
            position: absolute; top: 100%; left: 0; right: 0; background: white;
            border: 1px solid #e1e8ed; border-radius: 10px; max-height: 200px;
            overflow-y: auto; z-index: 100; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .autocomplete-item { padding: 10px 15px; cursor: pointer; transition: background 0.2s; }
        .autocomplete-item:hover { background: #f8f9fa; }
        
        .comments-section {
            background: #f8f9fa; border-radius: 10px; padding: 15px; margin-top: 15px;
        }
        
        .comment-item {
            background: white; border-radius: 8px; padding: 12px; margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        
        .comment-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px; font-size: 0.9em; color: #7f8c8d;
        }
        
        .comment-content { color: #2c3e50; line-height: 1.4; }
        
        .notification-panel {
            position: fixed; top: 80px; left: 20px; width: 350px; max-height: 400px;
            background: white; border-radius: 15px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            z-index: 1000; overflow-y: auto;
        }
        
        .notification-header {
            padding: 15px 20px; border-bottom: 1px solid #e1e8ed;
            font-weight: bold; color: #2c3e50;
        }
        
        .notification-item {
            padding: 15px 20px; border-bottom: 1px solid #f1f1f1;
            cursor: pointer; transition: background 0.2s;
        }
        
        .notification-item:hover { background: #f8f9fa; }
        .notification-item.unread { background: #e3f2fd; border-left: 4px solid #2196f3; }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header { flex-direction: column; text-align: center; gap: 15px; }
            .header h1 { font-size: 1.5em; }
            .nav-tabs { flex-direction: column; }
            .dashboard-stats { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .task-header { flex-direction: column; align-items: flex-start; gap: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 转专转 -->
        <div class="header">
            <h1> 注专转  砖转 RM-CPA</h1>
            <div id="headerInfo" class="hidden">
                <div class="user-info">
                    <div class="notification-bell" onclick="toggleNotifications()">
                        
                        <span id="notificationCount" class="notification-count hidden">0</span>
                    </div>
                    <div>
                        <strong id="currentUserName"></strong>
                        <span id="currentUserRole"></span>
                    </div>
                    <button class="btn btn-secondary" onclick="logout()">转转拽</button>
                </div>
            </div>
        </div>

        <!-- 驻 转专转 -->
        <div id="notificationPanel" class="notification-panel hidden">
            <div class="notification-header">
                转专转
                <button class="btn btn-secondary" style="float: left; padding: 5px 10px; font-size: 0.8em;" onclick="markAllAsRead()">住  拽专</button>
            </div>
            <div id="notificationList"></div>
        </div>

        <!-- 住 转专转 -->
        <div id="authScreen" class="auth-container">
            <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">住 注专转</h2>
            <div class="form-group">
                <label>砖 砖转砖:</label>
                <input type="text" id="loginUsername" placeholder=" 砖 砖转砖">
            </div>
            <div class="form-group">
                <label>拽 砖:</label>
                <input type="password" id="loginCode" placeholder=" 拽 砖">
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="rememberMe">
                <label for="rememberMe">专 转</label>
            </div>
            <button class="btn" onclick="login()">转专</button>
            <div id="authMessage"></div>
        </div>

        <!-- 住 注 -->
        <div id="employeeApp" class="main-app hidden">
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="showEmployeeTab('create')">爪专转 砖</div>
                <div class="nav-tab" onclick="showEmployeeTab('my-tasks')">砖转 砖</div>
            </div>

            <!-- 爪专转 砖 - 注 -->
            <div id="employeeCreateTab" class="tab-content">
                <div class="task-form-container">
                    <h3 style="margin-bottom: 25px; color: #2c3e50;">砖 砖</h3>
                    <form id="employeeTaskForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>转专转 砖:</label>
                                <input type="text" id="empTaskTitle" required placeholder="转专 拽爪专 转 砖">
                            </div>
                            <div class="form-group">
                                <label>拽:</label>
                                <div class="autocomplete-container">
                                    <input type="text" id="empTaskClient" required placeholder="转 拽 砖 拽..." oninput="filterClients(this.value, 'empClientList')">
                                    <div id="empClientList" class="autocomplete-list hidden"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>住 注:</label>
                                <select id="empTaskType" required>
                                    <option value="">专 住 注</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>转专 注:</label>
                                <input type="date" id="empTaskDueDate" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>转专 砖:</label>
                            <textarea id="empTaskDescription" rows="4" placeholder="驻专 注 砖, 专砖转 转, 住 专砖 '"></textarea>
                        </div>

                        <div class="form-group">
                            <label>注专转 专砖转:</label>
                            <textarea id="empTaskNotes" rows="3" placeholder="注专转, 砖转  注 住祝"></textarea>
                        </div>

                        <button type="submit" class="btn btn-success">爪专 砖</button>
                        <button type="button" class="btn btn-secondary" onclick="clearEmployeeForm()">拽 驻住</button>
                    </form>
                </div>
            </div>

            <!-- 砖转 砖 - 注 -->
            <div id="employeeMyTasksTab" class="tab-content hidden">
                <div class="filters">
                    <h3 style="margin-bottom: 15px;">砖转 砖</h3>
                    <div class="filters-row">
                        <div class="form-group">
                            <label>驻砖:</label>
                            <input type="text" id="empSearchTasks" placeholder="驻砖 砖转..." oninput="filterEmployeeTasks()">
                        </div>
                        <div class="form-group">
                            <label>住住:</label>
                            <select id="empFilterStatus" onchange="filterEmployeeTasks()">
                                <option value=""> 住住</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>住 注:</label>
                            <select id="empFilterType" onchange="filterEmployeeTasks()">
                                <option value=""> 住</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>:</label>
                            <select id="empSortTasks" onchange="filterEmployeeTasks()">
                                <option value="due-date-asc">转专 注 (拽专 专拽)</option>
                                <option value="due-date-desc">转专 注 (专拽 拽专)</option>
                                <option value="created-desc">爪专 专</option>
                                <option value="created-asc">爪专 专砖</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="task-list">
                    <div id="employeeTasksList"></div>
                </div>
            </div>
        </div>

        <!-- 住 砖转祝 -->
        <div id="partnerApp" class="main-app hidden">
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="showPartnerTab('dashboard')">砖专</div>
                <div class="nav-tab" onclick="showPartnerTab('settings')">专转</div>
            </div>

            <!-- 砖专 砖转祝 -->
            <div id="partnerDashboardTab" class="tab-content">
                <!-- 爪专转 砖 - 砖转祝 -->
                <div class="task-form-container">
                    <h3 style="margin-bottom: 25px; color: #2c3e50;">爪专转 砖 砖</h3>
                    <form id="partnerTaskForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>转专转 砖:</label>
                                <input type="text" id="partTaskTitle" required placeholder="转专 拽爪专 转 砖">
                            </div>
                            <div class="form-group">
                                <label>拽:</label>
                                <div class="autocomplete-container">
                                    <input type="text" id="partTaskClient" required placeholder="转 拽 砖 拽..." oninput="filterClients(this.value, 'partClientList')">
                                    <div id="partClientList" class="autocomplete-list hidden"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>住 注:</label>
                                <select id="partTaskType" required>
                                    <option value="">专 住 注</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>注 驻:</label>
                                <select id="partTaskAssignee" required>
                                    <option value="">专 注 驻</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>转专 注:</label>
                                <input type="date" id="partTaskDueDate" required>
                            </div>
                            <div class="form-group">
                                <label>住住:</label>
                                <select id="partTaskStatus">
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>转专 砖:</label>
                            <textarea id="partTaskDescription" rows="3" placeholder="驻专 注 砖"></textarea>
                        </div>

                        <button type="submit" class="btn btn-success">爪专 砖</button>
                        <button type="button" class="btn btn-secondary" onclick="clearPartnerForm()">拽 驻住</button>
                    </form>
                </div>

                <!-- 住住拽转 -->
                <div class="dashboard-stats">
                    <div class="stat-card" onclick="filterPartnerTasks('all')">
                        <div class="stat-number" id="totalTasks">0</div>
                        <div>住" 砖转</div>
                    </div>
                    <div class="stat-card" onclick="filterPartnerTasks('active')">
                        <div class="stat-number" id="activeTasks">0</div>
                        <div>砖转 驻注转</div>
                    </div>
                    <div class="stat-card" onclick="filterPartnerTasks('overdue')">
                        <div class="stat-number" id="overdueTasks">0</div>
                        <div>砖转 专</div>
                    </div>
                    <div class="stat-card" onclick="filterPartnerTasks('partner-review')">
                        <div class="stat-number" id="reviewTasks">0</div>
                        <div>转转 拽</div>
                    </div>
                </div>

                <!-- 住 砖转 -->
                <div class="filters">
                    <h3 style="margin-bottom: 15px;"> 砖转</h3>
                    <div class="filters-row">
                        <div class="form-group">
                            <label>驻砖:</label>
                            <input type="text" id="partnerSearchTasks" placeholder="驻砖 砖转..." oninput="filterPartnerTasks()">
                        </div>
                        <div class="form-group">
                            <label>注 驻:</label>
                            <select id="partnerFilterEmployee" onchange="filterPartnerTasks()">
                                <option value=""> 注</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>住住:</label>
                            <select id="partnerFilterStatus" onchange="filterPartnerTasks()">
                                <option value=""> 住住</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>住 注:</label>
                            <select id="partnerFilterType" onchange="filterPartnerTasks()">
                                <option value=""> 住</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>:</label>
                            <select id="partnerSortTasks" onchange="filterPartnerTasks()">
                                <option value="due-date-asc">转专 注 (拽专 专拽)</option>
                                <option value="due-date-desc">转专 注 (专拽 拽专)</option>
                                <option value="created-desc">爪专 专</option>
                                <option value="created-asc">爪专 专砖</option>
                                <option value="status">驻 住住</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="task-list">
                    <div id="partnerTasksList"></div>
                </div>
            </div>

            <!-- 专转 砖转祝 -->
            <div id="partnerSettingsTab" class="tab-content hidden">
                <div class="nav-tabs" style="margin-bottom: 20px;">
                    <div class="nav-tab active" onclick="showSettingsTab('users')"> 砖转砖</div>
                    <div class="nav-tab" onclick="showSettingsTab('system')">专转 注专转</div>
                    <div class="nav-tab" onclick="showSettingsTab('data')"> 转</div>
                </div>

                <!--  砖转砖 -->
                <div id="settingsUsersTab" class="settings-content">
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="showModal('userModal')">住祝 砖转砖</button>
                    </div>
                    <div id="usersList"></div>
                </div>

                <!-- 专转 注专转 -->
                <div id="settingsSystemTab" class="settings-content hidden">
                    <h3>专转 注专转</h3>
                    <div class="form-group">
                        <label>住 注 ( 住 砖专 驻专转):</label>
                        <textarea id="workTypes" rows="6"> 砖转 专
 砖转 砖
砖注专
驻 砖祝
 拽住转
驻 专砖转</textarea>
                        <button class="btn" onclick="updateWorkTypes()">注 住 注</button>
                    </div>
                    
                    <div class="form-group">
                        <label>住住 注 ( 住住 砖专 驻专转):</label>
                        <textarea id="workStatuses" rows="5">专 转
注
 转 拽
注专 拽转 砖转祝
住转</textarea>
                        <button class="btn" onclick="updateWorkStatuses()">注 住住</button>
                    </div>
                </div>

                <!--  转 -->
                <div id="settingsDataTab" class="settings-content hidden">
                    <h3> 转</h3>
                    <div class="form-group">
                        <label>专砖转 拽转 - Google Sheets:</label>
                        <input type="url" id="clientsSheetUrl" placeholder=" 拽砖专 拽抓
                            <input type="url" id="clientsSheetUrl" placeholder=" 拽砖专 拽抓 专砖转 拽转" value="https://docs.google.com/spreadsheets/d/1rZvtny_hfa-7VvV0MzkPMGssLIUUVDm6/edit">
                        <button class="btn" onclick="updateClientsUrl()">注 拽砖专</button>
                        <button class="btn btn-success" onclick="syncClients()">住专 拽转 注砖</button>
                    </div>
                    
                    <div class="form-group">
                        <label> 注专转 - Google Sheets:</label>
                        <input type="url" id="backupSheetUrl" placeholder=" 拽砖专 拽抓 " value="https://docs.google.com/spreadsheets/d/1n380H7Wkz8ZB5e8KxmlRUAbvx3EMxK0DMGUyABqokb4/edit">
                        <button class="btn" onclick="updateBackupUrl()">注 拽砖专</button>
                        <button class="btn btn-success" onclick="saveToSheets()"> Sheets 注砖</button>
                    </div>

                    <div class="form-group">
                        <label>爪  转:</label>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-secondary" onclick="exportToExcel()">爪 拽住</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()"> 拽住</button>
                            <input type="file" id="importFile" accept=".xlsx,.xls,.json" style="display: none;" onchange="importData(event)">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>住专 :</label>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-warning" onclick="setupAutoSync()">驻注 住专 砖注</button>
                            <button class="btn btn-secondary" onclick="disableAutoSync()"> 住专 </button>
                        </div>
                        <p style="margin-top: 10px; color: #7f8c8d; font-size: 0.9em;">
                            住专 砖注 注 转 专砖转 拽转 转   专砖 -09:00
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal 砖转砖 -->
    <div id="userModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">砖转砖 砖</h3>
                <button class="close-btn" onclick="hideModal('userModal')">&times;</button>
            </div>
            <form id="userForm">
                <div class="form-group">
                    <label>砖 :</label>
                    <input type="text" id="userFullName" required placeholder="砖  砖 砖转砖">
                </div>
                <div class="form-group">
                    <label>砖 砖转砖:</label>
                    <input type="text" id="userUsername" required placeholder="砖 砖转砖 ">
                </div>
                <div class="form-group">
                    <label>转驻拽:</label>
                    <select id="userRole" required>
                        <option value="employee">注</option>
                        <option value="partner">砖转祝</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>:</label>
                    <input type="email" id="userEmail" placeholder="转转 ">
                </div>
                <div class="form-group">
                    <label>拽 砖:</label>
                    <input type="password" id="userCode" placeholder="拽 砖 注专转" required>
                </div>
                <button type="submit" class="btn">砖专 砖转砖</button>
                <button type="button" class="btn btn-secondary" onclick="hideModal('userModal')"></button>
            </form>
        </div>
    </div>

    <!-- Modal 注专转 砖 -->
    <div id="editTaskModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>注专转 砖</h3>
                <button class="close-btn" onclick="hideModal('editTaskModal')">&times;</button>
            </div>
            <form id="editTaskForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>转专转 砖:</label>
                        <input type="text" id="editTaskTitle" required>
                    </div>
                    <div class="form-group">
                        <label>住住:</label>
                        <select id="editTaskStatus" required>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>拽:</label>
                        <input type="text" id="editTaskClient" required>
                    </div>
                    <div class="form-group">
                        <label>转专 注:</label>
                        <input type="date" id="editTaskDueDate" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>住 注:</label>
                    <select id="editTaskType" required>
                    </select>
                </div>

                <div class="form-group">
                    <label>转专 砖:</label>
                    <textarea id="editTaskDescription" rows="3"></textarea>
                </div>

                <button type="submit" class="btn">注 砖</button>
                <button type="button" class="btn btn-secondary" onclick="hideModal('editTaskModal')"></button>
            </form>
        </div>
    </div>

    <script>
        // 砖转 
        let currentUser = null;
        let users = [];
        let tasks = [];
        let clients = [];
        let notifications = [];
        let currentEditTaskId = null;
        let currentEditUserId = null;
        let workTypes = [' 砖转 专', ' 砖转 砖', '砖注专', '驻 砖祝', ' 拽住转', '驻 专砖转'];
        let workStatuses = ['专 转', '注', ' 转 拽', '注专 拽转 砖转祝', '住转'];
        let autoSyncEnabled = false;

        // 转 专砖
        function initializeData() {
            users = [
                {
                    id: 1,
                    username: 'shmuel',
                    fullName: '砖',
                    role: 'partner',
                    email: 'shmuel@rm-cpa.co.il',
                    code: '123456'
                }
            ];

            clients = [
                { id: 1, name: '专转 ABC 注"', contact: '住 ', phone: '050-1234567' },
                { id: 2, name: '砖专 XYZ 注"', contact: '砖专 ', phone: '052-9876543' },
                { id: 3, name: '注住拽 123 砖拽注转', contact: ' 专', phone: '054-5555555' },
                { id: 4, name: '专转 DEF 转', contact: '专 ', phone: '053-7777777' },
                { id: 5, name: '砖专 GHI 注抓', contact: '专 ', phone: '052-8888888' }
            ];

            tasks = [];
            notifications = [];
        }

        // 驻拽爪转 转专转
        function login() {
            const username = document.getElementById('loginUsername').value;
            const code = document.getElementById('loginCode').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            
            if (!username || !code) {
                showMessage('authScreen', '  砖 砖转砖 拽 砖', 'error');
                return;
            }

            const user = users.find(u => u.username === username && u.code === code);
            
            if (user) {
                currentUser = user;
                
                if (rememberMe) {
                    localStorage.setItem('rmcpa-remember', JSON.stringify({
                        username: username,
                        code: code
                    }));
                } else {
                    localStorage.removeItem('rmcpa-remember');
                }
                
                showMainApp();
            } else {
                showMessage('authScreen', '砖 砖转砖  拽 砖 砖', 'error');
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('rmcpa-remember');
            document.getElementById('employeeApp').classList.add('hidden');
            document.getElementById('partnerApp').classList.add('hidden');
            document.getElementById('headerInfo').classList.add('hidden');
            document.getElementById('authScreen').classList.remove('hidden');
            clearLoginForm();
        }

        function clearLoginForm() {
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginCode').value = '';
            document.getElementById('rememberMe').checked = false;
        }

        function showMainApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('headerInfo').classList.remove('hidden');
            
            document.getElementById('currentUserName').textContent = currentUser.fullName;
            document.getElementById('currentUserRole').textContent = `(${currentUser.role === 'partner' ? '砖转祝' : '注'})`;
            
            if (currentUser.role === 'employee') {
                document.getElementById('employeeApp').classList.remove('hidden');
                document.getElementById('partnerApp').classList.add('hidden');
                setTodayDate('empTaskDueDate');
                showEmployeeTab('create');
                updateEmployeeTasksCounter();
            } else {
                document.getElementById('partnerApp').classList.remove('hidden');
                document.getElementById('employeeApp').classList.add('hidden');
                setTodayDate('partTaskDueDate');
                showPartnerTab('dashboard');
                updatePartnerStats();
                loadPartnerEmployeeOptions();
            }
            
            updateFormOptions();
            updateNotifications();
        }

        function setTodayDate(elementId) {
            const today = new Date().toISOString().split('T')[0];
            const element = document.getElementById(elementId);
            if (element && !element.value) {
                element.value = today;
            }
        }

        // 注 驻砖专转 驻住
        function updateFormOptions() {
            // 注 住 注
            const typeSelects = ['empTaskType', 'partTaskType', 'editTaskType', 'empFilterType', 'partnerFilterType'];
            typeSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    const firstOption = select.querySelector('option:first-child');
                    select.innerHTML = '';
                    if (firstOption) select.appendChild(firstOption);
                    
                    workTypes.forEach(type => {
                        const option = document.createElement('option');
                        option.value = convertToValue(type);
                        option.textContent = type;
                        if (option.value === currentValue) option.selected = true;
                        select.appendChild(option);
                    });
                }
            });

            // 注 住住
            const statusSelects = ['partTaskStatus', 'editTaskStatus', 'empFilterStatus', 'partnerFilterStatus'];
            statusSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    const firstOption = select.querySelector('option:first-child');
                    select.innerHTML = '';
                    if (firstOption) select.appendChild(firstOption);
                    
                    workStatuses.forEach(status => {
                        const option = document.createElement('option');
                        option.value = convertToValue(status);
                        option.textContent = status;
                        if (option.value === currentValue) option.selected = true;
                        select.appendChild(option);
                    });
                }
            });
        }

        function convertToValue(text) {
            return text.replace(/\s+/g, '-').replace(/[^\w\-]/g, '').toLowerCase();
        }

        function convertFromValue(value) {
            const typeMap = {
                'annual-company': ' 砖转 专',
                'annual-personal': ' 砖转 砖',
                'estimate': '砖注专',
                'ongoing': '驻 砖祝',
                'fine-cancellation': ' 拽住转',
                'authority-contact': '驻 专砖转',
                'not-started': '专 转',
                'in-progress': '注',
                'waiting-client': ' 转 拽',
                'partner-review': '注专 拽转 砖转祝',
                'completed': '住转'
            };
            return typeMap[value] || value;
        }

        // 住 拽转 (autocomplete)
        function filterClients(searchTerm, listId) {
            const list = document.getElementById(listId);
            
            if (!searchTerm || searchTerm.length < 2) {
                list.classList.add('hidden');
                return;
            }
            
            const filteredClients = clients.filter(client => 
                client.name.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            list.innerHTML = '';
            
            if (filteredClients.length === 0) {
                list.classList.add('hidden');
                return;
            }
            
            filteredClients.forEach(client => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.textContent = client.name;
                item.onclick = () => {
                    if (listId === 'empClientList') {
                        document.getElementById('empTaskClient').value = client.name;
                    } else if (listId === 'partClientList') {
                        document.getElementById('partTaskClient').value = client.name;
                    }
                    list.classList.add('hidden');
                };
                list.appendChild(item);
            });
            
            list.classList.remove('hidden');
        }

        // 驻拽爪转 注专 转
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('he-IL');
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('he-IL');
        }

        function showMessage(containerId, message, type) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;
            
            container.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 3000);
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            if (modalId === 'userModal') {
                currentEditUserId = null;
                document.getElementById('userForm').reset();
                document.getElementById('userModalTitle').textContent = '砖转砖 砖';
            }
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        //  砖转
        function sortTasks(tasks, sortBy) {
            switch(sortBy) {
                case 'due-date-asc':
                    tasks.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
                    break;
                case 'due-date-desc':
                    tasks.sort((a, b) => new Date(b.dueDate) - new Date(a.dueDate));
                    break;
                case 'created-asc':
                    tasks.sort((a, b) => new Date(a.createdDate) - new Date(b.createdDate));
                    break;
                case 'created-desc':
                    tasks.sort((a, b) => new Date(b.createdDate) - new Date(a.createdDate));
                    break;
                case 'status':
                    const statusOrder = { 'partner-review': 1, 'waiting-client': 2, 'in-progress': 3, 'not-started': 4, 'completed': 5 };
                    tasks.sort((a, b) => statusOrder[a.status] - statusOrder[b.status]);
                    break;
            }
        }

        // 爪专转  砖
        function createTaskElement(task, userType) {
            const taskDiv = document.createElement('div');
            taskDiv.className = 'task-item';
            
            const assignedUser = users.find(u => u.id === task.assignedTo);
            const createdUser = users.find(u => u.id === task.createdBy);
            
            const statusClass = `status-${task.status.replace(/[^a-z0-9]/gi, '-')}`;
            const statusText = convertFromValue(task.status);
            const typeText = convertFromValue(task.type);
            
            const isOverdue = task.status !== 'completed' && new Date(task.dueDate) < new Date();
            const hasUnreadComments = task.comments && task.comments.some(c => !c.isRead && c.authorId !== currentUser.id);
            
            taskDiv.innerHTML = `
                <div class="task-header">
                    <div class="task-title">
                        ${task.title}
                        ${hasUnreadComments ? ' ' : ''}
                        ${isOverdue ? ' 锔' : ''}
                    </div>
                    <div class="task-status ${statusClass}">${statusText}</div>
                </div>
                
                <div class="task-details-grid">
                    <div><strong>拽:</strong> ${task.client}</div>
                    <div><strong>住 注:</strong> ${typeText}</div>
                    <div><strong>转专 注:</strong> ${formatDate(task.dueDate)}</div>
                    ${userType === 'partner' ? `<div><strong>注 驻:</strong> ${assignedUser ? assignedUser.fullName : ' 注'}</div>` : ''}
                    <div><strong>爪专 注 :</strong> ${createdUser ? createdUser.fullName : ' 注'}</div>
                    <div><strong>爪专 转专:</strong> ${formatDate(task.createdDate)}</div>
                </div>
                
                ${task.description ? `
                    <div style="margin-top: 10px; color: #7f8c8d;">
                        <strong>转专:</strong> ${task.description}
                    </div>
                ` : ''}
                
                <div class="task-actions">
                    ${userType === 'employee' ? `
                        <button class="btn" onclick="updateTaskStatus(${task.id})">注 住住</button>
                        <button class="btn btn-secondary" onclick="addTaskComment(${task.id})">住祝 注专</button>
                    ` : `
                        <button class="btn" onclick="editTask(${task.id})">注专</button>
                        <button class="btn btn-secondary" onclick="addTaskComment(${task.id})">住祝 注专</button>
                        <button class="btn btn-danger" onclick="deleteTask(${task.id})">拽</button>
                    `}
                </div>
                
                ${task.comments && task.comments.length > 0 ? createCommentsSection(task) : ''}
            `;
            
            if (isOverdue) {
                taskDiv.style.borderLeft = '4px solid #e74c3c';
            }
            
            if (hasUnreadComments) {
                taskDiv.style.background = 'linear-gradient(to right, #fff3cd, #ffffff)';
            }
            
            return taskDiv;
        }

        function createCommentsSection(task) {
            const commentsHtml = task.comments.map(comment => `
                <div class="comment-item ${!comment.isRead && comment.authorId !== currentUser.id ? 'unread' : ''}">
                    <div class="comment-header">
                        <strong>${comment.author}</strong>
                        <span>${formatDateTime(comment.date)}</span>
                    </div>
                    <div class="comment-content">${comment.content}</div>
                    ${currentUser.role === 'partner' && comment.authorId !== currentUser.id && !comment.isRead ? `
                        <button class="btn btn-secondary" style="margin-top: 8px; padding: 4px 8px; font-size: 0.8em;" onclick="markCommentAsRead(${task.id}, ${comment.id})">
                            住 拽专
                        </button>
                    ` : ''}
                </div>
            `).join('');
            
            return `
                <div class="comments-section">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">注专转 注转</h4>
                    ${commentsHtml}
                </div>
            `;
        }
        // 驻拽爪转 注
        function showEmployeeTab(tabName) {
            document.querySelectorAll('#employeeApp .tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            document.querySelectorAll('#employeeApp .nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            if (tabName === 'create') {
                document.getElementById('employeeCreateTab').classList.remove('hidden');
                event.target.classList.add('active');
            } else if (tabName === 'my-tasks') {
                document.getElementById('employeeMyTasksTab').classList.remove('hidden');
                event.target.classList.add('active');
                filterEmployeeTasks();
            }
        }

        // 爪专转 砖 - 注
        document.getElementById('employeeTaskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            createEmployeeTask();
        });

        function createEmployeeTask() {
            const title = document.getElementById('empTaskTitle').value;
            const client = document.getElementById('empTaskClient').value;
            const type = document.getElementById('empTaskType').value;
            const dueDate = document.getElementById('empTaskDueDate').value;
            const description = document.getElementById('empTaskDescription').value;
            const notes = document.getElementById('empTaskNotes').value;
            
            if (!title || !client || !type || !dueDate) {
                showMessage('employeeCreateTab', '  转  砖转 专砖', 'error');
                return;
            }

            const task = {
                id: Date.now(),
                title,
                client,
                type,
                dueDate,
                description,
                notes,
                status: 'not-started',
                assignedTo: currentUser.id,
                createdBy: currentUser.id,
                createdDate: new Date().toISOString(),
                lastModified: new Date().toISOString(),
                comments: notes ? [{
                    id: Date.now(),
                    author: currentUser.fullName,
                    authorId: currentUser.id,
                    content: notes,
                    date: new Date().toISOString(),
                    isRead: false
                }] : []
            };

            tasks.push(task);
            addNotification(`砖 砖 爪专: ${title}`, 'new-task', task.id);
            clearEmployeeForm();
            showMessage('employeeCreateTab', '砖 爪专 爪!', 'success');
            saveData();
        }

        function clearEmployeeForm() {
            document.getElementById('employeeTaskForm').reset();
            setTodayDate('empTaskDueDate');
        }

        function filterEmployeeTasks() {
            const searchTerm = document.getElementById('empSearchTasks').value.toLowerCase();
            const statusFilter = document.getElementById('empFilterStatus').value;
            const typeFilter = document.getElementById('empFilterType').value;
            const sortBy = document.getElementById('empSortTasks').value;
            
            let filteredTasks = tasks.filter(task => task.assignedTo === currentUser.id);
            
            if (searchTerm) {
                filteredTasks = filteredTasks.filter(task => 
                    task.title.toLowerCase().includes(searchTerm) ||
                    task.client.toLowerCase().includes(searchTerm) ||
                    task.description.toLowerCase().includes(searchTerm)
                );
            }
            
            if (statusFilter) {
                filteredTasks = filteredTasks.filter(task => task.status === statusFilter);
            }
            
            if (typeFilter) {
                filteredTasks = filteredTasks.filter(task => task.type === typeFilter);
            }
            
            sortTasks(filteredTasks, sortBy);
            displayTasks(filteredTasks, 'employeeTasksList', 'employee');
            updateEmployeeTasksCounter();
        }

        function updateEmployeeTasksCounter() {
            const myTasks = tasks.filter(task => task.assignedTo === currentUser.id);
            const activeTasks = myTasks.filter(task => task.status !== 'completed').length;
            
            const tabText = `砖转 砖${activeTasks > 0 ? ` (${activeTasks})` : ''}`;
            const tabs = document.querySelectorAll('#employeeApp .nav-tab');
            if (tabs[1]) tabs[1].textContent = tabText;
        }

        // 驻拽爪转 砖转祝
        function showPartnerTab(tabName) {
            document.querySelectorAll('#partnerApp .tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            document.querySelectorAll('#partnerApp .nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            if (tabName === 'dashboard') {
                document.getElementById('partnerDashboardTab').classList.remove('hidden');
                event.target.classList.add('active');
                loadPartnerDashboard();
            } else if (tabName === 'settings') {
                document.getElementById('partnerSettingsTab').classList.remove('hidden');
                event.target.classList.add('active');
                loadPartnerSettings();
            }
        }

        function loadPartnerDashboard() {
            updatePartnerStats();
            loadPartnerEmployeeOptions();
            filterPartnerTasks();
        }

        function loadPartnerEmployeeOptions() {
            const selects = ['partTaskAssignee', 'partnerFilterEmployee'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">专 注 驻</option>';
                    const employees = users.filter(u => u.role === 'employee');
                    employees.forEach(emp => {
                        const option = document.createElement('option');
                        option.value = emp.id;
                        option.textContent = emp.fullName;
                        select.appendChild(option);
                    });
                }
            });
        }

        // 爪专转 砖 - 砖转祝
        document.getElementById('partnerTaskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            createPartnerTask();
        });

        function createPartnerTask() {
            const title = document.getElementById('partTaskTitle').value;
            const client = document.getElementById('partTaskClient').value;
            const type = document.getElementById('partTaskType').value;
            const assignee = document.getElementById('partTaskAssignee').value;
            const dueDate = document.getElementById('partTaskDueDate').value;
            const status = document.getElementById('partTaskStatus').value;
            const description = document.getElementById('partTaskDescription').value;
            
            if (!title || !client || !type || !assignee || !dueDate) {
                showMessage('partnerDashboardTab', '  转  砖转 专砖', 'error');
                return;
            }

            const task = {
                id: Date.now(),
                title,
                client,
                type,
                dueDate,
                description,
                status: status || 'not-started',
                assignedTo: parseInt(assignee),
                createdBy: currentUser.id,
                createdDate: new Date().toISOString(),
                lastModified: new Date().toISOString(),
                comments: []
            };

            tasks.push(task);
            addNotification(`砖转祝 ${currentUser.fullName} 爪专 砖 砖: ${title}`, 'partner-task', task.id, parseInt(assignee));
            clearPartnerForm();
            showMessage('partnerDashboardTab', '砖 爪专 爪!', 'success');
            updatePartnerStats();
            filterPartnerTasks();
            saveData();
        }

        function clearPartnerForm() {
            document.getElementById('partnerTaskForm').reset();
            setTodayDate('partTaskDueDate');
        }

        function updatePartnerStats() {
            const totalTasks = tasks.length;
            const activeTasks = tasks.filter(t => t.status !== 'completed').length;
            const overdueTasks = tasks.filter(t => 
                t.status !== 'completed' && new Date(t.dueDate) < new Date()
            ).length;
            const reviewTasks = tasks.filter(t => t.status === 'partner-review').length;
            
            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('activeTasks').textContent = activeTasks;
            document.getElementById('overdueTasks').textContent = overdueTasks;
            document.getElementById('reviewTasks').textContent = reviewTasks;
        }

        function filterPartnerTasks(quickFilter = null) {
            let filteredTasks = [...tasks];
            
            if (quickFilter) {
                switch(quickFilter) {
                    case 'active':
                        filteredTasks = filteredTasks.filter(t => t.status !== 'completed');
                        break;
                    case 'overdue':
                        filteredTasks = filteredTasks.filter(t => 
                            t.status !== 'completed' && new Date(t.dueDate) < new Date()
                        );
                        break;
                    case 'partner-review':
                        filteredTasks = filteredTasks.filter(t => t.status === 'partner-review');
                        break;
                    default:
                        break;
                }
            } else {
                const searchTerm = document.getElementById('partnerSearchTasks').value.toLowerCase();
                const employeeFilter = document.getElementById('partnerFilterEmployee').value;
                const statusFilter = document.getElementById('partnerFilterStatus').value;
                const typeFilter = document.getElementById('partnerFilterType').value;
                const sortBy = document.getElementById('partnerSortTasks').value;
                
                if (searchTerm) {
                    filteredTasks = filteredTasks.filter(task => 
                        task.title.toLowerCase().includes(searchTerm) ||
                        task.client.toLowerCase().includes(searchTerm) ||
                        task.description.toLowerCase().includes(searchTerm)
                    );
                }
                
                if (employeeFilter) {
                    filteredTasks = filteredTasks.filter(task => task.assignedTo == employeeFilter);
                }
                
                if (statusFilter) {
                    filteredTasks = filteredTasks.filter(task => task.status === statusFilter);
                }
                
                if (typeFilter) {
                    filteredTasks = filteredTasks.filter(task => task.type === typeFilter);
                }
                
                sortTasks(filteredTasks, sortBy);
            }
            
            displayTasks(filteredTasks, 'partnerTasksList', 'partner');
        }

        function displayTasks(tasksToDisplay, containerId, userType) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (tasksToDisplay.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 40px;"> 砖转 爪</p>';
                return;
            }
            
            tasksToDisplay.forEach(task => {
                const taskElement = createTaskElement(task, userType);
                container.appendChild(taskElement);
            });
        }

        // 驻拽爪转 砖转 转拽转
        function updateTaskStatus(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const statuses = [
                { value: 'not-started', text: '专 转' },
                { value: 'in-progress', text: '注' },
                { value: 'waiting-client', text: ' 转 拽' },
                { value: 'partner-review', text: '注专 拽转 砖转祝' },
                { value: 'completed', text: '住转' }
            ];
            
            const newStatus = prompt(`专 住住 砖 注专: ${task.title}\n\n` + 
                statuses.map((s, i) => `${i + 1}. ${s.text}`).join('\n') + 
                `\n\n住住 : ${convertFromValue(task.status)}\n\n 住驻专 (1-5):`);
            
            if (newStatus && newStatus >= 1 && newStatus <= 5) {
                const selectedStatus = statuses[newStatus - 1];
                task.status = selectedStatus.value;
                task.lastModified = new Date().toISOString();
                
                if (!task.comments) task.comments = [];
                task.comments.push({
                    id: Date.now(),
                    author: currentUser.fullName,
                    authorId: currentUser.id,
                    content: `住住 注 : ${selectedStatus.text}`,
                    date: new Date().toISOString(),
                    isRead: false
                });
                
                if (currentUser.role === 'employee') {
                    addNotification(`注 ${currentUser.fullName} 注 住住 砖: ${task.title}`, 'status-update', taskId);
                }
                
                filterEmployeeTasks();
                saveData();
                showMessage('employeeMyTasksTab', '住住 注 爪', 'success');
            }
        }

        function addTaskComment(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const comment = prompt(`住祝 注专 砖: ${task.title}`);
            if (!comment || comment.trim() === '') return;
            
            if (!task.comments) task.comments = [];
            
            const newComment = {
                id: Date.now(),
                author: currentUser.fullName,
                authorId: currentUser.id,
                content: comment.trim(),
                date: new Date().toISOString(),
                isRead: false
            };
            
            task.comments.push(newComment);
            task.lastModified = new Date().toISOString();
            
            if (currentUser.role === 'employee') {
                addNotification(`注专 砖 砖: ${task.title}`, 'new-comment', taskId);
            } else {
                const assignedUser = users.find(u => u.id === task.assignedTo);
                if (assignedUser) {
                    addNotification(`砖转祝  注 砖: ${task.title}`, 'partner-reply', taskId, task.assignedTo);
                }
            }
            
            if (currentUser.role === 'employee') {
                filterEmployeeTasks();
            } else {
                filterPartnerTasks();
            }
            
            saveData();
            showMessage(currentUser.role === 'employee' ? 'employeeMyTasksTab' : 'partnerDashboardTab', '注专 住驻 爪', 'success');
        }

        function markCommentAsRead(taskId, commentId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task || !task.comments) return;
            
            const comment = task.comments.find(c => c.id === commentId);
            if (comment) {
                comment.isRead = true;
                task.lastModified = new Date().toISOString();
                
                filterPartnerTasks();
                saveData();
                
                notifications = notifications.filter(n => !(n.type === 'new-comment' && n.taskId === taskId));
                updateNotifications();
            }
        }

        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            currentEditTaskId = taskId;
            
            document.getElementById('editTaskTitle').value = task.title;
            document.getElementById('editTaskStatus').value = task.status;
            document.getElementById('editTaskClient').value = task.client;
            document.getElementById('editTaskDueDate').value = task.dueDate.split('T')[0];
            document.getElementById('editTaskType').value = task.type;
            document.getElementById('editTaskDescription').value = task.description || '';
            
            updateFormOptions();
            showModal('editTaskModal');
        }

        document.getElementById('editTaskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const task = tasks.find(t => t.id === currentEditTaskId);
            if (!task) return;
            
            task.title = document.getElementById('editTaskTitle').value;
            task.status = document.getElementById('editTaskStatus').value;
            task.client = document.getElementById('editTaskClient').value;
            task.dueDate = document.getElementById('editTaskDueDate').value;
            task.type = document.getElementById('editTaskType').value;
            task.description = document.getElementById('editTaskDescription').value;
            task.lastModified = new Date().toISOString();
            
            hideModal('editTaskModal');
            filterPartnerTasks();
            updatePartnerStats();
            saveData();
            
            showMessage('partnerDashboardTab', '砖 注 爪', 'success');
        });

        function deleteTask(taskId) {
            if (!confirm(' 转  砖专爪 拽 转 砖?')) return;
            
            tasks = tasks.filter(t => t.id !== taskId);
            notifications = notifications.filter(n => n.taskId !== taskId);
            
            filterPartnerTasks();
            updatePartnerStats();
            updateNotifications();
            saveData();
            
            showMessage('partnerDashboardTab', '砖 拽 爪', 'success');
        }
        // 驻拽爪转 专转 砖转祝
        function showSettingsTab(tabName) {
            document.querySelectorAll('.settings-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            document.querySelectorAll('#partnerSettingsTab .nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(`settings${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`).classList.remove('hidden');
            event.target.classList.add('active');
            
            if (tabName === 'users') {
                loadUsers();
            }
        }

        function loadPartnerSettings() {
            loadUsers();
            showSettingsTab('users');
        }

        //  砖转砖
        function loadUsers() {
            const container = document.getElementById('usersList');
            container.innerHTML = '';
            
            if (users.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d;"> 砖转砖</p>';
                return;
            }
            
            users.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'task-item';
                userDiv.innerHTML = `
                    <div class="task-header">
                        <div class="task-title">${user.fullName}</div>
                        <div class="task-status ${user.role === 'partner' ? 'status-completed' : 'status-in-progress'}">
                            ${user.role === 'partner' ? '砖转祝' : '注'}
                        </div>
                    </div>
                    <div class="task-details-grid">
                        <div><strong>砖 砖转砖:</strong> ${user.username}</div>
                        <div><strong>:</strong> ${user.email || ' 专'}</div>
                        <div><strong>拽 砖:</strong> ${'*'.repeat(user.code.length)}</div>
                    </div>
                    <div class="task-actions">
                        <button class="btn" onclick="editUser(${user.id})">注专</button>
                        <button class="btn btn-secondary" onclick="resetUserCode(${user.id})">驻住 拽</button>
                        ${user.id !== currentUser.id ? `<button class="btn btn-danger" onclick="deleteUser(${user.id})">拽</button>` : ''}
                    </div>
                `;
                container.appendChild(userDiv);
            });
        }

        document.getElementById('userForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveUser();
        });

        function saveUser() {
            const fullName = document.getElementById('userFullName').value;
            const username = document.getElementById('userUsername').value;
            const role = document.getElementById('userRole').value;
            const email = document.getElementById('userEmail').value;
            const code = document.getElementById('userCode').value;
            
            if (!fullName || !username || !role || !code) {
                showMessage('userModal', '  转  砖转 专砖', 'error');
                return;
            }
            
            if (users.some(u => u.username === username && u.id !== currentEditUserId)) {
                showMessage('userModal', '砖 砖转砖 专 拽', 'error');
                return;
            }
            
            const user = {
                id: currentEditUserId || Date.now(),
                fullName,
                username,
                role,
                email,
                code
            };
            
            if (currentEditUserId) {
                const index = users.findIndex(u => u.id === currentEditUserId);
                users[index] = user;
            } else {
                users.push(user);
            }
            
            hideModal('userModal');
            loadUsers();
            loadPartnerEmployeeOptions();
            saveData();
            showMessage('settingsUsersTab', '砖转砖 砖专 爪', 'success');
        }

        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            currentEditUserId = userId;
            
            document.getElementById('userFullName').value = user.fullName;
            document.getElementById('userUsername').value = user.username;
            document.getElementById('userRole').value = user.role;
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userCode').value = user.code;
            
            document.getElementById('userModalTitle').textContent = '注专转 砖转砖';
            showModal('userModal');
        }

        function deleteUser(userId) {
            if (!confirm(' 转  砖专爪 拽 转 砖转砖?')) return;
            
            const userTasks = tasks.filter(t => t.assignedTo === userId || t.createdBy === userId);
            if (userTasks.length > 0) {
                alert(' 转 拽 砖转砖 砖砖  砖转 拽砖专转');
                return;
            }
            
            users = users.filter(u => u.id !== userId);
            loadUsers();
            loadPartnerEmployeeOptions();
            saveData();
            showMessage('settingsUsersTab', '砖转砖 拽 爪', 'success');
        }

        function resetUserCode(userId) {
            const newCode = prompt(' 拽 砖 砖:');
            if (!newCode) return;
            
            const user = users.find(u => u.id === userId);
            if (user) {
                user.code = newCode;
                loadUsers();
                saveData();
                showMessage('settingsUsersTab', '拽 注 爪', 'success');
            }
        }

        // 专转 注专转
        function updateWorkTypes() {
            const types = document.getElementById('workTypes').value.split('\n').filter(t => t.trim());
            workTypes = types;
            updateFormOptions();
            saveData();
            showMessage('settingsSystemTab', '住 注 注 爪', 'success');
        }

        function updateWorkStatuses() {
            const statuses = document.getElementById('workStatuses').value.split('\n').filter(s => s.trim());
            workStatuses = statuses;
            updateFormOptions();
            saveData();
            showMessage('settingsSystemTab', '住住 注 爪', 'success');
        }

        //  转
        function updateClientsUrl() {
            const url = document.getElementById('clientsSheetUrl').value;
            localStorage.setItem('clientsSheetUrl', url);
            showMessage('settingsDataTab', '拽砖专 拽转 注 爪', 'success');
        }

        function updateBackupUrl() {
            const url = document.getElementById('backupSheetUrl').value;
            localStorage.setItem('backupSheetUrl', url);
            showMessage('settingsDataTab', '拽砖专  注 爪', 'success');
        }

        // 住专 注 Google Sheets ()
        function syncClients() {
            showMessage('settingsDataTab', '住专 拽转...', 'success');
            
            //  砖 拽专 -Google Sheets
            const newClients = [
                { id: clients.length + 1, name: '拽 住专 1', contact: '砖 拽砖专 1', phone: '050-1111111' },
                { id: clients.length + 2, name: '拽 住专 2', contact: '砖 拽砖专 2', phone: '050-2222222' }
            ];
            
            clients.push(...newClients);
            saveData();
            showMessage('settingsDataTab', `${newClients.length} 拽转 砖 住驻`, 'success');
        }

        function saveToSheets() {
            showMessage('settingsDataTab', '砖专 Google Sheets...', 'success');
            //   拽 砖专 转转 -Google Sheets
            saveData();
            showMessage('settingsDataTab', '转 砖专 爪', 'success');
        }

        function setupAutoSync() {
            autoSyncEnabled = true;
            saveData();
            showMessage('settingsDataTab', '住专 砖注 驻注', 'success');
        }

        function disableAutoSync() {
            autoSyncEnabled = false;
            saveData();
            showMessage('settingsDataTab', '住专  ', 'success');
        }

        // 爪 
        function exportToExcel() {
            let csvContent = ',转专转,拽,住 注,住住,转专 注,注 驻,爪专 注 ,转专 爪专,转专\n';
            
            tasks.forEach(task => {
                const assignedUser = users.find(u => u.id === task.assignedTo);
                const createdUser = users.find(u => u.id === task.createdBy);
                
                csvContent += [
                    task.id,
                    `"${task.title}"`,
                    `"${task.client}"`,
                    `"${convertFromValue(task.type)}"`,
                    `"${convertFromValue(task.status)}"`,
                    formatDate(task.dueDate),
                    `"${assignedUser ? assignedUser.fullName : ''}"`,
                    `"${createdUser ? createdUser.fullName : ''}"`,
                    formatDate(task.createdDate),
                    `"${task.description || ''}"`
                ].join(',') + '\n';
            });
            
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `砖转_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showMessage('settingsDataTab', '拽抓 爪 爪', 'success');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    if (file.name.endsWith('.json')) {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.users) users = data.users;
                        if (data.tasks) tasks = data.tasks;
                        if (data.clients) clients = data.clients;
                        if (data.notifications) notifications = data.notifications;
                        if (data.workTypes) workTypes = data.workTypes;
                        if (data.workStatuses) workStatuses = data.workStatuses;
                        
                        updateFormOptions();
                        
                        if (currentUser.role === 'partner') {
                            loadUsers();
                            updatePartnerStats();
                            filterPartnerTasks();
                        } else {
                            filterEmployeeTasks();
                        }
                        
                        updateNotifications();
                        saveData();
                        
                        showMessage('settingsDataTab', '转  爪', 'success');
                    }
                } catch (error) {
                    console.error('砖 :', error);
                    showMessage('settingsDataTab', '砖  转', 'error');
                }
            };
            
            reader.readAsText(file);
        }

        // 注专转 转专转
        function addNotification(message, type, taskId, targetUserId = null) {
            const notification = {
                id: Date.now(),
                message,
                type,
                taskId,
                targetUserId,
                date: new Date().toISOString(),
                isRead: false
            };
            
            notifications.push(notification);
            updateNotifications();
            saveData();
        }

        function updateNotifications() {
            const userNotifications = notifications.filter(n => {
                if (currentUser.role === 'partner') {
                    return !n.targetUserId || n.targetUserId === currentUser.id;
                } else {
                    return n.targetUserId === currentUser.id;
                }
            });
            
            const unreadCount = userNotifications.filter(n => !n.isRead).length;
            const countElement = document.getElementById('notificationCount');
            
            if (unreadCount > 0) {
                countElement.textContent = unreadCount;
                countElement.classList.remove('hidden');
            } else {
                countElement.classList.add('hidden');
            }
            
            const listElement = document.getElementById('notificationList');
            listElement.innerHTML = '';
            
            if (userNotifications.length === 0) {
                listElement.innerHTML = '<div style="padding: 20px; text-align: center; color: #7f8c8d;"> 转专转</div>';
                return;
            }
            
            userNotifications.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            userNotifications.forEach(notification => {
                const notifElement = document.createElement('div');
                notifElement.className = `notification-item ${!notification.isRead ? 'unread' : ''}`;
                notifElement.innerHTML = `
                    <div style="font-weight: ${!notification.isRead ? 'bold' : 'normal'};">
                        ${notification.message}
                    </div>
                    <div style="font-size: 0.8em; color: #7f8c8d; margin-top: 5px;">
                        ${formatDateTime(notification.date)}
                    </div>
                `;
                
                notifElement.onclick = () => {
                    notification.isRead = true;
                    updateNotifications();
                    saveData();
                    
                    if (notification.taskId) {
                        if (currentUser.role === 'employee') {
                            showEmployeeTab('my-tasks');
                        } else {
                            showPartnerTab('dashboard');
                        }
                    }
                    
                    toggleNotifications();
                };
                
                listElement.appendChild(notifElement);
            });
        }

        function toggleNotifications() {
            const panel = document.getElementById('notificationPanel');
            panel.classList.toggle('hidden');
        }

        function markAllAsRead() {
            notifications.forEach(n => {
                if (currentUser.role === 'partner' || n.targetUserId === currentUser.id) {
                    n.isRead = true;
                }
            });
            updateNotifications();
            saveData();
        }

        // 砖专 注
        function saveData() {
            const data = {
                users,
                tasks,
                clients,
                notifications,
                workTypes,
                workStatuses,
                autoSyncEnabled,
                lastSaved: new Date().toISOString()
            };
            
            localStorage.setItem('rmcpa-data', JSON.stringify(data));
        }

        function loadData() {
            const savedData = localStorage.getItem('rmcpa-data');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    
                    if (data.users) users = data.users;
                    if (data.tasks) tasks = data.tasks;
                    if (data.clients) clients = data.clients;
                    if (data.notifications) notifications = data.notifications;
                    if (data.workTypes) workTypes = data.workTypes;
                    if (data.workStatuses) workStatuses = data.workStatuses;
                    if (data.autoSyncEnabled !== undefined) autoSyncEnabled = data.autoSyncEnabled;
                    
                    console.log('转 注  拽');
                    return true;
                } catch (error) {
                    console.error('砖 注转 转:', error);
                }
            }
            return false;
        }

        function checkRememberMe() {
            const remembered = localStorage.getItem('rmcpa-remember');
            if (remembered) {
                try {
                    const data = JSON.parse(remembered);
                    document.getElementById('loginUsername').value = data.username;
                    document.getElementById('loginCode').value = data.code;
                    document.getElementById('rememberMe').checked = true;
                    
                    const user = users.find(u => u.username === data.username && u.code === data.code);
                    if (user) {
                        currentUser = user;
                        showMainApp();
                        return true;
                    }
                } catch (error) {
                    console.error('砖 注转 驻专 转专转:', error);
                    localStorage.removeItem('rmcpa-remember');
                }
            }
            return false;
        }

        // Event listeners
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.autocomplete-container')) {
                document.querySelectorAll('.autocomplete-list').forEach(list => {
                    list.classList.add('hidden');
                });
            }
            
            if (!e.target.closest('.notification-bell') && !e.target.closest('.notification-panel')) {
                document.getElementById('notificationPanel').classList.add('hidden');
            }
            
            if (e.target.classList.contains('modal')) {
                e.target.classList.add('hidden');
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal:not(.hidden)').forEach(modal => {
                    modal.classList.add('hidden');
                });
                document.getElementById('notificationPanel').classList.add('hidden');
            }
        });

        // 转 注专转
        window.onload = function() {
            // 注转 转 砖专
            if (!loadData()) {
                initializeData();
            }
            
            // 注转 URLs 砖专
            const savedClientsUrl = localStorage.getItem('clientsSheetUrl');
            if (savedClientsUrl) {
                document.getElementById('clientsSheetUrl').value = savedClientsUrl;
            }
            
            const savedBackupUrl = localStorage.getItem('backupSheetUrl');
            if (savedBackupUrl) {
                document.getElementById('backupSheetUrl').value = savedBackupUrl;
            }
            
            // 拽转 "专 转"
            if (!checkRememberMe()) {
                document.getElementById('authScreen').classList.remove('hidden');
            }
        };

        // 砖专 转  30 砖转
        setInterval(() => {
            if (currentUser) {
                saveData();
            }
        }, 30000);

        // 砖专 驻 住专转 
        window.addEventListener('beforeunload', function() {
            if (currentUser) {
                saveData();
            }
        });
    </script>
</body>
</html>
