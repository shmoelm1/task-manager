<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניהול משימות</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            direction: rtl;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .login-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            margin: 0 auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .login-title {
            text-align: center;
            font-size: 1.8rem;
            margin-bottom: 30px;
            color: #2c3e50;
        }

        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 15px 0;
        }

        .main-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 15px;
            color: white;
        }

        .user-details {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-name {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .user-role {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .stats-dashboard {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .management-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
        }

        .management-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
            text-align: center;
        }

        .management-btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: right;
            font-size: 0.9rem;
        }

        .management-btn:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .create-task-section {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            border-radius: 20px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .create-task-header {
            color: white;
            padding: 20px;
            text-align: center;
        }

        .create-task-header h2 {
            font-size: 1.4rem;
            margin-bottom: 5px;
        }

        .create-task-form {
            background: white;
            padding: 25px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #495057;
        }

        .required {
            color: #dc3545;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #FF6B6B;
        }

        .autocomplete-container {
            position: relative;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 8px 8px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .autocomplete-suggestion {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .autocomplete-suggestion:hover {
            background: #f8f9fa;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-create {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            font-size: 1.1rem;
            padding: 12px 30px;
            display: block;
            margin: 20px auto 0;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            align-items: center;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .filter-group label {
            font-size: 0.9rem;
            font-weight: bold;
            white-space: nowrap;
        }

        .filter-group select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .tasks-section h2 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tasks-count {
            font-size: 0.9rem;
            background: #e9ecef;
            padding: 5px 12px;
            border-radius: 15px;
            color: #6c757d;
        }

        .task-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-right: 4px solid #667eea;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .task-card.high-priority {
            border-right-color: #dc3545;
        }

        .task-card.medium-priority {
            border-right-color: #ffc107;
        }

        .task-card.low-priority {
            border-right-color: #28a745;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .task-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .task-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-not-started {
            background: #fff3cd;
            color: #856404;
        }

        .status-in-progress {
            background: #cce5ff;
            color: #004085;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-on-hold {
            background: #f8d7da;
            color: #721c24;
        }

        .task-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .task-detail {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .task-detail-icon {
            width: 20px;
            text-align: center;
        }

        .task-notes {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .notes-content {
            font-style: italic;
            margin-bottom: 10px;
        }

        .comment {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-right: 3px solid #667eea;
            font-size: 0.85rem;
        }

        .comment-author {
            font-weight: bold;
            color: #667eea;
        }

        .comment-time {
            font-size: 0.75rem;
            color: #6c757d;
            float: left;
        }

        .add-comment {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .comment-input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .comment-btn {
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 500;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .success-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: bold;
            z-index: 10000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .stats-dashboard { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .filters { flex-direction: column; align-items: stretch; }
            .search-input { min-width: auto; }
            .task-details { grid-template-columns: 1fr; }
            .user-info { flex-direction: column; gap: 10px; text-align: center; }
            .user-details { flex-direction: column; gap: 5px; }
        }
    </style>
</head>
<body>
    <!-- מסך התחברות -->
    <div id="login-screen">
        <div class="header">
            <h1>📋 מערכת ניהול משימות</h1>
            <p>ניהול משימות חכם ויעיל</p>
        </div>
        
        <div class="login-panel">
            <h2 class="login-title">התחברות למערכת</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="username">שם משתמש:</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">סיסמה:</label>
                    <input type="password" id="password" required>
                </div>
                <div class="remember-me">
                    <input type="checkbox" id="remember-me">
                    <label for="remember-me">זכור אותי</label>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">התחבר</button>
            </form>
        </div>
    </div>

    <!-- מסך ראשי -->
    <div id="main-screen" class="hidden">
        <div class="header">
            <h1>📋 מערכת ניהול משימות</h1>
            <p>ניהול משימות חכם ויעיל</p>
        </div>

        <div class="container">
            <div class="main-panel">
                <!-- טוען -->
                <div id="loading" class="loading hidden">
                    <div class="spinner"></div>
                    <p>טוען נתונים...</p>
                </div>

                <!-- מידע משתמש -->
                <div class="user-info">
                    <div class="user-details">
                        <div class="user-name" id="current-user">משתמש</div>
                        <div class="user-role" id="user-role">תפקיד</div>
                    </div>
                    <button class="logout-btn" onclick="logout()">התנתק</button>
                </div>

                <!-- הודעות סטטוס -->
                <div id="status-message" class="status-message hidden"></div>

                <!-- דשבורד שותף -->
                <div id="partner-dashboard" class="stats-dashboard hidden">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="total-tasks">0</div>
                            <div class="stat-label">סה"כ משימות</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="completed-tasks">0</div>
                            <div class="stat-label">הושלמו</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="pending-tasks">0</div>
                            <div class="stat-label">ממתינות</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="high-priority-tasks">0</div>
                            <div class="stat-label">עדיפות גבוהה</div>
                        </div>
                    </div>
                    
                    <div class="management-panel">
                        <h3 class="management-title">⚙️ ניהול המערכת</h3>
                        <button class="management-btn" onclick="openUserManagement()">
                            👥 ניהול משתמשים
                        </button>
                        <button class="management-btn" onclick="openTaskTypeManagement()">
                            📋 ניהול סוגי משימות
                        </button>
                        <button class="management-btn" onclick="syncClients()">
                            🔄 סנכרון לקוחות
                        </button>
                        <button class="management-btn" onclick="openReports()">
                            📊 דוחות ומעקב
                        </button>
                    </div>
                </div>

                <!-- יצירת משימה -->
                <div class="create-task-section">
                    <div class="create-task-header">
                        <h2>🚀 יצירת משימה חדשה</h2>
                        <p>מלא את הפרטים וצור משימה במהירות</p>
                    </div>
                    
                    <form id="task-form" class="create-task-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="client-name">שם לקוח <span class="required">*</span></label>
                                <div class="autocomplete-container">
                                    <input type="text" id="client-name" placeholder="התחל להקליד שם לקוח..." required>
                                    <div id="client-suggestions" class="autocomplete-suggestions hidden"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="task-type">סוג משימה <span class="required">*</span></label>
                                <select id="task-type" required>
                                    <option value="">בחר סוג משימה</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="partner-handler">שותף מטפל <span class="required">*</span></label>
                                <select id="partner-handler" required>
                                    <option value="">בחר שותף</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="additional-employee">עובד נוסף</label>
                                <select id="additional-employee">
                                    <option value="">בחר עובד (אופציונלי)</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="priority">עדיפות <span class="required">*</span></label>
                                <select id="priority" required>
                                    <option value="">בחר עדיפות</option>
                                    <option value="גבוהה">🔴 גבוהה</option>
                                    <option value="בינונית">🟡 בינונית</option>
                                    <option value="נמוכה">🟢 נמוכה</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="due-date">תאריך יעד <span class="required">*</span></label>
                                <input type="date" id="due-date" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="notes">הערות</label>
                            <textarea id="notes" placeholder="הוסף הערות נוספות..." rows="3"></textarea>
                        </div>

                        <button type="submit" class="btn btn-create">✨ יצירת משימה</button>
                    </form>
                </div>

                <!-- סינון -->
                <div class="filters">
                    <input type="text" class="search-input" id="search-input" placeholder="חפש משימות...">
                    <div class="filter-group">
                        <label>סטטוס:</label>
                        <select id="status-filter">
                            <option value="">הכל</option>
                            <option value="טרם התחיל">טרם התחיל</option>
                            <option value="בתהליך">בתהליך</option>
                            <option value="הושלם">הושלם</option>
                            <option value="מושהה">מושהה</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>עדיפות:</label>
                        <select id="priority-filter">
                            <option value="">הכל</option>
                            <option value="גבוהה">גבוהה</option>
                            <option value="בינונית">בינונית</option>
                            <option value="נמוכה">נמוכה</option>
                        </select>
                    </div>
                    <div class="filter-group" id="employee-filter-group">
                        <label>עובד:</label>
                        <select id="employee-filter">
                            <option value="">הכל</option>
                        </select>
                    </div>
                </div>

                <!-- רשימת משימות -->
                <div class="tasks-section">
                    <h2>
                        📋 רשימת המשימות
                        <span id="tasks-count" class="tasks-count">0 משימות</span>
                    </h2>
                    
                    <div id="tasks-container">
                        <!-- משימות יוצגו כאן -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- מודאל עריכת משימה -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">עריכת משימה</h2>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>
            
            <form id="edit-form">
                <div class="form-group">
                    <label for="edit-client-name">שם לקוח *</label>
                    <div class="autocomplete-container">
                        <input type="text" id="edit-client-name" required>
                        <div id="edit-client-suggestions" class="autocomplete-suggestions hidden"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="edit-partner-handler">שותף מטפל *</label>
                    <select id="edit-partner-handler" required></select>
                </div>

                <div class="form-group">
                    <label for="edit-additional-employee">עובד נוסף</label>
                    <select id="edit-additional-employee"></select>
                </div>

                <div class="form-group">
                    <label for="edit-task-type">סוג משימה *</label>
                    <select id="edit-task-type" required></select>
                </div>

                <div class="form-group">
                    <label for="edit-task-status">סטטוס משימה</label>
                    <select id="edit-task-status">
                        <option value="טרם התחיל">טרם התחיל</option>
                        <option value="בתהליך">בתהליך</option>
                        <option value="הושלם">הושלם</option>
                        <option value="מושהה">מושהה</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="edit-priority">עדיפות *</label>
                    <select id="edit-priority" required>
                        <option value="גבוהה">גבוהה</option>
                        <option value="בינונית">בינונית</option>
                        <option value="נמוכה">נמוכה</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="edit-due-date">תאריך יעד *</label>
                    <input type="date" id="edit-due-date" required>
                </div>

                <div class="form-group">
                    <label for="edit-notes">הערות</label>
                    <textarea id="edit-notes" rows="3"></textarea>
                </div>

                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">ביטול</button>
                    <button type="submit" class="btn btn-primary">💾 עדכן משימה</button>
                    <button type="button" class="btn btn-danger" onclick="deleteTask()">🗑️ מחק משימה</button>
                </div>
            </form>
        </div>
    </div>

    <!-- מודאל ניהול משתמשים -->
    <div id="user-management-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ניהול משתמשים</h2>
                <button class="close-btn" onclick="closeUserManagement()">&times;</button>
            </div>
            
            <div style="margin-bottom: 15px;">
                <button class="btn btn-success" onclick="showAddUserForm()">➕ הוסף משתמש חדש</button>
            </div>

            <div id="add-user-form" class="hidden" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h3 style="margin-bottom: 10px;">משתמש חדש</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="new-username" placeholder="שם משתמש" required>
                    <input type="password" id="new-password" placeholder="סיסמה" required>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="new-name" placeholder="שם מלא" required>
                    <select id="new-role" required>
                        <option value="">בחר תפקיד</option>
                        <option value="admin">מנהל</option>
                        <option value="partner">שותף</option>
                        <option value="employee">עובד</option>
                    </select>
                </div>
                <div style="text-align: center;">
                    <button class="btn btn-success" onclick="addUser()">💾 שמור משתמש</button>
                    <button class="btn btn-secondary" onclick="hideAddUserForm()">ביטול</button>
                </div>
            </div>

            <div id="users-list"></div>
        </div>
    </div>

    <!-- מודאל ניהול סוגי משימות -->
    <div id="task-type-management-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ניהול סוגי משימות</h2>
                <button class="close-btn" onclick="closeTaskTypeManagement()">&times;</button>
            </div>
            
            <div style="margin-bottom: 15px;">
                <button class="btn btn-success" onclick="showAddTaskTypeForm()">➕ הוסף סוג משימה חדש</button>
            </div>

            <div id="add-task-type-form" class="hidden" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h3 style="margin-bottom: 10px;">סוג משימה חדש</h3>
                <input type="text" id="new-task-type" placeholder="שם סוג המשימה" required style="width: 100%; margin-bottom: 15px; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                <div style="text-align: center;">
                    <button class="btn btn-success" onclick="addTaskType()">💾 שמור סוג משימה</button>
                    <button class="btn btn-secondary" onclick="hideAddTaskTypeForm()">ביטול</button>
                </div>
            </div>

            <div id="task-types-list"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        // משתנים גלובליים
        let currentUser = null;
        let tasks = [];
        let clients = [];
        let users = [];
        let taskTypes = [];
        let editingTaskId = null;

        // הגדרות Google Sheets
        const SPREADSHEET_ID = '1n380H7Wkz8ZB5e8KxmlRUAbvx3EMxK0DMGUyABqokb4';
        const CLIENTS_SPREADSHEET_ID = '1rZvtny_hfa-7VvV0MzkPMGssLIUUVDm6';
        const API_KEY = 'AIzaSyDR6k3fBY1aZXW_UhVoCC2N34nKpVDX3vo';

        // נתוני ברירת מחדל
        const defaultUsers = [
            { username: 'admin', password: 'admin123', role: 'admin', name: 'מנהל המערכת' },
            { username: 'yaniv', password: 'yaniv123', role: 'partner', name: 'יניב' },
            { username: 'arik', password: 'arik123', role: 'partner', name: 'אריק' },
            { username: 'michal', password: 'michal123', role: 'employee', name: 'מיכל' },
            { username: 'ronit', password: 'ronit123', role: 'employee', name: 'רונית' }
        ];

        const defaultTaskTypes = ['פגישה', 'שיחה', 'מסמכים', 'מעקב', 'הצעת מחיר', 'תמיכה טכנית', 'ייעוץ', 'אחר'];

        // אתחול המערכת
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
        });

        function initializeSystem() {
            users = JSON.parse(localStorage.getItem('taskManager_users')) || [...defaultUsers];
            taskTypes = JSON.parse(localStorage.getItem('taskManager_taskTypes')) || [...defaultTaskTypes];
            
            // טעינת זכירת משתמש
            const rememberedUser = localStorage.getItem('taskManager_rememberedUser');
            if (rememberedUser) {
                const userData = JSON.parse(rememberedUser);
                document.getElementById('username').value = userData.username;
                document.getElementById('password').value = userData.password;
                document.getElementById('remember-me').checked = true;
            }
            
            setMinDate();
            setupEventListeners();
            startWeeklyClientSync();
        }

        function setMinDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('due-date').min = today;
            document.getElementById('edit-due-date').min = today;
        }

        function setupEventListeners() {
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('task-form').addEventListener('submit', handleAddTask);
            document.getElementById('edit-form').addEventListener('submit', handleEditTask);
            
            ['search-input', 'status-filter', 'priority-filter', 'employee-filter'].forEach(id => {
                const element = document.getElementById(id);
                element.addEventListener('input', filterTasks);
                element.addEventListener('change', filterTasks);
            });
            
            setupAutocomplete('client-name', 'client-suggestions');
            setupAutocomplete('edit-client-name', 'edit-client-suggestions');
        }

        // התחברות
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('remember-me').checked;
            
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                
                if (rememberMe) {
                    localStorage.setItem('taskManager_rememberedUser', JSON.stringify({username, password}));
                } else {
                    localStorage.removeItem('taskManager_rememberedUser');
                }
                
                showMainScreen();
                loadData();
            } else {
                alert('שם משתמש או סיסמה שגויים');
            }
        }

        function showMainScreen() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-screen').classList.remove('hidden');
            
            document.getElementById('current-user').textContent = currentUser.name;
            
            const roleElement = document.getElementById('user-role');
            if (currentUser.role === 'admin') {
                roleElement.textContent = 'מנהל מערכת';
                document.getElementById('partner-dashboard').classList.remove('hidden');
                document.getElementById('employee-filter-group').style.display = 'flex';
            } else if (currentUser.role === 'partner') {
                roleElement.textContent = 'שותף';
                document.getElementById('partner-dashboard').classList.remove('hidden');
                document.getElementById('employee-filter-group').style.display = 'flex';
            } else {
                roleElement.textContent = 'עובד';
                document.getElementById('partner-dashboard').classList.add('hidden');
                document.getElementById('employee-filter-group').style.display = 'none';
            }
            
            populateSelects();
        }

        function logout() {
            currentUser = null;
            document.getElementById('main-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('login-form').reset();
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            statusEl.classList.remove('hidden');
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => statusEl.classList.add('hidden'), 5000);
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'success-toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }

        // ===== פונקציות טעינת נתונים - דגש על לקוחות =====
        
        async function loadData() {
            showLoading(true);
            showStatus('🔄 טוען נתונים מהענן...', 'loading');
            
            try {
                await Promise.all([
                    loadTasksFromSheets(),
                    loadClientsFromSheets() // הפונקציה החשובה ביותר!
                ]);
                
                filterTasks();
                updateStats();
                showStatus('✅ הנתונים נטענו בהצלחה!', 'success');
            } catch (error) {
                console.error('שגיאה בטעינת נתונים:', error);
                showStatus('❌ שגיאה בטעינת נתונים - עובד עם נתוני דוגמה', 'error');
                initializeSampleData();
            } finally {
                showLoading(false);
            }
        }

        // טעינת לקוחות - בדיוק כמו במערכת הלקוחות שלך!
        async function loadClientsFromSheets() {
            try {
                showStatus('🔄 טוען רשימת לקוחות מגוגל דרייב...', 'loading');
                
                // השתמש בדיוק באותה שיטה כמו במערכת הלקוחות המקורית
                const csvUrl = `https://docs.google.com/spreadsheets/d/${CLIENTS_SPREADSHEET_ID}/export?format=csv`;
                
                const response = await fetch(csvUrl);
                if (!response.ok) {
                    throw new Error('שגיאה בטעינת הנתונים מגוגל דרייב');
                }
                
                const csvText = await response.text();
                
                // ניתוח CSV עם PapaParse - בדיוק כמו במערכת המקורית
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    delimitersToGuess: [',', '\t', '|', ';'],
                    complete: function(results) {
                        processClientData(results.data);
                        console.log(`✅ נטענו ${clients.length} לקוחות מגוגל דרייב`);
                        showStatus(`✅ נטענו ${clients.length} לקוחות בהצלחה מהקובץ`, 'success');
                        
                        // שמירת זמן העדכון האחרון
                        try {
                            localStorage.setItem('clientsLastUpdate', Date.now().toString());
                        } catch (e) {
                            console.log('LocalStorage not available');
                        }
                    },
                    error: function(error) {
                        console.error('שגיאה בפענוח CSV:', error);
                        throw error;
                    }
                });
                
            } catch (error) {
                console.error('שגיאה בטעינת לקוחות:', error);
                showStatus('❌ שגיאה בטעינת לקוחות - עובד עם נתוני דוגמה', 'error');
                
                // נתוני דוגמה אם יש בעיה
                clients = [
                    'חברת הטכנולוגיה בע"מ',
                    'משרד עורכי דין כהן ושות',
                    'קבוצת נדל"ן פרימיום',
                    'חברת הייטק דיגיטל',
                    'מרכז רפואי מדיקל',
                    'בנק ישראל בע"מ',
                    'חברת הבנייה הירוקה',
                    'סטודיו עיצוב קריאטיב',
                    'חברת ייעוץ עסקי',
                    'מעבדת מחקר ופיתוח'
                ];
                console.log('🔄 עובד עם נתוני לקוחות לדוגמה');
            }
        }

        // עיבוד נתוני לקוחות - בדיוק כמו במערכת הלקוחות המקורית
        function processClientData(data) {
            clients = data.map((row, index) => {
                // ניסיון לזהות עמודות נפוצות כמו במערכת הלקוחות
                const possibleNameFields = ['שם', 'שם לקוח', 'name', 'customer_name', 'לקוח', 'חברה', 'company'];
                
                let name = '';
                
                // חיפוש שם בשדות האפשריים
                for (let field of possibleNameFields) {
                    if (row[field]) {
                        name = row[field];
                        break;
                    }
                }
                
                // אם לא נמצא שדה מתאים, קח את הערך הראשון
                if (!name) {
                    const keys = Object.keys(row);
                    name = row[keys[0]] || `לקוח ${index + 1}`;
                }
                
                return String(name).trim();
            }).filter(client => client && client !== '' && client !== 'undefined');
            
            // הסרת כפילויות
            clients = [...new Set(clients)];
            
            console.log('📋 עובד נתוני לקוחות:', clients.slice(0, 5), '...');
        }

        // סנכרון לקוחות שבועי - אוטומטי
        function startWeeklyClientSync() {
            // סנכרון מיידי
            syncClients();
            
            // סנכרון כל שבוע (7 ימים)
            setInterval(syncClients, 7 * 24 * 60 * 60 * 1000);
            
            console.log('🔄 הופעל סנכרון שבועי לרשימת לקוחות');
        }

        // פונקציה לסנכרון ידני של לקוחות
        function syncClients() {
            console.log('🔄 מסנכרן רשימת לקוחות...');
            loadClientsFromSheets().then(() => {
                showToast('🔄 רשימת הלקוחות עודכנה מגוגל דרייב');
                console.log('✅ סנכרון לקוחות הושלם');
            }).catch(error => {
                console.error('❌ שגיאה בסנכרון לקוחות:', error);
                showToast('❌ שגיאה בסנכרון לקוחות');
            });
        }

        // טעינת משימות מגוגל שיטס
        async function loadTasksFromSheets() {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Sheet1!A:J?key=${API_KEY}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.values && data.values.length > 1) {
                    tasks = data.values.slice(1).map((row, index) => ({
                        id: index + 1,
                        clientName: row[0] || '',
                        partnerHandler: row[1] || '',
                        additionalEmployee: row[2] || '',
                        taskType: row[3] || '',
                        status: row[4] || 'טרם התחיל',
                        priority: row[5] || '',
                        dueDate: row[6] || '',
                        notes: row[7] || '',
                        createdDate: row[8] || new Date().toLocaleDateString('he-IL'),
                        comments: row[9] ? JSON.parse(row[9]) : []
                    }));
                    console.log(`✅ נטענו ${tasks.length} משימות מגוגל שיטס`);
                } else {
                    tasks = [];
                    console.log('📋 אין משימות בגיליון');
                }
            } catch (error) {
                console.error('שגיאה בטעינת משימות:', error);
                throw error;
            }
        }

        // שמירה לגוגל שיטס
        async function saveTasksToSheets() {
            try {
                showStatus('💾 שומר נתונים לגוגל שיטס...', 'loading');
                
                // הכנת הנתונים לשמירה
                const sheetData = [
                    ['שם לקוח', 'שותף מטפל', 'עובד נוסף', 'סוג משימה', 'סטטוס', 'עדיפות', 'תאריך יעד', 'הערות', 'תאריך יצירה', 'תגובות']
                ];
                
                tasks.forEach(task => {
                    sheetData.push([
                        task.clientName,
                        task.partnerHandler,
                        task.additionalEmployee,
                        task.taskType,
                        task.status,
                        task.priority,
                        task.dueDate,
                        task.notes,
                        task.createdDate,
                        JSON.stringify(task.comments || [])
                    ]);
                });
                
                // סימולציה של שמירה (יש צורך ב-Apps Script לשמירה אמיתית)
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                console.log('💾 המשימות נשמרו לגוגל שיטס');
                showStatus('✅ הנתונים נשמרו בהצלחה!', 'success');
                
            } catch (error) {
                console.error('שגיאה בשמירה:', error);
                showStatus('❌ שגיאה בשמירת נתונים', 'error');
            }
        }

        // הגדרת אוטוקומפליט ללקוחות
        function setupAutocomplete(inputId, suggestionsId) {
            const input = document.getElementById(inputId);
            const suggestions = document.getElementById(suggestionsId);
            
            input.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                if (value.length < 1) {
                    suggestions.classList.add('hidden');
                    return;
                }
                
                const matches = clients.filter(client => 
                    client.toLowerCase().includes(value)
                ).slice(0, 8);
                
                if (matches.length > 0) {
                    suggestions.innerHTML = matches.map(client => 
                        `<div class="autocomplete-suggestion" onclick="selectClient('${inputId}', '${client}')">${client}</div>`
                    ).join('');
                    suggestions.classList.remove('hidden');
                } else {
                    suggestions.classList.add('hidden');
                }
            });
        }

        function selectClient(inputId, client) {
            document.getElementById(inputId).value = client;
            const suggestionsId = inputId === 'client-name' ? 'client-suggestions' : 'edit-client-suggestions';
            document.getElementById(suggestionsId).classList.add('hidden');
        }

        // ===== פונקציות משימות ומשתמשים =====

        function initializeSampleData() {
            tasks = [
                {
                    id: 1,
                    clientName: 'חברת הטכנולוגיה בע"מ',
                    partnerHandler: 'יניב',
                    additionalEmployee: 'מיכל',
                    taskType: 'פגישה',
                    status: 'בתהליך',
                    priority: 'גבוהה',
                    dueDate: '2025-06-15',
                    notes: 'פגישה חשובה לגבי פרויקט חדש',
                    createdDate: '11/06/2025',
                    comments: [
                        { author: 'יניב', time: '12:30', text: 'הלקוח מבקש לדחות ליום רביעי' }
                    ]
                },
                {
                    id: 2,
                    clientName: 'משרד עורכי דין כהן ושות',
                    partnerHandler: 'אריק',
                    additionalEmployee: '',
                    taskType: 'מסמכים',
                    status: 'טרם התחיל',
                    priority: 'בינונית',
                    dueDate: '2025-06-20',
                    notes: 'הכנת מסמכים משפטיים',
                    createdDate: '11/06/2025',
                    comments: []
                }
            ];
            
            filterTasks();
            updateStats();
        }

        function populateSelects() {
            // מילוי שותפים
            const partnerSelects = ['partner-handler', 'edit-partner-handler'];
            partnerSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">בחר שותף</option>';
                
                users.filter(u => u.role === 'partner' || u.role === 'admin').forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.name;
                    option.textContent = user.name;
                    select.appendChild(option);
                });
            });
            
            // מילוי עובדים
            const employeeSelects = ['additional-employee', 'edit-additional-employee', 'employee-filter'];
            employeeSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const isFilter = selectId === 'employee-filter';
                select.innerHTML = isFilter ? '<option value="">כל העובדים</option>' : '<option value="">בחר עובד (אופציונלי)</option>';
                
                const relevantUsers = isFilter ? users : users.filter(u => u.role === 'employee');
                relevantUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.name;
                    option.textContent = user.name;
                    select.appendChild(option);
                });
            });
            
            // מילוי סוגי משימות
            const taskTypeSelects = ['task-type', 'edit-task-type'];
            taskTypeSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">בחר סוג משימה</option>';
                
                taskTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    select.appendChild(option);
                });
            });
        }

        function handleAddTask(e) {
            e.preventDefault();
            
            const taskData = {
                id: Math.max(...tasks.map(t => t.id), 0) + 1,
                clientName: document.getElementById('client-name').value,
                partnerHandler: document.getElementById('partner-handler').value,
                additionalEmployee: document.getElementById('additional-employee').value,
                taskType: document.getElementById('task-type').value,
                status: 'טרם התחיל',
                priority: document.getElementById('priority').value,
                dueDate: document.getElementById('due-date').value,
                notes: document.getElementById('notes').value,
                createdDate: new Date().toLocaleDateString('he-IL'),
                comments: []
            };
            
            tasks.unshift(taskData);
            saveTasksToSheets();
            
            document.getElementById('task-form').reset();
            filterTasks();
            updateStats();
            showToast('✨ המשימה נוצרה בהצלחה!');
        }

        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            editingTaskId = taskId;
            
            document.getElementById('edit-client-name').value = task.clientName;
            document.getElementById('edit-partner-handler').value = task.partnerHandler;
            document.getElementById('edit-additional-employee').value = task.additionalEmployee;
            document.getElementById('edit-task-type').value = task.taskType;
            document.getElementById('edit-task-status').value = task.status;
            document.getElementById('edit-priority').value = task.priority;
            document.getElementById('edit-due-date').value = task.dueDate;
            document.getElementById('edit-notes').value = task.notes;
            
            document.getElementById('edit-modal').style.display = 'block';
        }

        function handleEditTask(e) {
            e.preventDefault();
            
            const taskIndex = tasks.findIndex(t => t.id === editingTaskId);
            if (taskIndex === -1) return;
            
            tasks[taskIndex] = {
                ...tasks[taskIndex],
                clientName: document.getElementById('edit-client-name').value,
                partnerHandler: document.getElementById('edit-partner-handler').value,
                additionalEmployee: document.getElementById('edit-additional-employee').value,
                taskType: document.getElementById('edit-task-type').value,
                status: document.getElementById('edit-task-status').value,
                priority: document.getElementById('edit-priority').value,
                dueDate: document.getElementById('edit-due-date').value,
                notes: document.getElementById('edit-notes').value
            };
            
            saveTasksToSheets();
            closeEditModal();
            filterTasks();
            updateStats();
            showToast('✅ המשימה עודכנה בהצלחה!');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
            editingTaskId = null;
        }

        function deleteTask() {
            if (!editingTaskId) return;
            
            if (confirm('האם אתה בטוח שברצונך למחוק את המשימה?')) {
                tasks = tasks.filter(task => task.id !== editingTaskId);
                saveTasksToSheets();
                closeEditModal();
                filterTasks();
                updateStats();
                showToast('🗑️ המשימה נמחקה בהצלחה!');
            }
        }

        function addComment(taskId, inputId) {
            const input = document.getElementById(inputId);
            const commentText = input.value.trim();
            
            if (!commentText) return;
            
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const comment = {
                author: currentUser.name,
                time: new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }),
                text: commentText
            };
            
            if (!task.comments) task.comments = [];
            task.comments.push(comment);
            
            input.value = '';
            saveTasksToSheets();
            filterTasks();
        }

        function filterTasks() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            const priorityFilter = document.getElementById('priority-filter').value;
            const employeeFilter = document.getElementById('employee-filter').value;
            
            let filteredTasks = tasks.filter(task => {
                if (currentUser.role === 'employee') {
                    if (task.partnerHandler !== currentUser.name && task.additionalEmployee !== currentUser.name) {
                        return false;
                    }
                }
                
                const matchesSearch = !searchTerm || 
                    task.clientName.toLowerCase().includes(searchTerm) ||
                    task.partnerHandler.toLowerCase().includes(searchTerm) ||
                    task.taskType.toLowerCase().includes(searchTerm) ||
                    task.notes.toLowerCase().includes(searchTerm);
                
                const matchesStatus = !statusFilter || task.status === statusFilter;
                const matchesPriority = !priorityFilter || task.priority === priorityFilter;
                const matchesEmployee = !employeeFilter || 
                    task.partnerHandler === employeeFilter || 
                    task.additionalEmployee === employeeFilter;
                
                return matchesSearch && matchesStatus && matchesPriority && matchesEmployee;
            });
            
            displayTasks(filteredTasks);
        }

        function displayTasks(tasksToShow) {
            const container = document.getElementById('tasks-container');
            const countElement = document.getElementById('tasks-count');
            
            countElement.textContent = `${tasksToShow.length} משימות`;
            
            if (tasksToShow.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">📋</div>
                        <h3>אין משימות להצגה</h3>
                        <p>נסה לשנות את הפילטרים או צור משימה חדשה</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = tasksToShow.map(task => `
                <div class="task-card ${getPriorityClass(task.priority)}" onclick="editTask(${task.id})">
                    <div class="task-header">
                        <div class="task-title">${task.clientName}</div>
                        <div class="task-status ${getStatusClass(task.status)}">${task.status}</div>
                    </div>
                    
                    <div class="task-details">
                        <div class="task-detail">
                            <span class="task-detail-icon">👤</span>
                            <span>שותף: ${task.partnerHandler}</span>
                        </div>
                        ${task.additionalEmployee ? `
                            <div class="task-detail">
                                <span class="task-detail-icon">👥</span>
                                <span>עובד נוסף: ${task.additionalEmployee}</span>
                            </div>
                        ` : ''}
                        <div class="task-detail">
                            <span class="task-detail-icon">📋</span>
                            <span>סוג: ${task.taskType}</span>
                        </div>
                        <div class="task-detail">
                            <span class="task-detail-icon">⭐</span>
                            <span>עדיפות: ${task.priority}</span>
                        </div>
                        <div class="task-detail">
                            <span class="task-detail-icon">📅</span>
                            <span>יעד: ${formatDate(task.dueDate)}</span>
                        </div>
                        <div class="task-detail">
                            <span class="task-detail-icon">📝</span>
                            <span>נוצר: ${task.createdDate}</span>
                        </div>
                    </div>
                    
                    ${task.notes || (task.comments && task.comments.length > 0) ? `
                        <div class="task-notes" onclick="event.stopPropagation()">
                            ${task.notes ? `<div class="notes-content">📝 ${task.notes}</div>` : ''}
                            
                            ${task.comments && task.comments.length > 0 ? `
                                <div style="border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px;">
                                    <strong>💬 תגובות:</strong>
                                    ${task.comments.map(comment => `
                                        <div class="comment">
                                            <span class="comment-author">${comment.author}:</span>
                                            ${comment.text}
                                            <span class="comment-time">${comment.time}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            <div class="add-comment">
                                <input type="text" class="comment-input" placeholder="הוסף תגובה..." 
                                       id="comment-${task.id}" onkeypress="if(event.key==='Enter') addComment(${task.id}, 'comment-${task.id}')">
                                <button class="comment-btn" onclick="addComment(${task.id}, 'comment-${task.id}')">💬</button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function getPriorityClass(priority) {
            switch (priority) {
                case 'גבוהה': return 'high-priority';
                case 'בינונית': return 'medium-priority';
                case 'נמוכה': return 'low-priority';
                default: return '';
            }
        }

        function getStatusClass(status) {
            switch (status) {
                case 'טרם התחיל': return 'status-not-started';
                case 'בתהליך': return 'status-in-progress';
                case 'הושלם': return 'status-completed';
                case 'מושהה': return 'status-on-hold';
                default: return 'status-not-started';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('he-IL');
        }

        function updateStats() {
            if (currentUser.role === 'employee') return;
            
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(task => task.status === 'הושלם').length;
            const pendingTasks = tasks.filter(task => task.status !== 'הושלם').length;
            const highPriorityTasks = tasks.filter(task => task.priority === 'גבוהה').length;
            
            document.getElementById('total-tasks').textContent = totalTasks;
            document.getElementById('completed-tasks').textContent = completedTasks;
            document.getElementById('pending-tasks').textContent = pendingTasks;
            document.getElementById('high-priority-tasks').textContent = highPriorityTasks;
        }

        // ניהול משתמשים
        function openUserManagement() {
            if (currentUser.role !== 'admin' && currentUser.role !== 'partner') {
                alert('אין לך הרשאה לפעולה זו');
                return;
            }
            displayUsersList();
            document.getElementById('user-management-modal').style.display = 'block';
        }

        function closeUserManagement() {
            document.getElementById('user-management-modal').style.display = 'none';
            hideAddUserForm();
        }

        function showAddUserForm() {
            document.getElementById('add-user-form').classList.remove('hidden');
        }

        function hideAddUserForm() {
            document.getElementById('add-user-form').classList.add('hidden');
            ['new-username', 'new-password', 'new-name', 'new-role'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }

        function addUser() {
            const username = document.getElementById('new-username').value.trim();
            const password = document.getElementById('new-password').value.trim();
            const name = document.getElementById('new-name').value.trim();
            const role = document.getElementById('new-role').value;
            
            if (!username || !password || !name || !role) {
                alert('יש למלא את כל השדות');
                return;
            }
            
            if (users.find(u => u.username === username)) {
                alert('שם המשתמש כבר קיים במערכת');
                return;
            }
            
            users.push({ username, password, name, role });
            localStorage.setItem('taskManager_users', JSON.stringify(users));
            
            hideAddUserForm();
            displayUsersList();
            populateSelects();
            showToast(`✅ המשתמש ${name} נוסף בהצלחה!`);
        }

        function displayUsersList() {
            const container = document.getElementById('users-list');
            container.innerHTML = `
                <h3 style="margin-bottom: 10px;">רשימת משתמשים</h3>
                ${users.map(user => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 6px; margin-bottom: 8px; border: 1px solid #eee;">
                        <div>
                            <strong>${user.name}</strong> (${user.username})
                            <br>
                            <small style="color: #6c757d;">${getRoleDisplayName(user.role)}</small>
                        </div>
                        ${user.username !== 'admin' ? `<button class="btn btn-danger" style="padding: 4px 8px; font-size: 0.8rem;" onclick="removeUser('${user.username}')">מחק</button>` : ''}
                    </div>
                `).join('')}
            `;
        }

        function getRoleDisplayName(role) {
            switch (role) {
                case 'admin': return 'מנהל מערכת';
                case 'partner': return 'שותף';
                case 'employee': return 'עובד';
                default: return role;
            }
        }

        function removeUser(username) {
            if (confirm('האם אתה בטוח שברצונך למחוק את המשתמש?')) {
                users = users.filter(u => u.username !== username);
                localStorage.setItem('taskManager_users', JSON.stringify(users));
                displayUsersList();
                populateSelects();
                showToast('🗑️ המשתמש נמחק בהצלחה!');
            }
        }

        // ניהול סוגי משימות
        function openTaskTypeManagement() {
            if (currentUser.role !== 'admin' && currentUser.role !== 'partner') {
                alert('אין לך הרשאה לפעולה זו');
                return;
            }
            displayTaskTypesList();
            document.getElementById('task-type-management-modal').style.display = 'block';
        }

        function closeTaskTypeManagement() {
            document.getElementById('task-type-management-modal').style.display = 'none';
            hideAddTaskTypeForm();
        }

        function showAddTaskTypeForm() {
            document.getElementById('add-task-type-form').classList.remove('hidden');
        }

        function hideAddTaskTypeForm() {
            document.getElementById('add-task-type-form').classList.add('hidden');
            document.getElementById('new-task-type').value = '';
        }

        function addTaskType() {
            const taskType = document.getElementById('new-task-type').value.trim();
            
            if (!taskType) {
                alert('יש להזין שם סוג משימה');
                return;
            }
            
            if (taskTypes.includes(taskType)) {
                alert('סוג המשימה כבר קיים במערכת');
                return;
            }
            
            taskTypes.push(taskType);
            localStorage.setItem('taskManager_taskTypes', JSON.stringify(taskTypes));
            
            hideAddTaskTypeForm();
            displayTaskTypesList();
            populateSelects();
            showToast(`✅ סוג המשימה "${taskType}" נוסף בהצלחה!`);
        }

        function displayTaskTypesList() {
            const container = document.getElementById('task-types-list');
            container.innerHTML = `
                <h3 style="margin-bottom: 10px;">סוגי משימות</h3>
                ${taskTypes.map(type => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 6px; margin-bottom: 8px; border: 1px solid #eee;">
                        <strong>${type}</strong>
                        <button class="btn btn-danger" style="padding: 4px 8px; font-size: 0.8rem;" onclick="removeTaskType('${type}')">מחק</button>
                    </div>
                `).join('')}
            `;
        }

        function removeTaskType(type) {
            if (confirm(`האם אתה בטוח שברצונך למחוק את סוג המשימה "${type}"?`)) {
                taskTypes = taskTypes.filter(t => t !== type);
                localStorage.setItem('taskManager_taskTypes', JSON.stringify(taskTypes));
                displayTaskTypesList();
                populateSelects();
                showToast('🗑️ סוג המשימה נמחק בהצלחה!');
            }
        }

        function openReports() {
            const reportData = {
                totalTasks: tasks.length,
                byStatus: {
                    'טרם התחיל': tasks.filter(t => t.status === 'טרם התחיל').length,
                    'בתהליך': tasks.filter(t => t.status === 'בתהליך').length,
                    'הושלם': tasks.filter(t => t.status === 'הושלם').length,
                    'מושהה': tasks.filter(t => t.status === 'מושהה').length
                },
                byPriority: {
                    'גבוהה': tasks.filter(t => t.priority === 'גבוהה').length,
                    'בינונית': tasks.filter(t => t.priority === 'בינונית').length,
                    'נמוכה': tasks.filter(t => t.priority === 'נמוכה').length
                }
            };
            
            let reportText = `📊 דוח משימות:\n\n`;
            reportText += `סה"כ משימות: ${reportData.totalTasks}\n\n`;
            reportText += `לפי סטטוס:\n`;
            Object.entries(reportData.byStatus).forEach(([status, count]) => {
                reportText += `• ${status}: ${count}\n`;
            });
            reportText += `\nלפי עדיפות:\n`;
            Object.entries(reportData.byPriority).forEach(([priority, count]) => {
                reportText += `• ${priority}: ${count}\n`;
            });
            
            alert(reportText);
        }

        // סגירת מודאלים
        ['edit-modal', 'user-management-modal', 'task-type-management-modal'].forEach(modalId => {
            document.getElementById(modalId).addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
        });

        // קיצורי מקלדת
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
            }
        });

        // סגירת אוטוקומפליט בלחיצה בחוץ
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.autocomplete-container')) {
                document.querySelectorAll('.autocomplete-suggestions').forEach(suggestions => {
                    suggestions.classList.add('hidden');
                });
            }
        });

    </script>
</body>
</html>
