<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניהול משימות צבעונית</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            direction: rtl;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            min-height: 100vh;
        }

        .main-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            grid-column: 1 / -1;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        /* מערכת התחברות */
        .login-container {
            grid-column: 1 / -1;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }

        .login-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .login-title {
            text-align: center;
            font-size: 1.8rem;
            margin-bottom: 30px;
            color: #2c3e50;
        }

        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 15px 0;
        }

        .remember-me input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        /* טופס יצירת משימה מושך */
        .create-task-section {
            margin-bottom: 40px;
        }

        .create-task-header {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            text-align: center;
            margin-bottom: 0;
        }

        .create-task-header h2 {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .create-task-form {
            background: #f8f9fa;
            border-radius: 0 0 15px 15px;
            padding: 30px;
            border: 3px solid #FF6B6B;
            border-top: none;
        }

        .form-section {
            margin-bottom: 25px;
        }

        .form-section-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e9ecef;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #495057;
            font-size: 1rem;
        }

        .required {
            color: #dc3545;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #FF6B6B;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
            transform: translateY(-2px);
        }

        .autocomplete-container {
            position: relative;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #FF6B6B;
            border-top: none;
            border-radius: 0 0 12px 12px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .autocomplete-suggestion {
            padding: 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 1.1rem;
            transition: background 0.2s ease;
        }

        .autocomplete-suggestion:hover {
            background: #fff5f5;
        }

        .autocomplete-suggestion:last-child {
            border-bottom: none;
        }

        .create-task-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 140px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #FF6B6B, #dc3545);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .btn-create {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            font-size: 1.2rem;
            padding: 18px 40px;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-create:hover {
            box-shadow: 0 10px 30px rgba(40, 167, 69, 0.4);
            transform: translateY(-4px);
        }

        /* סיידבר */
        .user-info {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 15px;
            color: white;
        }

        .user-name {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .user-role {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            display: inline-block;
            margin-bottom: 15px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* סטטיסטיקות */
        .stats-section {
            margin-bottom: 30px;
        }

        .stats-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        /* ניהול מערכת */
        .management-section {
            margin-bottom: 30px;
        }

        .management-actions {
            display: grid;
            gap: 10px;
        }

        .management-btn {
            padding: 12px 15px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: right;
            font-size: 0.95rem;
        }

        .management-btn:hover {
            border-color: #667eea;
            background: #f8f9fa;
            transform: translateX(-3px);
        }

        /* סינון וחיפוש */
        .filters-section {
            margin-bottom: 30px;
        }

        .filters-grid {
            display: grid;
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-weight: bold;
            color: #495057;
            font-size: 0.9rem;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 0.95rem;
        }

        /* רשימת משימות */
        .tasks-section {
            margin-top: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #e9ecef;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .tasks-container {
            display: grid;
            gap: 20px;
        }

        .task-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-right: 6px solid #667eea;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }

        .task-card.high-priority {
            border-right-color: #FF6B6B;
        }

        .task-card.medium-priority {
            border-right-color: #FFD93D;
        }

        .task-card.low-priority {
            border-right-color: #6BCF7F;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .task-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .task-status {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            text-align: center;
        }

        .status-not-started {
            background: #ffeaa7;
            color: #d63031;
        }

        .status-in-progress {
            background: #74b9ff;
            color: white;
        }

        .status-completed {
            background: #00b894;
            color: white;
        }

        .status-on-hold {
            background: #fd79a8;
            color: white;
        }

        .task-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .task-detail {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
        }

        .task-detail-icon {
            font-size: 1.1rem;
            width: 25px;
            text-align: center;
        }

        .task-notes {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-top: 15px;
            border-right: 4px solid #667eea;
        }

        .notes-content {
            font-style: italic;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .notes-comments {
            border-top: 1px solid #e9ecef;
            padding-top: 15px;
        }

        .comment {
            background: white;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-right: 3px solid #667eea;
            font-size: 0.9rem;
        }

        .comment-author {
            font-weight: bold;
            color: #667eea;
            margin-left: 5px;
        }

        .comment-time {
            font-size: 0.8rem;
            color: #6c757d;
            float: left;
        }

        .add-comment {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .comment-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .comment-btn {
            padding: 10px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .comment-btn:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        /* מודאלים */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f8f9fa;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: #f8f9fa;
            color: #dc3545;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .sync-status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 0.9rem;
        }

        .sync-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .sync-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .sync-loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .sidebar {
                position: static;
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .task-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- מסך התחברות -->
    <div id="login-screen">
        <div class="header">
            <h1>📋 מערכת ניהול משימות</h1>
            <p>ניהול משימות חכם ויעיל</p>
        </div>
        
        <div class="login-container">
            <div class="login-panel">
                <h2 class="login-title">התחברות למערכת</h2>
                <form id="login-form">
                    <div class="form-group">
                        <label for="username">שם משתמש:</label>
                        <input type="text" id="username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">סיסמה:</label>
                        <input type="password" id="password" required>
                    </div>
                    <div class="remember-me">
                        <input type="checkbox" id="remember-me">
                        <label for="remember-me">זכור אותי</label>
                    </div>
                    <button type="submit" class="btn btn-primary">התחבר</button>
                </form>
            </div>
        </div>
    </div>

    <!-- מסך ראשי -->
    <div id="main-screen" class="hidden">
        <div class="header">
            <h1>📋 מערכת ניהול משימות</h1>
            <p>ניהול משימות חכם ויעיל</p>
        </div>

        <div class="container">
            <!-- תוכן ראשי -->
            <div class="main-content">
                <div id="loading" class="loading hidden">
                    <div class="spinner"></div>
                    <p>טוען נתונים...</p>
                </div>

                <!-- יצירת משימה חדשה -->
                <div class="create-task-section">
                    <div class="create-task-header">
                        <h2>🚀 יצירת משימה חדשה</h2>
                    </div>
                    
                    <form id="task-form" class="create-task-form">
                        <div class="form-section">
                            <div class="form-section-title">📋 פרטי המשימה</div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="client-name">שם לקוח <span class="required">*</span></label>
                                    <div class="autocomplete-container">
                                        <input type="text" id="client-name" placeholder="התחל להקליד שם לקוח..." required>
                                        <div id="client-suggestions" class="autocomplete-suggestions hidden"></div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="task-type">סוג משימה <span class="required">*</span></label>
                                    <select id="task-type" required>
                                        <option value="">בחר סוג משימה</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section-title">👥 אחראים על המשימה</div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="partner-handler">שותף מטפל <span class="required">*</span></label>
                                    <select id="partner-handler" required>
                                        <option value="">בחר שותף</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="additional-employee">עובד נוסף</label>
                                    <select id="additional-employee">
                                        <option value="">בחר עובד (אופציונלי)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section-title">⚡ עדיפות ולוח זמנים</div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="priority">עדיפות <span class="required">*</span></label>
                                    <select id="priority" required>
                                        <option value="">בחר עדיפות</option>
                                        <option value="גבוהה">🔴 גבוהה</option>
                                        <option value="בינונית">🟡 בינונית</option>
                                        <option value="נמוכה">🟢 נמוכה</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="due-date">תאריך יעד <span class="required">*</span></label>
                                    <input type="date" id="due-date" required>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section-title">📝 הערות נוספות</div>
                            <div class="form-group">
                                <textarea id="notes" placeholder="הוסף הערות, פרטים נוספים או הוראות מיוחדות..." rows="4"></textarea>
                            </div>
                        </div>

                        <div class="create-task-actions">
                            <button type="submit" class="btn btn-create">✨ יצירת משימה</button>
                        </div>
                    </form>
                </div>

                <!-- רשימת משימות -->
                <div class="tasks-section">
                    <div class="section-header">
                        <h2 class="section-title">📋 רשימת המשימות</h2>
                        <div id="tasks-count" class="tasks-count">0 משימות</div>
                    </div>
                    
                    <div id="tasks-container" class="tasks-container">
                        <!-- משימות יוצגו כאן -->
                    </div>
                </div>
            </div>

            <!-- סיידבר -->
            <div class="sidebar">
                <!-- מידע משתמש -->
                <div class="user-info">
                    <div class="user-name" id="current-user">משתמש</div>
                    <div class="user-role" id="user-role">תפקיד</div>
                    <button class="logout-btn" onclick="logout()">התנתק</button>
                </div>

                <!-- סטטיסטיקות -->
                <div id="stats-section" class="stats-section hidden">
                    <h3 class="stats-title">📊 סטטיסטיקות</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="total-tasks">0</div>
                            <div class="stat-label">סה"כ משימות</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="completed-tasks">0</div>
                            <div class="stat-label">הושלמו</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="pending-tasks">0</div>
                            <div class="stat-label">ממתינות</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="high-priority-tasks">0</div>
                            <div class="stat-label">עדיפות גבוהה</div>
                        </div>
                    </div>
                </div>

                <!-- ניהול מערכת -->
                <div id="management-section" class="management-section hidden">
                    <h3 class="stats-title">⚙️ ניהול המערכת</h3>
                    <div class="management-actions">
                        <div class="management-btn" onclick="openUserManagement()">
                            👥 ניהול משתמשים
                        </div>
                        <div class="management-btn" onclick="openTaskTypeManagement()">
                            📋 ניהול סוגי משימות
                        </div>
                        <div class="management-btn" onclick="openReports()">
                            📊 דוחות ומעקב
                        </div>
                        <div class="management-btn" onclick="syncClients()">
                            🔄 סנכרון לקוחות
                        </div>
                    </div>
                </div>

                <!-- סינון וחיפוש -->
                <div class="filters-section">
                    <h3 class="stats-title">🔍 סינון וחיפוש</h3>
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label>חיפוש מהיר</label>
                            <input type="text" id="search-input" placeholder="חפש משימות...">
                        </div>
                        <div class="filter-group">
                            <label>סטטוס</label>
                            <select id="status-filter">
                                <option value="">כל הסטטוסים</option>
                                <option value="טרם התחיל">טרם התחיל</option>
                                <option value="בתהליך">בתהליך</option>
                                <option value="הושלם">הושלם</option>
                                <option value="מושהה">מושהה</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>עדיפות</label>
                            <select id="priority-filter">
                                <option value="">כל העדיפויות</option>
                                <option value="גבוהה">גבוהה</option>
                                <option value="בינונית">בינונית</option>
                                <option value="נמוכה">נמוכה</option>
                            </select>
                        </div>
                        <div class="filter-group" id="employee-filter-group">
                            <label>עובד</label>
                            <select id="employee-filter">
                                <option value="">כל העובדים</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- סטטוס סנכרון -->
                <div id="sync-status" class="sync-status hidden"></div>
            </div>
        </div>
    </div>

    <!-- מודאל עריכת משימה -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">עריכת משימה</h2>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>
            
            <form id="edit-form">
                <div class="form-group">
                    <label for="edit-client-name">שם לקוח *</label>
                    <div class="autocomplete-container">
                        <input type="text" id="edit-client-name" required>
                        <div id="edit-client-suggestions" class="autocomplete-suggestions hidden"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="edit-partner-handler">שותף מטפל *</label>
                    <select id="edit-partner-handler" required>
                        <option value="">בחר שותף</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="edit-additional-employee">עובד נוסף</label>
                    <select id="edit-additional-employee">
                        <option value="">בחר עובד (אופציונלי)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="edit-task-type">סוג משימה *</label>
                    <select id="edit-task-type" required>
                        <option value="">בחר סוג משימה</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="edit-task-status">סטטוס משימה</label>
                    <select id="edit-task-status">
                        <option value="טרם התחיל">טרם התחיל</option>
                        <option value="בתהליך">בתהליך</option>
                        <option value="הושלם">הושלם</option>
                        <option value="מושהה">מושהה</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="edit-priority">עדיפות *</label>
                    <select id="edit-priority" required>
                        <option value="">בחר עדיפות</option>
                        <option value="גבוהה">גבוהה</option>
                        <option value="בינונית">בינונית</option>
                        <option value="נמוכה">נמוכה</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="edit-due-date">תאריך יעד *</label>
                    <input type="date" id="edit-due-date" required>
                </div>

                <div class="form-group">
                    <label for="edit-notes">הערות</label>
                    <textarea id="edit-notes" rows="3"></textarea>
                </div>

                <div class="create-task-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">ביטול</button>
                    <button type="submit" class="btn btn-primary">💾 עדכן משימה</button>
                    <button type="button" class="btn btn-danger" onclick="deleteTask()">🗑️ מחק משימה</button>
                </div>
            </form>
        </div>
    </div>

    <!-- מודאל ניהול משתמשים -->
    <div id="user-management-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ניהול משתמשים</h2>
                <button class="close-btn" onclick="closeUserManagement()">&times;</button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <button class="btn btn-success" onclick="showAddUserForm()">➕ הוסף משתמש חדש</button>
            </div>

            <div id="add-user-form" class="hidden" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">משתמש חדש</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>שם משתמש:</label>
                        <input type="text" id="new-username" required>
                    </div>
                    <div class="form-group">
                        <label>סיסמה:</label>
                        <input type="password" id="new-password" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>שם מלא:</label>
                        <input type="text" id="new-name" required>
                    </div>
                    <div class="form-group">
                        <label>תפקיד:</label>
                        <select id="new-role" required>
                            <option value="">בחר תפקיד</option>
                            <option value="admin">מנהל</option>
                            <option value="partner">שותף</option>
                            <option value="employee">עובד</option>
                        </select>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn btn-success" onclick="addUser()">💾 שמור משתמש</button>
                    <button class="btn btn-secondary" onclick="hideAddUserForm()">ביטול</button>
                </div>
            </div>

            <div id="users-list"></div>
        </div>
    </div>

    <!-- מודאל ניהול סוגי משימות -->
    <div id="task-type-management-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ניהול סוגי משימות</h2>
                <button class="close-btn" onclick="closeTaskTypeManagement()">&times;</button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <button class="btn btn-success" onclick="showAddTaskTypeForm()">➕ הוסף סוג משימה חדש</button>
            </div>

            <div id="add-task-type-form" class="hidden" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">סוג משימה חדש</h3>
                <div class="form-group">
                    <label>שם סוג המשימה:</label>
                    <input type="text" id="new-task-type" placeholder="לדוגמה: פגישה, שיחה, מסמכים..." required>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn btn-success" onclick="addTaskType()">💾 שמור סוג משימה</button>
                    <button class="btn btn-secondary" onclick="hideAddTaskTypeForm()">ביטול</button>
                </div>
            </div>

            <div id="task-types-list"></div>
        </div>
    </div>

    <script>
        // משתנים גלובליים
        let currentUser = null;
        let tasks = [];
        let clients = [];
        let users = [];
        let taskTypes = [];
        let editingTaskId = null;
        let clientsSyncInterval = null;

        // הגדרות Google Sheets
        const SPREADSHEET_ID = '1n380H7Wkz8ZB5e8KxmlRUAbvx3EMxK0DMGUyABqokb4';
        const CLIENTS_SPREADSHEET_ID = '1rZvtny_hfa-7VvV0MzkPMGssLIUUVDm6';
        const API_KEY = 'AIzaSyDR6k3fBY1aZXW_UhVoCC2N34nKpVDX3vo';

        // משתמשים וסוגי משימות לדוגמה
        const defaultUsers = [
            { username: 'admin', password: 'admin123', role: 'admin', name: 'מנהל המערכת' },
            { username: 'yaniv', password: 'yaniv123', role: 'partner', name: 'יניב' },
            { username: 'arik', password: 'arik123', role: 'partner', name: 'אריק' },
            { username: 'michal', password: 'michal123', role: 'employee', name: 'מיכל' },
            { username: 'ronit', password: 'ronit123', role: 'employee', name: 'רונית' }
        ];

        const defaultTaskTypes = [
            'פגישה',
            'שיחה',
            'מסמכים',
            'מעקב',
            'הצעת מחיר',
            'תמיכה טכנית',
            'ייעוץ',
            'אחר'
        ];

        // אתחול המערכת
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
        });

        function initializeSystem() {
            // טעינת נתונים מ-localStorage
            users = JSON.parse(localStorage.getItem('taskManager_users')) || [...defaultUsers];
            taskTypes = JSON.parse(localStorage.getItem('taskManager_taskTypes')) || [...defaultTaskTypes];
            
            // בדיקת "זכור אותי"
            const rememberedUser = localStorage.getItem('taskManager_rememberedUser');
            if (rememberedUser) {
                const userData = JSON.parse(rememberedUser);
                document.getElementById('username').value = userData.username;
                document.getElementById('password').value = userData.password;
                document.getElementById('remember-me').checked = true;
            }
            
            setMinDate();
            setupEventListeners();
            
            // סנכרון לקוחות כל שבוע
            startWeeklyClientSync();
        }

        function setMinDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('due-date').min = today;
            document.getElementById('edit-due-date').min = today;
        }

        function setupEventListeners() {
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('task-form').addEventListener('submit', handleAddTask);
            document.getElementById('edit-form').addEventListener('submit', handleEditTask);
            
            ['search-input', 'status-filter', 'priority-filter', 'employee-filter'].forEach(id => {
                document.getElementById(id).addEventListener('input', filterTasks);
                document.getElementById(id).addEventListener('change', filterTasks);
            });
            
            setupAutocomplete('client-name', 'client-suggestions');
            setupAutocomplete('edit-client-name', 'edit-client-suggestions');
        }

        // התחברות
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('remember-me').checked;
            
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                
                // שמירת "זכור אותי"
                if (rememberMe) {
                    localStorage.setItem('taskManager_rememberedUser', JSON.stringify({username, password}));
                } else {
                    localStorage.removeItem('taskManager_rememberedUser');
                }
                
                showMainScreen();
                loadData();
            } else {
                alert('שם משתמש או סיסמה שגויים');
            }
        }

        function showMainScreen() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-screen').classList.remove('hidden');
            
            document.getElementById('current-user').textContent = currentUser.name;
            
            const roleElement = document.getElementById('user-role');
            if (currentUser.role === 'admin') {
                roleElement.textContent = 'מנהל מערכת';
                document.getElementById('stats-section').classList.remove('hidden');
                document.getElementById('management-section').classList.remove('hidden');
                document.getElementById('employee-filter-group').classList.remove('hidden');
            } else if (currentUser.role === 'partner') {
                roleElement.textContent = 'שותף';
                document.getElementById('stats-section').classList.remove('hidden');
                document.getElementById('management-section').classList.add('hidden');
                document.getElementById('employee-filter-group').classList.remove('hidden');
            } else {
                roleElement.textContent = 'עובד';
                document.getElementById('stats-section').classList.add('hidden');
                document.getElementById('management-section').classList.add('hidden');
                document.getElementById('employee-filter-group').classList.add('hidden');
            }
            
            populateUserSelects();
            populateTaskTypeSelects();
        }

        function logout() {
            currentUser = null;
            document.getElementById('main-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('login-form').reset();
        }

        async function loadData() {
            showLoading(true);
            
            try {
                await Promise.all([
                    loadTasks(),
                    loadClients()
                ]);
                
                filterTasks();
                updateStats();
            } catch (error) {
                console.error('שגיאה בטעינת נתונים:', error);
                initializeSampleData();
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        async function loadTasks() {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/משימות!A:J?key=${API_KEY}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.values && data.values.length > 1) {
                    tasks = data.values.slice(1).map((row, index) => ({
                        id: index + 1,
                        clientName: row[0] || '',
                        partnerHandler: row[1] || '',
                        additionalEmployee: row[2] || '',
                        taskType: row[3] || '',
                        status: row[4] || 'טרם התחיל',
                        priority: row[5] || '',
                        dueDate: row[6] || '',
                        notes: row[7] || '',
                        createdDate: row[8] || new Date().toLocaleDateString('he-IL'),
                        comments: row[9] ? JSON.parse(row[9]) : []
                    }));
                } else {
                    throw new Error('אין נתונים בגיליון');
                }
            } catch (error) {
                console.error('שגיאה בטעינת משימות:', error);
                throw error;
            }
        }

        async function loadClients() {
            showSyncStatus('טוען רשימת לקוחות...', 'loading');
            
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${CLIENTS_SPREADSHEET_ID}/values/A:A?key=${API_KEY}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.values && data.values.length > 0) {
                    clients = data.values.flat().filter(client => client && client.trim());
                    showSyncStatus(`✅ נטענו ${clients.length} לקוחות בהצלחה`, 'success');
                    console.log('נטענו לקוחות:', clients.length);
                } else {
                    throw new Error('אין נתוני לקוחות');
                }
            } catch (error) {
                console.error('שגיאה בטעינת לקוחות:', error);
                showSyncStatus('❌ שגיאה בטעינת לקוחות - נעבוד עם נתוני דוגמה', 'error');
                
                // נתוני לקוחות לדוגמה
                clients = [
                    'חברת הטכנולוגיה בע"מ',
                    'משרד עורכי דין כהן ושות',
                    'קבוצת נדל"ן פרימיום',
                    'חברת הייטק דיגיטל',
                    'מרכז רפואי מדיקל',
                    'בנק ישראל בע"מ',
                    'חברת הבנייה הירוקה',
                    'סטודיו עיצוב קריאטיב',
                    'חברת ייעוץ עסקי',
                    'מעבדת מחקר ופיתוח'
                ];
            }
        }

        function showSyncStatus(message, type) {
            const statusElement = document.getElementById('sync-status');
            statusElement.textContent = message;
            statusElement.className = `sync-status sync-${type}`;
            statusElement.classList.remove('hidden');
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusElement.classList.add('hidden');
                }, 5000);
            }
        }

        function startWeeklyClientSync() {
            // סנכרון מיידי
            syncClients();
            
            // סנכרון כל שבוע (7 ימים)
            clientsSyncInterval = setInterval(syncClients, 7 * 24 * 60 * 60 * 1000);
        }

        function syncClients() {
            console.log('מסנכרן רשימת לקוחות...');
            loadClients().then(() => {
                console.log('סנכרון לקוחות הושלם');
            }).catch(error => {
                console.error('שגיאה בסנכרון לקוחות:', error);
            });
        }

        function initializeSampleData() {
            tasks = [
                {
                    id: 1,
                    clientName: 'חברת הטכנולוגיה בע"מ',
                    partnerHandler: 'יניב',
                    additionalEmployee: 'מיכל',
                    taskType: 'פגישה',
                    status: 'בתהליך',
                    priority: 'גבוהה',
                    dueDate: '2025-06-15',
                    notes: 'פגישה חשובה לגבי פרויקט חדש',
                    createdDate: '11/06/2025',
                    comments: [
                        { author: 'יניב', time: '12:30', text: 'הלקוח מבקש לדחות ליום רביעי' },
                        { author: 'מיכל', time: '13:15', text: 'בסדר, אני אעדכן את הלקוח' }
                    ]
                },
                {
                    id: 2,
                    clientName: 'משרד עורכי דין כהן ושות',
                    partnerHandler: 'אריק',
                    additionalEmployee: '',
                    taskType: 'מסמכים',
                    status: 'טרם התחיל',
                    priority: 'בינונית',
                    dueDate: '2025-06-20',
                    notes: 'הכנת מסמכים משפטיים',
                    createdDate: '11/06/2025',
                    comments: []
                },
                {
                    id: 3,
                    clientName: 'קבוצת נדל"ן פרימיום',
                    partnerHandler: 'יניב',
                    additionalEmployee: '',
                    taskType: 'מעקב',
                    status: 'הושלם',
                    priority: 'נמוכה',
                    dueDate: '2025-06-10',
                    notes: 'מעקב אחר עסקת נדל"ן',
                    createdDate: '05/06/2025',
                    comments: [
                        { author: 'יניב', time: '09:00', text: 'העסקה אושרה בהצלחה!' }
                    ]
                }
            ];
            
            filterTasks();
            updateStats();
        }

        function populateUserSelects() {
            const partnerSelects = ['partner-handler', 'edit-partner-handler'];
            const employeeSelects = ['additional-employee', 'edit-additional-employee', 'employee-filter'];
            
            partnerSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">בחר שותף</option>';
                
                users.filter(u => u.role === 'partner' || u.role === 'admin').forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.name;
                    option.textContent = user.name;
                    select.appendChild(option);
                });
            });
            
            employeeSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const isFilter = selectId === 'employee-filter';
                select.innerHTML = isFilter ? '<option value="">כל העובדים</option>' : '<option value="">בחר עובד (אופציונלי)</option>';
                
                const allUsers = isFilter ? users : users.filter(u => u.role === 'employee');
                allUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.name;
                    option.textContent = user.name;
                    select.appendChild(option);
                });
            });
        }

        function populateTaskTypeSelects() {
            const selects = ['task-type', 'edit-task-type'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">בחר סוג משימה</option>';
                
                taskTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    select.appendChild(option);
                });
            });
        }

        function setupAutocomplete(inputId, suggestionsId) {
            const input = document.getElementById(inputId);
            const suggestions = document.getElementById(suggestionsId);
            
            input.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                if (value.length < 1) {
                    suggestions.classList.add('hidden');
                    return;
                }
                
                const matches = clients.filter(client => 
                    client.toLowerCase().includes(value)
                ).slice(0, 10);
                
                if (matches.length > 0) {
                    suggestions.innerHTML = matches.map(client => 
                        `<div class="autocomplete-suggestion" onclick="selectClient('${inputId}', '${client}')">${client}</div>`
                    ).join('');
                    suggestions.classList.remove('hidden');
                } else {
                    suggestions.classList.add('hidden');
                }
            });
            
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.classList.add('hidden');
                }
            });
        }

        function selectClient(inputId, client) {
            document.getElementById(inputId).value = client;
            document.getElementById(inputId === 'client-name' ? 'client-suggestions' : 'edit-client-suggestions').classList.add('hidden');
        }

        function handleAddTask(e) {
            e.preventDefault();
            
            const taskData = {
                id: Math.max(...tasks.map(t => t.id), 0) + 1,
                clientName: document.getElementById('client-name').value,
                partnerHandler: document.getElementById('partner-handler').value,
                additionalEmployee: document.getElementById('additional-employee').value,
                taskType: document.getElementById('task-type').value,
                status: 'טרם התחיל',
                priority: document.getElementById('priority').value,
                dueDate: document.getElementById('due-date').value,
                notes: document.getElementById('notes').value,
                createdDate: new Date().toLocaleDateString('he-IL'),
                comments: []
            };
            
            tasks.unshift(taskData); // הוספה לתחילת הרשימה
            saveToGoogleSheets();
            
            document.getElementById('task-form').reset();
            filterTasks();
            updateStats();
            
            // אנימציה של הודעת הצלחה
            showSuccessMessage('✨ המשימה נוצרה בהצלחה!');
        }

        function showSuccessMessage(message) {
            const messageEl = document.createElement('div');
            messageEl.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(45deg, #28a745, #20c997);
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                font-weight: bold;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            messageEl.textContent = message;
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.remove();
            }, 3000);
        }

        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            editingTaskId = taskId;
            
            document.getElementById('edit-client-name').value = task.clientName;
            document.getElementById('edit-partner-handler').value = task.partnerHandler;
            document.getElementById('edit-additional-employee').value = task.additionalEmployee;
            document.getElementById('edit-task-type').value = task.taskType;
            document.getElementById('edit-task-status').value = task.status;
            document.getElementById('edit-priority').value = task.priority;
            document.getElementById('edit-due-date').value = task.dueDate;
            document.getElementById('edit-notes').value = task.notes;
            
            document.getElementById('edit-modal').style.display = 'block';
        }

        function handleEditTask(e) {
            e.preventDefault();
            
            const taskIndex = tasks.findIndex(t => t.id === editingTaskId);
            if (taskIndex === -1) return;
            
            tasks[taskIndex] = {
                ...tasks[taskIndex],
                clientName: document.getElementById('edit-client-name').value,
                partnerHandler: document.getElementById('edit-partner-handler').value,
                additionalEmployee: document.getElementById('edit-additional-employee').value,
                taskType: document.getElementById('edit-task-type').value,
                status: document.getElementById('edit-task-status').value,
                priority: document.getElementById('edit-priority').value,
                dueDate: document.getElementById('edit-due-date').value,
                notes: document.getElementById('edit-notes').value
            };
            
            saveToGoogleSheets();
            closeEditModal();
            filterTasks();
            updateStats();
            
            showSuccessMessage('✅ המשימה עודכנה בהצלחה!');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
            editingTaskId = null;
        }

        function deleteTask() {
            if (!editingTaskId) return;
            
            if (confirm('האם אתה בטוח שברצונך למחוק את המשימה?')) {
                tasks = tasks.filter(task => task.id !== editingTaskId);
                saveToGoogleSheets();
                closeEditModal();
                filterTasks();
                updateStats();
                showSuccessMessage('🗑️ המשימה נמחקה בהצלחה!');
            }
        }

        function addComment(taskId, inputId) {
            const input = document.getElementById(inputId);
            const commentText = input.value.trim();
            
            if (!commentText) return;
            
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const comment = {
                author: currentUser.name,
                time: new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }),
                text: commentText
            };
            
            if (!task.comments) task.comments = [];
            task.comments.push(comment);
            
            input.value = '';
            saveToGoogleSheets();
            filterTasks();
        }

        function filterTasks() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            const priorityFilter = document.getElementById('priority-filter').value;
            const employeeFilter = document.getElementById('employee-filter').value;
            
            let filteredTasks = tasks.filter(task => {
                // סינון לפי הרשאות משתמש
                if (currentUser.role === 'employee') {
                    if (task.partnerHandler !== currentUser.name && task.additionalEmployee !== currentUser.name) {
                        return false;
                    }
                }
                
                // סינון לפי חיפוש
                const matchesSearch = !searchTerm || 
                    task.clientName.toLowerCase().includes(searchTerm) ||
                    task.partnerHandler.toLowerCase().includes(searchTerm) ||
                    task.taskType.toLowerCase().includes(searchTerm) ||
                    task.notes.toLowerCase().includes(searchTerm);
                
                // סינון לפי פילטרים
                const matchesStatus = !statusFilter || task.status === statusFilter;
                const matchesPriority = !priorityFilter || task.priority === priorityFilter;
                const matchesEmployee = !employeeFilter || 
                    task.partnerHandler === employeeFilter || 
                    task.additionalEmployee === employeeFilter;
                
                return matchesSearch && matchesStatus && matchesPriority && matchesEmployee;
            });
            
            displayTasks(filteredTasks);
        }

        function displayTasks(tasksToShow) {
            const container = document.getElementById('tasks-container');
            const countElement = document.getElementById('tasks-count');
            
            countElement.textContent = `${tasksToShow.length} משימות`;
            
            if (tasksToShow.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: #6c757d;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">📋</div>
                        <h3>אין משימות להצגה</h3>
                        <p>נסה לשנות את הפילטרים או צור משימה חדשה</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = tasksToShow.map(task => `
                <div class="task-card ${getPriorityClass(task.priority)}" onclick="editTask(${task.id})">
                    <div class="task-header">
                        <div class="task-title">${task.clientName}</div>
                        <div class="task-status ${getStatusClass(task.status)}">${task.status}</div>
                    </div>
                    
                    <div class="task-details">
                        <div class="task-detail">
                            <span class="task-detail-icon">👤</span>
                            <span>שותף: ${task.partnerHandler}</span>
                        </div>
                        ${task.additionalEmployee ? `
                            <div class="task-detail">
                                <span class="task-detail-icon">👥</span>
                                <span>עובד נוסף: ${task.additionalEmployee}</span>
                            </div>
                        ` : ''}
                        <div class="task-detail">
                            <span class="task-detail-icon">📋</span>
                            <span>סוג: ${task.taskType}</span>
                        </div>
                        <div class="task-detail">
                            <span class="task-detail-icon">⭐</span>
                            <span>עדיפות: ${task.priority}</span>
                        </div>
                        <div class="task-detail">
                            <span class="task-detail-icon">📅</span>
                            <span>יעד: ${formatDate(task.dueDate)}</span>
                        </div>
                        <div class="task-detail">
                            <span class="task-detail-icon">📝</span>
                            <span>נוצר: ${task.createdDate}</span>
                        </div>
                    </div>
                    
                    ${task.notes || (task.comments && task.comments.length > 0) ? `
                        <div class="task-notes" onclick="event.stopPropagation()">
                            ${task.notes ? `<div class="notes-content">📝 ${task.notes}</div>` : ''}
                            
                            ${task.comments && task.comments.length > 0 ? `
                                <div class="notes-comments">
                                    <strong>💬 תגובות:</strong>
                                    ${task.comments.map(comment => `
                                        <div class="comment">
                                            <span class="comment-author">${comment.author}:</span>
                                            ${comment.text}
                                            <span class="comment-time">${comment.time}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            <div class="add-comment">
                                <input type="text" class="comment-input" placeholder="הוסף תגובה..." 
                                       id="comment-${task.id}" onkeypress="if(event.key==='Enter') addComment(${task.id}, 'comment-${task.id}')">
                                <button class="comment-btn" onclick="addComment(${task.id}, 'comment-${task.id}')">💬</button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // פונקציות עזר
        function getPriorityClass(priority) {
            switch (priority) {
                case 'גבוהה': return 'high-priority';
                case 'בינונית': return 'medium-priority';
                case 'נמוכה': return 'low-priority';
                default: return '';
            }
        }

        function getStatusClass(status) {
            switch (status) {
                case 'טרם התחיל': return 'status-not-started';
                case 'בתהליך': return 'status-in-progress';
                case 'הושלם': return 'status-completed';
                case 'מושהה': return 'status-on-hold';
                default: return 'status-not-started';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('he-IL');
        }

        function updateStats() {
            if (currentUser.role === 'employee') return;
            
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(task => task.status === 'הושלם').length;
            const pendingTasks = tasks.filter(task => task.status !== 'הושלם').length;
            const highPriorityTasks = tasks.filter(task => task.priority === 'גבוהה').length;
            
            document.getElementById('total-tasks').textContent = totalTasks;
            document.getElementById('completed-tasks').textContent = completedTasks;
            document.getElementById('pending-tasks').textContent = pendingTasks;
            document.getElementById('high-priority-tasks').textContent = highPriorityTasks;
        }

        async function saveToGoogleSheets() {
            console.log('שמירה ל-Google Sheets...', tasks);
            // כאן תוכל להוסיף את הקוד לשמירה ב-Google Sheets
        }

        // ניהול משתמשים
        function openUserManagement() {
            displayUsersList();
            document.getElementById('user-management-modal').style.display = 'block';
        }

        function closeUserManagement() {
            document.getElementById('user-management-modal').style.display = 'none';
            hideAddUserForm();
        }

        function showAddUserForm() {
            document.getElementById('add-user-form').classList.remove('hidden');
        }

        function hideAddUserForm() {
            document.getElementById('add-user-form').classList.add('hidden');
            document.getElementById('new-username').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('new-name').value = '';
            document.getElementById('new-role').value = '';
        }

        function addUser() {
            const username = document.getElementById('new-username').value.trim();
            const password = document.getElementById('new-password').value.trim();
            const name = document.getElementById('new-name').value.trim();
            const role = document.getElementById('new-role').value;
            
            if (!username || !password || !name || !role) {
                alert('יש למלא את כל השדות');
                return;
            }
            
            if (users.find(u => u.username === username)) {
                alert('שם המשתמש כבר קיים במערכת');
                return;
            }
            
            const newUser = { username, password, name, role };
            users.push(newUser);
            localStorage.setItem('taskManager_users', JSON.stringify(users));
            
            hideAddUserForm();
            displayUsersList();
            populateUserSelects();
            
            showSuccessMessage(`✅ המשתמש ${name} נוסף בהצלחה!`);
        }

        function displayUsersList() {
            const container = document.getElementById('users-list');
            container.innerHTML = `
                <h3 style="margin-bottom: 15px;">רשימת משתמשים</h3>
                <div style="display: grid; gap: 10px;">
                    ${users.map(user => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e9ecef;">
                            <div>
                                <strong>${user.name}</strong> (${user.username})
                                <br>
                                <small style="color: #6c757d;">${getRoleDisplayName(user.role)}</small>
                            </div>
                            <button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8rem;" onclick="removeUser('${user.username}')">מחק</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function getRoleDisplayName(role) {
            switch (role) {
                case 'admin': return 'מנהל מערכת';
                case 'partner': return 'שותף';
                case 'employee': return 'עובד';
                default: return role;
            }
        }

        function removeUser(username) {
            if (username === 'admin') {
                alert('לא ניתן למחוק את המנהל הראשי');
                return;
            }
            
            if (confirm(`האם אתה בטוח שברצונך למחוק את המשתמש?`)) {
                users = users.filter(u => u.username !== username);
                localStorage.setItem('taskManager_users', JSON.stringify(users));
                displayUsersList();
                populateUserSelects();
                showSuccessMessage('🗑️ המשתמש נמחק בהצלחה!');
            }
        }

        // ניהול סוגי משימות
        function openTaskTypeManagement() {
            displayTaskTypesList();
            document.getElementById('task-type-management-modal').style.display = 'block';
        }

        function closeTaskTypeManagement() {
            document.getElementById('task-type-management-modal').style.display = 'none';
            hideAddTaskTypeForm();
        }

        function showAddTaskTypeForm() {
            document.getElementById('add-task-type-form').classList.remove('hidden');
        }

        function hideAddTaskTypeForm() {
            document.getElementById('add-task-type-form').classList.add('hidden');
            document.getElementById('new-task-type').value = '';
        }

        function addTaskType() {
            const taskType = document.getElementById('new-task-type').value.trim();
            
            if (!taskType) {
                alert('יש להזין שם סוג משימה');
                return;
            }
            
            if (taskTypes.includes(taskType)) {
                alert('סוג המשימה כבר קיים במערכת');
                return;
            }
            
            taskTypes.push(taskType);
            localStorage.setItem('taskManager_taskTypes', JSON.stringify(taskTypes));
            
            hideAddTaskTypeForm();
            displayTaskTypesList();
            populateTaskTypeSelects();
            
            showSuccessMessage(`✅ סוג המשימה "${taskType}" נוסף בהצלחה!`);
        }

        function displayTaskTypesList() {
            const container = document.getElementById('task-types-list');
            container.innerHTML = `
                <h3 style="margin-bottom: 15px;">סוגי משימות</h3>
                <div style="display: grid; gap: 10px;">
                    ${taskTypes.map(type => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e9ecef;">
                            <strong>${type}</strong>
                            <button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8rem;" onclick="removeTaskType('${type}')">מחק</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function removeTaskType(type) {
            if (confirm(`האם אתה בטוח שברצונך למחוק את סוג המשימה "${type}"?`)) {
                taskTypes = taskTypes.filter(t => t !== type);
                localStorage.setItem('taskManager_taskTypes', JSON.stringify(taskTypes));
                displayTaskTypesList();
                populateTaskTypeSelects();
                showSuccessMessage('🗑️ סוג המשימה נמחק בהצלחה!');
            }
        }

        function openReports() {
            alert('📊 תכונת דוחות ומעקב בפיתוח');
        }

        // סגירת מודאלים בלחיצה על הרקע
        ['edit-modal', 'user-management-modal', 'task-type-management-modal'].forEach(modalId => {
            document.getElementById(modalId).addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
        });

        // קיצורי מקלדת
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
            }
        });

        // הוספת אנימציית CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
