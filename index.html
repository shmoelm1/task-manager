<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניהול משימות RM-CPA</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; direction: rtl; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 20px 30px; margin-bottom: 20px; text-align: center; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { color: #2c3e50; font-size: 2em; background: linear-gradient(45deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .notification-bell { position: relative; cursor: pointer; font-size: 1.5em; color: #667eea; }
        .notification-count { position: absolute; top: -8px; right: -8px; background: #e74c3c; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.7em; display: flex; align-items: center; justify-content: center; }
        .auth-container, .main-app { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 40px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
        .hidden { display: none !important; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 15px; border: 2px solid #e1e8ed; border-radius: 10px; font-size: 16px; transition: all 0.3s ease; background: rgba(255, 255, 255, 0.9); }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .btn { background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s ease; margin: 5px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: linear-gradient(45deg, #95a5a6, #34495e); }
        .btn-danger { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .btn-success { background: linear-gradient(45deg, #27ae60, #2ecc71); }
        .nav-tabs { display: flex; background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 5px; margin-bottom: 30px; }
        .nav-tab { flex: 1; padding: 15px; text-align: center; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; color: #2c3e50; font-weight: 600; }
        .nav-tab.active { background: white; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
        .task-form-container { background: rgba(255, 255, 255, 0.9); border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .task-list { background: rgba(255, 255, 255, 0.9); border-radius: 15px; padding: 20px; margin-top: 20px; }
        .task-item { background: white; border: 1px solid #e1e8ed; border-radius: 10px; padding: 20px; margin-bottom: 15px; transition: all 0.3s ease; }
        .task-item:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .task-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .task-title { font-weight: bold; color: #2c3e50; font-size: 1.2em; flex: 1; }
        .task-status { padding: 6px 12px; border-radius: 20px; font-size: 0.8em; font-weight: bold; white-space: nowrap; margin-right: 10px; }
        .status-not-started { background: #95a5a6; color: white; }
        .status-in-progress { background: #3498db; color: white; }
        .status-waiting-client { background: #f39c12; color: white; }
        .status-partner-review { background: #9b59b6; color: white; }
        .status-completed { background: #27ae60; color: white; }
        .task-details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .task-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .filters { background: rgba(255, 255, 255, 0.9); padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        .filters-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end; }
        .success-message, .error-message { padding: 10px 15px; border-radius: 10px; margin: 10px 0; text-align: center; }
        .success-message { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error-message { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(45deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7)); padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); cursor: pointer; transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-number { font-size: 2em; font-weight: bold; color: #667eea; margin-bottom: 5px; }
        .autocomplete-container { position: relative; }
        .autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e1e8ed; border-radius: 10px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .autocomplete-item { padding: 10px 15px; cursor: pointer; transition: background 0.2s; }
        .autocomplete-item:hover { background: #f8f9fa; }
        @media (max-width: 768px) { .container { padding: 10px; } .header { flex-direction: column; text-align: center; gap: 15px; } .header h1 { font-size: 1.5em; } .nav-tabs { flex-direction: column; } .dashboard-stats { grid-template-columns: 1fr; } .form-row { grid-template-columns: 1fr; } .task-header { flex-direction: column; align-items: flex-start; gap: 10px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📋 מערכת ניהול משימות RM-CPA</h1>
            <div id="headerInfo" class="hidden">
                <div class="user-info">
                    <div>
                        <strong id="currentUserName"></strong>
                        <span id="currentUserRole"></span>
                    </div>
                    <button class="btn btn-secondary" onclick="logout()">התנתק</button>
                </div>
            </div>
        </div>

        <!-- מסך התחברות -->
        <div id="authScreen" class="auth-container">
            <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">כניסה למערכת</h2>
            <div class="form-group">
                <label>שם משתמש:</label>
                <input type="text" id="loginUsername" placeholder="הזן שם משתמש" value="shmuel">
            </div>
            <div class="form-group">
                <label>קוד גישה:</label>
                <input type="password" id="loginCode" placeholder="הזן קוד גישה" value="123456">
            </div>
            <button class="btn" onclick="login()">התחבר</button>
            <div id="authMessage"></div>
        </div>

        <!-- מסך עובד -->
        <div id="employeeApp" class="main-app hidden">
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="showEmployeeTab('create')">יצירת משימה</div>
                <div class="nav-tab" onclick="showEmployeeTab('my-tasks')">המשימות שלי</div>
            </div>

            <div id="employeeCreateTab" class="tab-content">
                <div class="task-form-container">
                    <h3 style="margin-bottom: 25px; color: #2c3e50;">משימה חדשה</h3>
                    <form id="employeeTaskForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>כותרת המשימה:</label>
                                <input type="text" id="empTaskTitle" required placeholder="תאר בקצרה את המשימה">
                            </div>
                            <div class="form-group">
                                <label>לקוח:</label>
                                <div class="autocomplete-container">
                                    <input type="text" id="empTaskClient" required placeholder="התחל להקליד שם לקוח..." oninput="filterClients(this.value, 'empClientList')">
                                    <div id="empClientList" class="autocomplete-list hidden"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>סוג עבודה:</label>
                                <select id="empTaskType" required>
                                    <option value="">בחר סוג עבודה</option>
                                    <option value="annual-company">דוח שנתי חברה</option>
                                    <option value="annual-personal">דוח שנתי אישי</option>
                                    <option value="estimate">משוער</option>
                                    <option value="ongoing">טיפול שוטף</option>
                                    <option value="fine-cancellation">ביטול קנסות</option>
                                    <option value="authority-contact">פניה לרשויות</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>תאריך יעד:</label>
                                <input type="date" id="empTaskDueDate" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>תיאור המשימה:</label>
                            <textarea id="empTaskDescription" rows="4" placeholder="פרט על המשימה, דרישות מיוחדות, מסמכים נדרשים וכו'"></textarea>
                        </div>

                        <div class="form-group">
                            <label>הערות ראשוניות:</label>
                            <textarea id="empTaskNotes" rows="3" placeholder="הערות, שאלות או מידע נוסף"></textarea>
                        </div>

                        <button type="submit" class="btn btn-success">צור משימה</button>
                        <button type="button" class="btn btn-secondary" onclick="clearEmployeeForm()">נקה טופס</button>
                    </form>
                </div>
            </div>

            <div id="employeeMyTasksTab" class="tab-content hidden">
                <div class="filters">
                    <h3 style="margin-bottom: 15px;">המשימות שלי</h3>
                    <div class="filters-row">
                        <div class="form-group">
                            <label>חיפוש:</label>
                            <input type="text" id="empSearchTasks" placeholder="חפש במשימות..." oninput="filterEmployeeTasks()">
                        </div>
                        <div class="form-group">
                            <label>סטטוס:</label>
                            <select id="empFilterStatus" onchange="filterEmployeeTasks()">
                                <option value="">כל הסטטוסים</option>
                                <option value="not-started">טרם התחיל</option>
                                <option value="in-progress">בעבודה</option>
                                <option value="waiting-client">מחכה לתגובה מהלקוח</option>
                                <option value="partner-review">הועבר לבדיקת שותף</option>
                                <option value="completed">הסתיים</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="task-list">
                    <div id="employeeTasksList"></div>
                </div>
            </div>
        </div>

        <!-- מסך שותף -->
        <div id="partnerApp" class="main-app hidden">
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="showPartnerTab('dashboard')">דשבורד</div>
                <div class="nav-tab" onclick="showPartnerTab('settings')">הגדרות</div>
            </div>

            <div id="partnerDashboardTab" class="tab-content">
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalTasks">0</div>
                        <div>סה"כ משימות</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeTasks">0</div>
                        <div>משימות פעילות</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completedTasks">0</div>
                        <div>משימות שהושלמו</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="overdueTasks">0</div>
                        <div>משימות באיחור</div>
                    </div>
                </div>

                <div class="filters">
                    <h3 style="margin-bottom: 15px;">כל המשימות</h3>
                    <div class="filters-row">
                        <div class="form-group">
                            <label>חיפוש:</label>
                            <input type="text" id="partnerSearchTasks" placeholder="חפש במשימות..." oninput="filterPartnerTasks()">
                        </div>
                        <div class="form-group">
                            <label>עובד מטפל:</label>
                            <select id="partnerFilterEmployee" onchange="filterPartnerTasks()">
                                <option value="">כל העובדים</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>סטטוס:</label>
                            <select id="partnerFilterStatus" onchange="filterPartnerTasks()">
                                <option value="">כל הסטטוסים</option>
                                <option value="not-started">טרם התחיל</option>
                                <option value="in-progress">בעבודה</option>
                                <option value="waiting-client">מחכה לתגובה מהלקוח</option>
                                <option value="partner-review">הועבר לבדיקת שותף</option>
                                <option value="completed">הסתיים</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="task-list">
                    <div id="partnerTasksList"></div>
                </div>
            </div>

            <div id="partnerSettingsTab" class="tab-content hidden">
                <h3>הגדרות מערכת</h3>
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="addUser()">הוסף משתמש</button>
                    <button class="btn btn-secondary" onclick="exportData()">יצוא נתונים</button>
                </div>
                <div id="usersList"></div>
            </div>
        </div>
    </div>

    <script>
        // משתנים גלובליים
        let currentUser = null;
        let users = [];
        let tasks = [];
        let clients = [];

        // נתונים ראשוניים
        function initializeData() {
            users = [
                { id: 1, username: 'shmuel', fullName: 'שמואל', role: 'partner', email: 'shmuel@rm-cpa.co.il', code: '123456' }
            ];

            clients = [
                { id: 1, name: 'חברת ABC בע"מ', contact: 'יוסי כהן', phone: '050-1234567' },
                { id: 2, name: 'משרד XYZ עו"ד', contact: 'שרה לוי', phone: '052-9876543' },
                { id: 3, name: 'עסק 123 השקעות', contact: 'דוד אברהם', phone: '054-5555555' }
            ];

            tasks = [];
        }

        // התחברות
        function login() {
            const username = document.getElementById('loginUsername').value;
            const code = document.getElementById('loginCode').value;
            
            if (!username || !code) {
                showMessage('authScreen', 'אנא הזן שם משתמש וקוד גישה', 'error');
                return;
            }

            const user = users.find(u => u.username === username && u.code === code);
            
            if (user) {
                currentUser = user;
                showMainApp();
            } else {
                showMessage('authScreen', 'שם משתמש או קוד גישה שגויים', 'error');
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('employeeApp').classList.add('hidden');
            document.getElementById('partnerApp').classList.add('hidden');
            document.getElementById('headerInfo').classList.add('hidden');
            document.getElementById('authScreen').classList.remove('hidden');
        }

        function showMainApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('headerInfo').classList.remove('hidden');
            
            document.getElementById('currentUserName').textContent = currentUser.fullName;
            document.getElementById('currentUserRole').textContent = `(${currentUser.role === 'partner' ? 'שותף' : 'עובד'})`;
            
            if (currentUser.role === 'employee') {
                document.getElementById('employeeApp').classList.remove('hidden');
                document.getElementById('partnerApp').classList.add('hidden');
                setTodayDate();
            } else {
                document.getElementById('partnerApp').classList.remove('hidden');
                document.getElementById('employeeApp').classList.add('hidden');
                updatePartnerStats();
                loadUsers();
            }
        }

        // פונקציות עובד
        function showEmployeeTab(tabName) {
            document.querySelectorAll('#employeeApp .tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            document.querySelectorAll('#employeeApp .nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            if (tabName === 'create') {
                document.getElementById('employeeCreateTab').classList.remove('hidden');
                event.target.classList.add('active');
            } else if (tabName === 'my-tasks') {
                document.getElementById('employeeMyTasksTab').classList.remove('hidden');
                event.target.classList.add('active');
                filterEmployeeTasks();
            }
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('empTaskDueDate').value = today;
        }

        document.getElementById('employeeTaskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const task = {
                id: Date.now(),
                title: document.getElementById('empTaskTitle').value,
                client: document.getElementById('empTaskClient').value,
                type: document.getElementById('empTaskType').value,
                dueDate: document.getElementById('empTaskDueDate').value,
                description: document.getElementById('empTaskDescription').value,
                notes: document.getElementById('empTaskNotes').value,
                status: 'not-started',
                assignedTo: currentUser.id,
                createdBy: currentUser.id,
                createdDate: new Date().toISOString()
            };

            tasks.push(task);
            clearEmployeeForm();
            showMessage('employeeCreateTab', 'המשימה נוצרה בהצלחה!', 'success');
        });

        function clearEmployeeForm() {
            document.getElementById('employeeTaskForm').reset();
            setTodayDate();
        }

        function filterClients(searchTerm, listId) {
            const list = document.getElementById(listId);
            
            if (!searchTerm || searchTerm.length < 2) {
                list.classList.add('hidden');
                return;
            }
            
            const filteredClients = clients.filter(client => 
                client.name.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            list.innerHTML = '';
            
            filteredClients.forEach(client => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.textContent = client.name;
                item.onclick = () => {
                    document.getElementById('empTaskClient').value = client.name;
                    list.classList.add('hidden');
                };
                list.appendChild(item);
            });
            
            list.classList.remove('hidden');
        }

        function filterEmployeeTasks() {
            const myTasks = tasks.filter(task => task.assignedTo === currentUser.id);
            const searchTerm = document.getElementById('empSearchTasks').value.toLowerCase();
            const statusFilter = document.getElementById('empFilterStatus').value;
            
            let filteredTasks = myTasks;
            
            if (searchTerm) {
                filteredTasks = filteredTasks.filter(task => 
                    task.title.toLowerCase().includes(searchTerm) ||
                    task.client.toLowerCase().includes(searchTerm)
                );
            }
            
            if (statusFilter) {
                filteredTasks = filteredTasks.filter(task => task.status === statusFilter);
            }
            
            displayTasks(filteredTasks, 'employeeTasksList', 'employee');
        }

        // פונקציות שותף
        function showPartnerTab(tabName) {
            document.querySelectorAll('#partnerApp .tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            document.querySelectorAll('#partnerApp .nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            if (tabName === 'dashboard') {
                document.getElementById('partnerDashboardTab').classList.remove('hidden');
                event.target.classList.add('active');
                filterPartnerTasks();
            } else if (tabName === 'settings') {
                document.getElementById('partnerSettingsTab').classList.remove('hidden');
                event.target.classList.add('active');
            }
        }

        function updatePartnerStats() {
            document.getElementById('totalTasks').textContent = tasks.length;
            document.getElementById('activeTasks').textContent = tasks.filter(t => t.status !== 'completed').length;
            document.getElementById('completedTasks').textContent = tasks.filter(t => t.status === 'completed').length;
            document.getElementById('overdueTasks').textContent = tasks.filter(t => 
                t.status !== 'completed' && new Date(t.dueDate) < new Date()
            ).length;
        }

        function filterPartnerTasks() {
            const searchTerm = document.getElementById('partnerSearchTasks').value.toLowerCase();
            const employeeFilter = document.getElementById('partnerFilterEmployee').value;
            const statusFilter = document.getElementById('partnerFilterStatus').value;
            
            let filteredTasks = [...tasks];
            
            if (searchTerm) {
                filteredTasks = filteredTasks.filter(task => 
                    task.title.toLowerCase().includes(searchTerm) ||
                    task.client.toLowerCase().includes(searchTerm)
                );
            }
            
            if (employeeFilter) {
                filteredTasks = filteredTasks.filter(task => task.assignedTo == employeeFilter);
            }
            
            if (statusFilter) {
                filteredTasks = filteredTasks.filter(task => task.status === statusFilter);
            }
            
            displayTasks(filteredTasks, 'partnerTasksList', 'partner');
            
            // עדכון סינון עובדים
            const select = document.getElementById('partnerFilterEmployee');
            select.innerHTML = '<option value="">כל העובדים</option>';
            users.filter(u => u.role === 'employee').forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = emp.fullName;
                select.appendChild(option);
            });
        }

        function displayTasks(tasksToDisplay, containerId, userType) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (tasksToDisplay.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 40px;">אין משימות להצגה</p>';
                return;
            }
            
            tasksToDisplay.forEach(task => {
                const assignedUser = users.find(u => u.id === task.assignedTo);
                const createdUser = users.find(u => u.id === task.createdBy);
                const isOverdue = task.status !== 'completed' && new Date(task.dueDate) < new Date();
                
                const taskDiv = document.createElement('div');
                taskDiv.className = 'task-item';
                if (isOverdue) taskDiv.style.borderLeft = '4px solid #e74c3c';
                
                taskDiv.innerHTML = `
                    <div class="task-header">
                        <div class="task-title">${task.title} ${isOverdue ? '⚠️' : ''}</div>
                        <div class="task-status status-${task.status}">${getStatusText(task.status)}</div>
                    </div>
                    <div class="task-details-grid">
                        <div><strong>לקוח:</strong> ${task.client}</div>
                        <div><strong>סוג עבודה:</strong> ${getTypeText(task.type)}</div>
                        <div><strong>תאריך יעד:</strong> ${formatDate(task.dueDate)}</div>
                        ${userType === 'partner' ? `<div><strong>עובד מטפל:</strong> ${assignedUser ? assignedUser.fullName : 'לא ידוע'}</div>` : ''}
                        <div>
                        <div><strong>נוצר על ידי:</strong> ${createdUser ? createdUser.fullName : 'לא ידוע'}</div>
                    </div>
                    ${task.description ? `<div style="margin-top: 10px;"><strong>תיאור:</strong> ${task.description}</div>` : ''}
                    ${task.notes ? `<div style="margin-top: 5px;"><strong>הערות:</strong> ${task.notes}</div>` : ''}
                    <div class="task-actions">
                        ${userType === 'employee' ? `
                            <button class="btn" onclick="updateTaskStatus(${task.id})">עדכן סטטוס</button>
                        ` : `
                            <button class="btn" onclick="editTask(${task.id})">עריכה</button>
                            <button class="btn btn-danger" onclick="deleteTask(${task.id})">מחק</button>
                        `}
                    </div>
                `;
                container.appendChild(taskDiv);
            });
        }

        function updateTaskStatus(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const statuses = [
                { value: 'not-started', text: 'טרם התחיל' },
                { value: 'in-progress', text: 'בעבודה' },
                { value: 'waiting-client', text: 'מחכה לתגובה מהלקוח' },
                { value: 'partner-review', text: 'הועבר לבדיקת שותף' },
                { value: 'completed', text: 'הסתיים' }
            ];
            
            const newStatus = prompt(`בחר סטטוס חדש:\n\n` + 
                statuses.map((s, i) => `${i + 1}. ${s.text}`).join('\n') + 
                `\n\nהזן מספר (1-5):`);
            
            if (newStatus && newStatus >= 1 && newStatus <= 5) {
                task.status = statuses[newStatus - 1].value;
                filterEmployeeTasks();
                showMessage('employeeMyTasksTab', 'הסטטוס עודכן בהצלחה', 'success');
            }
        }

        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const newTitle = prompt('כותרת חדשה:', task.title);
            if (newTitle) {
                task.title = newTitle;
                filterPartnerTasks();
                updatePartnerStats();
                showMessage('partnerDashboardTab', 'המשימה עודכנה בהצלחה', 'success');
            }
        }

        function deleteTask(taskId) {
            if (confirm('האם אתה בטוח שברצונך למחוק את המשימה?')) {
                tasks = tasks.filter(t => t.id !== taskId);
                filterPartnerTasks();
                updatePartnerStats();
                showMessage('partnerDashboardTab', 'המשימה נמחקה בהצלחה', 'success');
            }
        }

        // ניהול משתמשים
        function loadUsers() {
            const container = document.getElementById('usersList');
            container.innerHTML = '';
            
            users.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'task-item';
                userDiv.innerHTML = `
                    <div class="task-header">
                        <div class="task-title">${user.fullName}</div>
                        <div class="task-status ${user.role === 'partner' ? 'status-completed' : 'status-in-progress'}">
                            ${user.role === 'partner' ? 'שותף' : 'עובד'}
                        </div>
                    </div>
                    <div style="color: #7f8c8d; margin-bottom: 15px;">
                        <div><strong>שם משתמש:</strong> ${user.username}</div>
                        <div><strong>אימייל:</strong> ${user.email || 'לא הוגדר'}</div>
                    </div>
                    <div class="task-actions">
                        <button class="btn" onclick="editUser(${user.id})">עריכה</button>
                        ${user.id !== currentUser.id ? `<button class="btn btn-danger" onclick="deleteUser(${user.id})">מחיקה</button>` : ''}
                    </div>
                `;
                container.appendChild(userDiv);
            });
        }

        function addUser() {
            const fullName = prompt('שם מלא:');
            if (!fullName) return;
            
            const username = prompt('שם משתמש:');
            if (!username) return;
            
            const role = confirm('האם זה שותף? (ביטול = עובד)') ? 'partner' : 'employee';
            const email = prompt('אימייל (אופציונלי):') || '';
            const code = prompt('קוד גישה:');
            if (!code) return;
            
            if (users.some(u => u.username === username)) {
                alert('שם המשתמש כבר קיים');
                return;
            }
            
            users.push({
                id: Date.now(),
                fullName,
                username,
                role,
                email,
                code
            });
            
            loadUsers();
            showMessage('partnerSettingsTab', 'המשתמש נוסף בהצלחה', 'success');
        }

        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            const newName = prompt('שם מלא:', user.fullName);
            if (newName) {
                user.fullName = newName;
                loadUsers();
                showMessage('partnerSettingsTab', 'המשתמש עודכן בהצלחה', 'success');
            }
        }

        function deleteUser(userId) {
            if (confirm('האם אתה בטוח שברצונך למחוק את המשתמש?')) {
                users = users.filter(u => u.id !== userId);
                loadUsers();
                showMessage('partnerSettingsTab', 'המשתמש נמחק בהצלחה', 'success');
            }
        }

        function exportData() {
            const data = { users, tasks, clients, exportDate: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // פונקציות עזר
        function getStatusText(status) {
            const statusTexts = {
                'not-started': 'טרם התחיל',
                'in-progress': 'בעבודה',
                'waiting-client': 'מחכה לתגובה מהלקוח',
                'partner-review': 'הועבר לבדיקת שותף',
                'completed': 'הסתיים'
            };
            return statusTexts[status] || status;
        }

        function getTypeText(type) {
            const typeTexts = {
                'annual-company': 'דוח שנתי חברה',
                'annual-personal': 'דוח שנתי אישי',
                'estimate': 'משוער',
                'ongoing': 'טיפול שוטף',
                'fine-cancellation': 'ביטול קנסות',
                'authority-contact': 'פניה לרשויות'
            };
            return typeTexts[type] || type;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('he-IL');
        }

        function showMessage(containerId, message, type) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;
            
            container.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 3000);
        }

        // סגירת autocomplete
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.autocomplete-container')) {
                document.querySelectorAll('.autocomplete-list').forEach(list => {
                    list.classList.add('hidden');
                });
            }
        });

        // אתחול המערכת
        window.onload = function() {
            initializeData();
            
            // התחברות אוטומטית למשתמש שמואל
            currentUser = users.find(u => u.username === 'shmuel');
            if (currentUser) {
                showMainApp();
            }
        };

        // שמירה אוטומטית כל 30 שניות
        setInterval(() => {
            if (currentUser) {
                const data = { users, tasks, clients, lastSaved: new Date().toISOString() };
                localStorage.setItem('rmcpa-backup', JSON.stringify(data));
            }
        }, 30000);

        // שמירה לפני סגירת החלון
        window.addEventListener('beforeunload', function() {
            if (currentUser) {
                const data = { users, tasks, clients, lastSaved: new Date().toISOString() };
                localStorage.setItem('rmcpa-backup', JSON.stringify(data));
            }
        });

        // טעינת נתונים שמורים בעת הפעלה
        function loadSavedData() {
            const savedData = localStorage.getItem('rmcpa-backup');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    if (data.users) users = data.users;
                    if (data.tasks) tasks = data.tasks;
                    if (data.clients) clients = data.clients;
                    console.log('נתונים נטענו מהגיבוי המקומי');
                } catch (error) {
                    console.error('שגיאה בטעינת נתונים:', error);
                }
            }
        }

        // קריאה לטעינת נתונים שמורים
        loadSavedData();
    </script>
</body>
</html>
