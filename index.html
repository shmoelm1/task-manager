<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניהול משימות מתקדמת</title>
    
    <!-- קישור לקובץ CSS -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- אינדיקטור טעינה -->
    <div id="loadingIndicator" class="loading-indicator">
        <div class="spinner"></div>
        <p>טוען נתונים...</p>
    </div>

    <!-- הודעות מערכת -->
    <div id="notification" class="notification"></div>

    <!-- מסך הגדרה ראשונית -->
    <div id="setupScreen" class="screen active">
        <div class="setup-container">
            <div class="setup-card">
                <h1 class="setup-title">🎯 מערכת ניהול משימות מתקדמת</h1>
                <p class="setup-description">
                    ברוכים הבאים למערכת ניהול המשימות המתקדמת! 
                    המערכת עובדת עם Google Sheets לשמירה אמיתית של הנתונים בענן.
                </p>

                <div class="setup-step">
                    <h3>שלב 1: הגדרת Google Apps Script</h3>
                    <p>
                        יש צורך להגדיר Google Apps Script כדי לשמור את הנתונים ב-Google Sheets.
                        אם יש לך כבר URL של Apps Script, הזן אותו למטה.
                    </p>
                </div>

                <div class="apps-script-url">
                    <label>URL של Google Apps Script (אופציונלי):</label>
                    <input type="text" id="appsScriptUrl" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec">
                    <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        אם אין לך URL, המערכת תעבוד במצב מקומי עם שמירה בדפדפן
                    </p>
                </div>

                <div class="setup-step">
                    <h3>שלב 2: התחלת העבודה</h3>
                    <p>
                        ללא קשר להגדרת Apps Script, תוכל להתחיל לעבוד עם המערכת מיד.
                        הנתונים יישמרו בדפדפן ותוכל להוסיף שמירה בענן מאוחר יותר.
                    </p>
                </div>

                <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: center;">
                    <button onclick="startWithAppsScript()" class="btn-success">התחל עם Google Apps Script</button>
                    <button onclick="startLocalMode()" class="btn-primary">התחל במצב מקומי</button>
                </div>
            </div>
        </div>
    </div>

    <!-- מסך בחירת תפקיד -->
    <div id="roleSelectionScreen" class="screen">
        <div class="role-selection-container">
            <h1>🎯 ברוכים הבאים למערכת ניהול המשימות</h1>
            <p style="color: white; font-size: 1.2em; margin-bottom: 40px; text-align: center;">בחר את התפקיד שלך כדי להתחיל:</p>
            
            <div class="role-selection">
                <div class="role-card" onclick="selectRole('partner')">
                    <div class="role-icon">👨‍💼</div>
                    <div class="role-title">שותף / מנהל</div>
                    <div class="role-description">גישה מלאה לכל המשימות וניהול המערכת</div>
                    <ul class="role-features">
                        <li>✅ צפייה בכל המשימות</li>
                        <li>✅ דשבורד מנהלים</li>
                        <li>✅ ניהול משתמשים</li>
                        <li>✅ הגדרות מערכת</li>
                        <li>✅ סטטיסטיקות מפורטות</li>
                    </ul>
                    <button class="btn-primary">היכנס כמנהל</button>
                </div>

                <div class="role-card" onclick="selectRole('employee')">
                    <div class="role-icon">👨‍💻</div>
                    <div class="role-title">עובד</div>
                    <div class="role-description">גישה למשימות האישיות ועדכון סטטוס</div>
                    <ul class="role-features">
                        <li>✅ המשימות שלי</li>
                        <li>✅ עדכון סטטוס</li>
                        <li>✅ הוספת תגובות</li>
                        <li>✅ הוספת משימות</li>
                        <li>✅ סינון וחיפוש</li>
                    </ul>
                    <button class="btn-primary">היכנס כעובד</button>
                </div>
            </div>

            <div style="margin-top: 30px;">
                <button onclick="goBackToSetup()" class="btn-secondary">🔧 הגדרות מתקדמות</button>
            </div>
        </div>
    </div>

    <!-- מסך עובד -->
    <div id="employeeScreen" class="screen">
        <div class="header">
            <div class="header-content">
                <h1>🎯 המשימות שלי</h1>
                <div class="user-info">
                    <span id="currentUserName">עובד במערכת</span>
                    <button onclick="saveAllData()" class="btn-success">💾 שמור</button>
                    <button onclick="goBackToRoleSelection()" class="btn-secondary">החלף תפקיד</button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- סרגל פעולות -->
            <div class="action-bar">
                <button onclick="showAddTaskModal()" class="btn-primary">➕ הוסף משימה</button>
                <div class="filter-section">
                    <select id="statusFilter" onchange="filterTasks()">
                        <option value="">כל הסטטוסים</option>
                        <option value="טרם התחיל">טרם התחיל</option>
                        <option value="בביצוע">בביצוע</option>
                        <option value="הושלם">הושלם</option>
                        <option value="נדחה">נדחה</option>
                    </select>
                    <select id="priorityFilter" onchange="filterTasks()">
                        <option value="">כל העדיפויות</option>
                        <option value="גבוהה">גבוהה</option>
                        <option value="בינונית">בינונית</option>
                        <option value="נמוכה">נמוכה</option>
                    </select>
                </div>
            </div>

            <!-- רשימת משימות -->
            <div id="tasksList" class="tasks-container">
                <!-- המשימות יטענו כאן -->
            </div>
        </div>
    </div>

    <!-- מסך שותף -->
    <div id="partnerScreen" class="screen">
        <div class="header">
            <div class="header-content">
                <h1>📊 דשבורד ניהול</h1>
                <div class="user-info">
                    <span id="currentPartnerName">מנהל המערכת</span>
                    <button onclick="saveAllData()" class="btn-success">💾 שמור</button>
                    <button onclick="showAddTaskModal()" class="btn-primary">➕ הוסף משימה</button>
                    <button onclick="goBackToRoleSelection()" class="btn-secondary">החלף תפקיד</button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- סטטיסטיקות -->
            <div class="stats-section">
                <div class="stat-card">
                    <h3>סה"כ משימות</h3>
                    <div class="stat-number" id="totalTasks">0</div>
                </div>
                <div class="stat-card">
                    <h3>בביצוע</h3>
                    <div class="stat-number" id="inProgressTasks">0</div>
                </div>
                <div class="stat-card">
                    <h3>הושלמו</h3>
                    <div class="stat-number" id="completedTasks">0</div>
                </div>
                <div class="stat-card">
                    <h3>דחופות</h3>
                    <div class="stat-number" id="urgentTasks">0</div>
                </div>
            </div>

            <!-- סרגל פעולות -->
            <div class="action-bar">
                <div style="display: flex; gap: 15px;">
                    <button onclick="showAddTaskModal()" class="btn-primary">➕ הוסף משימה</button>
                    <button onclick="showSettings()" class="btn-secondary">⚙️ הגדרות</button>
                    <button onclick="syncClients()" class="btn-warning">🔄 סנכרן לקוחות</button>
                    <button onclick="createBackup()" class="btn-secondary">📋 גיבוי</button>
                </div>
                <div class="filter-section">
                    <select id="employeeFilter" onchange="filterAllTasks()">
                        <option value="">כל העובדים</option>
                    </select>
                    <select id="statusFilterPartner" onchange="filterAllTasks()">
                        <option value="">כל הסטטוסים</option>
                        <option value="טרם התחיל">טרם התחיל</option>
                        <option value="בביצוע">בביצוע</option>
                        <option value="הושלם">הושלם</option>
                        <option value="נדחה">נדחה</option>
                    </select>
                    <select id="priorityFilterPartner" onchange="filterAllTasks()">
                        <option value="">כל העדיפויות</option>
                        <option value="גבוהה">גבוהה</option>
                        <option value="בינונית">בינונית</option>
                        <option value="נמוכה">נמוכה</option>
                    </select>
                </div>
            </div>

            <!-- רשימת כל המשימות -->
            <div id="allTasksList" class="tasks-container">
                <!-- כל המשימות יטענו כאן -->
            </div>
        </div>
    </div>

    <!-- מסך הגדרות -->
    <div id="settingsScreen" class="screen">
        <div class="header">
            <div class="header-content">
                <h1>⚙️ הגדרות מערכת</h1>
                <button onclick="hideSettings()" class="btn-secondary">חזור</button>
            </div>
        </div>

        <div class="main-content">
            <div class="settings-tabs">
                <button onclick="showSettingsTab('clients')" class="tab-btn active">לקוחות</button>
                <button onclick="showSettingsTab('users')" class="tab-btn">משתמשים</button>
                <button onclick="showSettingsTab('taskTypes')" class="tab-btn">סוגי משימות</button>
                <button onclick="showSettingsTab('system')" class="tab-btn">מערכת</button>
            </div>

            <!-- לקוחות -->
            <div id="clientsTab" class="settings-tab active">
                <h2>ניהול לקוחות</h2>
                
                <div class="form-group">
                    <label>קובץ לקוחות מ-Google Drive:</label>
                    <input type="text" id="clientsSpreadsheetId" placeholder="הזן ID של הגיליון">
                    <p style="margin-top: 5px; font-size: 0.9em; color: #666;">
                        העתק את ה-ID מכתובת הגיליון: docs.google.com/spreadsheets/d/<strong>ID_כאן</strong>/edit
                    </p>
                </div>

                <div class="form-group">
                    <label>שם הגיליון:</label>
                    <input type="text" id="clientsSheetName" placeholder="Sheet1" value="Sheet1">
                </div>

                <div style="margin: 20px 0; display: flex; gap: 15px;">
                    <button onclick="testClientsConnection()" class="btn-secondary">🔍 בדוק חיבור</button>
                    <button onclick="saveClientsSettings()" class="btn-success">💾 שמור הגדרות</button>
                    <button onclick="syncClients()" class="btn-warning">🔄 סנכרן עכשיו</button>
                </div>

                <div class="info-message" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <p><strong>הוראות:</strong></p>
                    <p>1. פתח את קובץ הלקוחות ב-Google Drive</p>
                    <p>2. וודא שהקובץ זמין לצפייה ציבורית או שיתוף עם כל מי שיש לו את הקישור</p>
                    <p>3. העתק את ה-ID מהכתובת והדבק למעלה</p>
                    <p>4. הלקוחות יתסנכרנו אוטומטית פעם בשבוע</p>
                </div>

                <div>
                    <h3>סטטוס סנכרון:</h3>
                    <p>סנכרון אחרון: <span id="lastSyncDate">טרם בוצע</span></p>
                    <p>מספר לקוחות: <span id="clientsCount">0</span></p>
                </div>

                <div id="clientsList" style="margin-top: 20px;">
                    <!-- רשימת לקוחות -->
                </div>
            </div>

            <!-- משתמשים -->
            <div id="usersTab" class="settings-tab">
                <h2>ניהול משתמשים</h2>
                <button onclick="showAddUserModal()" class="btn-primary">➕ הוסף משתמש</button>
                <div id="usersList" class="users-list">
                    <!-- רשימת משתמשים -->
                </div>
            </div>

            <!-- סוגי משימות -->
            <div id="taskTypesTab" class="settings-tab">
                <h2>סוגי משימות</h2>
                <button onclick="showAddTaskTypeModal()" class="btn-primary">➕ הוסף סוג משימה</button>
                <div id="taskTypesList" class="task-types-list">
                    <!-- רשימת סוגי משימות -->
                </div>
            </div>

            <!-- מערכת -->
            <div id="systemTab" class="settings-tab">
                <h2>הגדרות מערכת</h2>
                
                <div class="form-group">
                    <label>URL של Google Apps Script:</label>
                    <input type="text" id="systemAppsScriptUrl" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec">
                    <p style="margin-top: 5px; font-size: 0.9em; color: #666;">
                        הזן את ה-URL של Google Apps Script לשמירה בענן
                    </p>
                </div>

                <div style="margin: 20px 0; display: flex; gap: 15px;">
                    <button onclick="testAppsScriptConnection()" class="btn-secondary">🔍 בדוק חיבור</button>
                    <button onclick="saveSystemSettings()" class="btn-success">💾 שמור הגדרות</button>
                </div>

                <div class="info-message" style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <p><strong>מצב נוכחי:</strong> <span id="currentMode">מקומי</span></p>
                    <p><strong>שמירה אוטומטית:</strong> <span id="autoSaveStatus">מופעלת</span></p>
                </div>

                <div>
                    <h3>פעולות מערכת:</h3>
                    <div style="display: flex; gap: 15px; margin: 15px 0; flex-wrap: wrap;">
                        <button onclick="exportData()" class="btn-secondary">📤 ייצוא נתונים</button>
                        <button onclick="importData()" class="btn-secondary">📥 ייבוא נתונים</button>
                        <button onclick="clearAllData()" class="btn-warning">🗑️ נקה נתונים</button>
                        <button onclick="createBackup()" class="btn-secondary">📋 יצירת גיבוי</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- כל המודלים כאן -->
    <!-- מודל הוספת משימה -->
    <div id="addTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>הוסף משימה חדשה</h2>
                <span class="close" onclick="hideAddTaskModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>לקוח:</label>
                    <div class="client-input-container">
                        <input type="text" id="clientInput" placeholder="חפש לקוח..." oninput="searchClients(this.value)">
                        <div id="clientSuggestions" class="suggestions-dropdown"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>שותף מטפל:</label>
                    <select id="assignedPartner">
                        <option value="מנהל המערכת">מנהל המערכת</option>
                        <option value="שותף 1">שותף 1</option>
                        <option value="שותף 2">שותף 2</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>עובד נוסף (אופציונלי):</label>
                    <select id="additionalEmployee">
                        <option value="">ללא</option>
                        <option value="עובד 1">עובד 1</option>
                        <option value="עובד 2">עובד 2</option>
                        <option value="עובד 3">עובד 3</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>סוג משימה:</label>
                    <select id="taskType">
                        <option value="פגישת ייעוץ">פגישת ייעוץ</option>
                        <option value="הכנת הצעת מחיר">הכנת הצעת מחיר</option>
                        <option value="מעקב הזמנה">מעקב הזמנה</option>
                        <option value="שירות לקוחות">שירות לקוחות</option>
                        <option value="תיקון תקלה">תיקון תקלה</option>
                        <option value="פיתוח מוצר">פיתוח מוצר</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>עדיפות:</label>
                    <select id="priority">
                        <option value="נמוכה">נמוכה</option>
                        <option value="בינונית" selected>בינונית</option>
                        <option value="גבוהה">גבוהה</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>תאריך יעד:</label>
                    <input type="date" id="dueDate" required>
                </div>
                <div class="form-group">
                    <label>הערות:</label>
                    <textarea id="notes" placeholder="הוסף הערות למשימה..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="addTask()" class="btn-primary">הוסף משימה</button>
                <button onclick="hideAddTaskModal()" class="btn-secondary">ביטול</button>
            </div>
        </div>
    </div>

    <!-- מודל עריכת משימה -->
    <div id="editTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ערוך משימה</h2>
                <span class="close" onclick="hideEditTaskModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>סטטוס:</label>
                    <select id="editStatus">
                        <option value="טרם התחיל">טרם התחיל</option>
                        <option value="בביצוע">בביצוע</option>
                        <option value="הושלם">הושלם</option>
                        <option value="נדחה">נדחה</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>הערות חדשות:</label>
                    <textarea id="editNotes" placeholder="הוסף הערות..."></textarea>
                </div>
                <div id="commentsSection">
                    <h3>תגובות:</h3>
                    <div id="commentsList"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="updateTask()" class="btn-primary">עדכן</button>
                <button onclick="addComment()" class="btn-secondary">הוסף תגובה</button>
                <button onclick="hideEditTaskModal()" class="btn-secondary">ביטול</button>
            </div>
        </div>
    </div>

    <!-- מודל הוספת משתמש -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>הוסף משתמש חדש</h2>
                <span class="close" onclick="hideAddUserModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>שם משתמש:</label>
                    <input type="text" id="newUsername" placeholder="הכנס שם משתמש">
                </div>
                <div class="form-group">
                    <label>סיסמה:</label>
                    <input type="password" id="newPassword" placeholder="הכנס סיסמה">
                </div>
                <div class="form-group">
                    <label>סוג משתמש:</label>
                    <select id="userType">
                        <option value="employee">עובד</option>
                        <option value="partner">שותף</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>שם מלא:</label>
                    <input type="text" id="fullName" placeholder="הכנס שם מלא">
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="addUser()" class="btn-primary">הוסף</button>
                <button onclick="hideAddUserModal()" class="btn-secondary">ביטול</button>
            </div>
        </div>
    </div>

    <!-- מודל הוספת סוג משימה -->
    <div id="addTaskTypeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>הוסף סוג משימה</h2>
                <span class="close" onclick="hideAddTaskTypeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>שם סוג המשימה:</label>
                    <input type="text" id="newTaskTypeName" placeholder="הכנס שם סוג משימה">
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="addTaskType()" class="btn-primary">הוסף</button>
                <button onclick="hideAddTaskTypeModal()" class="btn-secondary">ביטול</button>
            </div>
        </div>
    </div>

    <!-- קישור לקובץ JavaScript -->
    <script src="script.js"></script>
</body>
</html>
/* קובץ styles.css - עיצוב מערכת ניהול המשימות */

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    direction: rtl;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: #333;
}

/* === מסכים === */
.screen {
    display: none;
    min-height: 100vh;
}

.screen.active {
    display: block;
}

/* === מסך הגדרה ראשונית === */
.setup-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 20px;
}

.setup-card {
    background: white;
    padding: 40px;
    border-radius: 20px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.2);
    text-align: center;
    max-width: 600px;
    width: 100%;
}

.setup-title {
    font-size: 2.5em;
    color: #667eea;
    margin-bottom: 20px;
}

.setup-description {
    color: #666;
    line-height: 1.6;
    margin-bottom: 30px;
}

.setup-step {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    text-align: right;
}

.setup-step h3 {
    color: #667eea;
    margin-bottom: 10px;
}

.setup-step p {
    color: #555;
    line-height: 1.5;
}

.apps-script-url {
    background: #e3f2fd;
    padding: 15px;
    border-radius: 8px;
    border: 2px solid #2196f3;
    margin: 20px 0;
}

.apps-script-url input {
    width: 100%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
    text-align: left;
    direction: ltr;
}

.apps-script-url label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    color: #1976d2;
}

/* === מסך בחירת תפקיד === */
.role-selection-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 20px;
}

.role-selection-container h1 {
    color: white;
    margin-bottom: 30px;
    font-size: 2.5em;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    text-align: center;
}

.role-selection {
    display: flex;
    gap: 30px;
    flex-wrap: wrap;
    justify-content: center;
}

.role-card {
    background: white;
    padding: 40px;
    border-radius: 20px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.2);
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    min-width: 250px;
    border: 3px solid transparent;
}

.role-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    border-color: #667eea;
}

.role-icon {
    font-size: 4em;
    margin-bottom: 20px;
}

.role-title {
    font-size: 1.8em;
    font-weight: bold;
    color: #333;
    margin-bottom: 15px;
}

.role-description {
    color: #666;
    line-height: 1.5;
    margin-bottom: 20px;
}

.role-features {
    text-align: right;
    margin-bottom: 20px;
}

.role-features li {
    margin-bottom: 8px;
    color: #555;
}

/* === כפתורים === */
.btn-primary, .btn-secondary, .btn-success, .btn-warning {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: bold;
}

.btn-primary {
    background: linear-gradient(45deg, #667eea, #764ba2);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

.btn-secondary {
    background: #f8f9fa;
    color: #555;
    border: 2px solid #ddd;
}

.btn-secondary:hover {
    background: #e9ecef;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:hover {
    background: #218838;
}

.btn-warning {
    background: #ffc107;
    color: #212529;
}

.btn-warning:hover {
    background: #e0a800;
}

/* === כותרת === */
.header {
    background: white;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    padding: 20px 0;
}

.header-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 20px;
}

.header h1 {
    color: #333;
    font-size: 2em;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

.user-info span {
    font-weight: bold;
    color: #555;
}

/* === תוכן ראשי === */
.main-content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 30px 20px;
}

/* === סטטיסטיקות === */
.stats-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    text-align: center;
    transition: transform 0.3s;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-card h3 {
    color: #666;
    margin-bottom: 10px;
    font-size: 1.1em;
}

.stat-number {
    font-size: 2.5em;
    font-weight: bold;
    color: #667eea;
}

/* === סרגל פעולות === */
.action-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    background: white;
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.filter-section {
    display: flex;
    gap: 15px;
}

.filter-section select {
    padding: 10px 15px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
}

/* === מכולת משימות === */
.tasks-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
}

/* === כרטיס משימה === */
.task-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    transition: all 0.3s;
    cursor: pointer;
    border-right: 5px solid #ddd;
}

.task-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
}

.task-card.status-pending {
    border-right-color: #ffc107;
}

.task-card.status-progress {
    border-right-color: #17a2b8;
}

.task-card.status-completed {
    border-right-color: #28a745;
}

.task-card.status-delayed {
    border-right-color: #dc3545;
}

.task-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.task-client {
    font-size: 1.3em;
    font-weight: bold;
    color: #333;
}

.task-priority {
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: bold;
    color: white;
}

.priority-high {
    background: #dc3545;
}

.priority-medium {
    background: #ffc107;
}

.priority-low {
    background: #28a745;
}

.task-info {
    margin-bottom: 15px;
}

.task-info div {
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
}

.task-info label {
    font-weight: bold;
    color: #666;
}

.task-status {
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: bold;
    color: white;
    text-align: center;
}

.status-pending {
    background: #ffc107;
}

.status-progress {
    background: #17a2b8;
}

.status-completed {
    background: #28a745;
}

.status-delayed {
    background: #dc3545;
}

.task-notes {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-top: 15px;
    color: #666;
    font-style: italic;
}

.no-tasks {
    text-align: center;
    padding: 40px;
    color: #666;
    font-size: 1.2em;
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

/* === מודלים === */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: 15px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    color: #333;
    margin: 0;
}

.close {
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    color: #999;
}

.close:hover {
    color: #333;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    padding: 20px;
    border-top: 1px solid #ddd;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #555;
}

.form-group input, .form-group select, .form-group textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.3s;
}

.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    outline: none;
    border-color: #667eea;
}

textarea {
    resize: vertical;
    min-height: 80px;
}

/* === עיצוב מיוחד לכפתורי פעולה במשימות === */
.task-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #eee;
}

.task-actions button {
    flex: 1;
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
}

.btn-edit {
    background: #17a2b8;
    color: white;
}

.btn-edit:hover {
    background: #138496;
}

.btn-delete {
    background: #dc3545;
    color: white;
}

.btn-delete:hover {
    background: #c82333;
}

/* === חיפוש לקוחות === */
.client-input-container {
    position: relative;
}

.suggestions-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid #ddd;
    border-top: none;
    border-radius: 0 0 8px 8px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.suggestions-dropdown.active {
    display: block;
}

.suggestion-item {
    padding: 12px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.suggestion-item:hover {
    background: #f8f9fa;
}

.suggestion-item:last-child {
    border-bottom: none;
}

/* === הגדרות === */
.settings-tabs {
    display: flex;
    margin-bottom: 30px;
    background: white;
    border-radius: 15px;
    padding: 5px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.tab-btn {
    flex: 1;
    padding: 15px;
    border: none;
    background: transparent;
    cursor: pointer;
    border-radius: 10px;
    font-weight: bold;
    transition: all 0.3s;
}

.tab-btn.active {
    background: linear-gradient(45deg, #667eea, #764ba2);
    color: white;
}

.settings-tab {
    display: none;
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.settings-tab.active {
    display: block;
}

.settings-tab h2 {
    margin-bottom: 20px;
    color: #333;
}

.list-item {
    background: #f8f9fa;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.list-item-info {
    flex: 1;
}

.list-item-actions {
    display: flex;
    gap: 10px;
}

.btn-small {
    padding: 5px 10px;
    font-size: 12px;
    border-radius: 5px;
}

/* === אינדיקטור טעינה === */
.loading-indicator {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    z-index: 2000;
    text-align: center;
}

.loading-indicator.active {
    display: block;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* === הודעות מערכת === */
.notification {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 15px 25px;
    border-radius: 8px;
    color: white;
    font-weight: bold;
    z-index: 3000;
    display: none;
}

.notification.success {
    background: #28a745;
}

.notification.error {
    background: #dc3545;
}

.notification.warning {
    background: #ffc107;
    color: #212529;
}

.notification.active {
    display: block;
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        transform: translate(-50%, -100%);
        opacity: 0;
    }
    to {
        transform: translate(-50%, 0);
        opacity: 1;
    }
}

/* === אנימציות === */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.task-card {
    animation: fadeIn 0.5s ease-out;
}

.stat-card {
    animation: fadeIn 0.5s ease-out;
}

.role-card {
    animation: fadeIn 0.5s ease-out;
}

/* === עיצוב מיוחד למשימות דחופות === */
.task-card.urgent {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    50% {
        box-shadow: 0 5px 25px rgba(220, 53, 69, 0.3);
    }
    100% {
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
}

/* === עיצוב מיוחד לתאריכים שעברו === */
.task-card.overdue {
    border-right-color: #dc3545;
    background: linear-gradient(135deg, #fff 0%, #ffe6e6 100%);
}

.overdue .task-client {
    color: #dc3545;
}

/* === הודעות מידע === */
.info-message {
    background: #e3f2fd;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-right: 4px solid #2196f3;
}

/* === Responsive Design === */
@media (max-width: 768px) {
    .role-selection {
        flex-direction: column;
        align-items: center;
    }
    
    .role-card {
        min-width: 300px;
    }
    
    .action-bar {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
    }
    
    .filter-section {
        flex-direction: column;
    }
    
    .tasks-container {
        grid-template-columns: 1fr;
    }
    
    .stats-section {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .header-content {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
    
    .modal-content {
        width: 95%;
        margin: 10px;
    }
    
    .settings-tabs {
        flex-direction: column;
    }
}

@media (max-width: 480px) {
    .stats-section {
        grid-template-columns: 1fr;
    }
    
    .role-card {
        min-width: 250px;
        padding: 30px 20px;
    }
    
    .user-info {
        flex-direction: column;
        gap: 10px;
    }
    
    .setup-card {
        padding: 20px;
    }
    
    .task-card {
        padding: 15px;
    }
    
    .modal-footer {
        flex-direction: column;
    }
}

// קובץ script.js - לוגיקה של מערכת ניהול המשימות

// === משתנים גלובליים ===
let currentUser = null;
let allTasks = [];
let allClients = [];
let allUsers = [];
let allTaskTypes = [];
let currentEditingTask = null;
let appsScriptUrl = '';
let isCloudMode = false;

// === אתחול המערכת ===
document.addEventListener('DOMContentLoaded', function() {
    console.log('מערכת ניהול משימות מתקדמת מתחילה...');
    initializeSystem();
});

// אתחול מערכת
function initializeSystem() {
    // בדיקה אם יש URL של Apps Script שמור
    const savedUrl = localStorage.getItem('appsScriptUrl');
    if (savedUrl) {
        appsScriptUrl = savedUrl;
        document.getElementById('appsScriptUrl').value = savedUrl;
        document.getElementById('systemAppsScriptUrl').value = savedUrl;
        isCloudMode = true;
    }

    // טעינת הגדרות לקוחות
    const clientsSettings = JSON.parse(localStorage.getItem('clientsSettings') || '{}');
    if (clientsSettings.spreadsheetId) {
        document.getElementById('clientsSpreadsheetId').value = clientsSettings.spreadsheetId;
        document.getElementById('clientsSheetName').value = clientsSettings.sheetName || 'Sheet1';
    }

    // אתחול נתונים ברירת מחדל
    initializeDefaultData();
}

// === פונקציות הגדרה ראשונית ===

// התחלה עם Google Apps Script
function startWithAppsScript() {
    const url = document.getElementById('appsScriptUrl').value.trim();
    if (url) {
        appsScriptUrl = url;
        localStorage.setItem('appsScriptUrl', url);
        isCloudMode = true;
        showNotification('מחובר ל-Google Apps Script!', 'success');
    } else {
        showNotification('נא להזין URL של Google Apps Script', 'warning');
        return;
    }
    
    hideAllScreens();
    document.getElementById('roleSelectionScreen').classList.add('active');
}

// התחלה במצב מקומי
function startLocalMode() {
    isCloudMode = false;
    hideAllScreens();
    document.getElementById('roleSelectionScreen').classList.add('active');
}

// חזרה להגדרה
function goBackToSetup() {
    hideAllScreens();
    document.getElementById('setupScreen').classList.add('active');
}

// אתחול נתונים ברירת מחדל
function initializeDefaultData() {
    // משימות לדוגמה
    if (!localStorage.getItem('tasks')) {
        const sampleTasks = [
            {
                id: 1,
                client: 'חברת אבג בע"מ',
                assignedPartner: 'מנהל המערכת',
                additionalEmployee: 'עובד 1',
                taskType: 'פגישת ייעוץ',
                status: 'בביצוע',
                priority: 'גבוהה',
                dueDate: '2024-12-25',
                notes: 'פגישה חשובה עם הלקוח לגבי הפרויקט החדש',
                createdBy: 'מנהל המערכת',
                createdDate: '2024-12-15',
                comments: []
            },
            {
                id: 2,
                client: 'מטרו סופר',
                assignedPartner: 'שותף 1',
                additionalEmployee: '',
                taskType: 'הכנת הצעת מחיר',
                status: 'טרם התחיל',
                priority: 'בינונית',
                dueDate: '2024-12-30',
                notes: 'הצעת מחיר למערכת קופות חדשה',
                createdBy: 'שותף 1',
                createdDate: '2024-12-14',
                comments: []
            }
        ];
        localStorage.setItem('tasks', JSON.stringify(sampleTasks));
    }

    // לקוחות לדוגמה
    if (!localStorage.getItem('clients')) {
        const sampleClients = [
            { name: 'חברת אבג בע"מ', details: 'חברת הייטק מובילה' },
            { name: 'מטרו סופר', details: 'רשת סופרמרקטים' },
            { name: 'רשת פיצוחיה', details: 'רשת מזון מהיר' },
            { name: 'בנק הדוגמה', details: 'מוסד פיננסי' }
        ];
        localStorage.setItem('clients', JSON.stringify(sampleClients));
    }

    // משתמשים לדוגמה
    if (!localStorage.getItem('users')) {
        const sampleUsers = [
            {
                id: 1,
                username: 'admin',
                password: 'admin123',
                type: 'partner',
                fullName: 'מנהל המערכת'
            },
            {
                id: 2,
                username: 'employee1',
                password: 'emp123',
                type: 'employee',
                fullName: 'עובד לדוגמה'
            }
        ];
        localStorage.setItem('users', JSON.stringify(sampleUsers));
    }

    // סוגי משימות לדוגמה
    if (!localStorage.getItem('taskTypes')) {
        const sampleTaskTypes = [
            'פגישת ייעוץ',
            'הכנת הצעת מחיר',
            'מעקב הזמנה',
            'שירות לקוחות',
            'תיקון תקלה',
            'פיתוח מוצר'
        ];
        localStorage.setItem('taskTypes', JSON.stringify(sampleTaskTypes));
    }

    // טעינת נתונים לזיכרון
    loadAllData();
}

// === פונקציות טעינה ושמירה ===

// טעינת כל הנתונים
async function loadAllData() {
    showLoading();
    try {
        if (isCloudMode && appsScriptUrl) {
            await loadDataFromCloud();
        } else {
            loadDataFromLocal();
        }
        updateUI();
    } catch (error) {
        console.error('שגיאה בטעינת נתונים:', error);
        showNotification('שגיאה בטעינת נתונים, עובר למצב מקומי', 'warning');
        loadDataFromLocal();
        updateUI();
    } finally {
        hideLoading();
    }
}

// טעינת נתונים מהענן
async function loadDataFromCloud() {
    const requests = [
        fetch(appsScriptUrl + '?action=getTasks'),
        fetch(appsScriptUrl + '?action=getUsers'),
        fetch(appsScriptUrl + '?action=getTaskTypes'),
        fetch(appsScriptUrl + '?action=getClients')
    ];

    const responses = await Promise.all(requests);
    const data = await Promise.all(responses.map(r => r.json()));

    allTasks = data[0] || [];
    allUsers = data[1] || [];
    allTaskTypes = data[2] || [];
    allClients = data[3] || [];

    // שמירה מקומית כגיבוי
    localStorage.setItem('tasks', JSON.stringify(allTasks));
    localStorage.setItem('users', JSON.stringify(allUsers));
    localStorage.setItem('taskTypes', JSON.stringify(allTaskTypes));
    localStorage.setItem('clients', JSON.stringify(allClients));
}

// טעינת נתונים מקומיים
function loadDataFromLocal() {
    allTasks = JSON.parse(localStorage.getItem('tasks') || '[]');
    allUsers = JSON.parse(localStorage.getItem('users') || '[]');
    allTaskTypes = JSON.parse(localStorage.getItem('taskTypes') || '[]');
    allClients = JSON.parse(localStorage.getItem('clients') || '[]');
}

// שמירת כל הנתונים
async function saveAllData() {
    showLoading();
    try {
        if (isCloudMode && appsScriptUrl) {
            await saveDataToCloud();
            showNotification('נתונים נשמרו בענן בהצלחה!', 'success');
        } else {
            saveDataToLocal();
            showNotification('נתונים נשמרו מקומית בהצלחה!', 'success');
        }
    } catch (error) {
        console.error('שגיאה בשמירת נתונים:', error);
        saveDataToLocal();
        showNotification('שגיאה בשמירה בענן, נשמר מקומית', 'warning');
    } finally {
        hideLoading();
    }
}
// שמירת נתונים בענן
async function saveDataToCloud() {
    const requests = [
        fetch(appsScriptUrl, {
            method: 'POST',
            body: JSON.stringify({ action: 'saveTasks', tasks: allTasks })
        }),
        fetch(appsScriptUrl, {
            method: 'POST',
            body: JSON.stringify({ action: 'saveUsers', users: allUsers })
        }),
        fetch(appsScriptUrl, {
            method: 'POST',
            body: JSON.stringify({ action: 'saveTaskTypes', taskTypes: allTaskTypes })
        })
    ];

    await Promise.all(requests);
    
    // שמירה מקומית כגיבוי
    saveDataToLocal();
}

// שמירת נתונים מקומיים
function saveDataToLocal() {
    localStorage.setItem('tasks', JSON.stringify(allTasks));
    localStorage.setItem('users', JSON.stringify(allUsers));
    localStorage.setItem('taskTypes', JSON.stringify(allTaskTypes));
    localStorage.setItem('clients', JSON.stringify(allClients));
}

// === פונקציות ממשק משתמש ===

// עדכון ממשק המשתמש
function updateUI() {
    if (currentUser) {
        if (currentUser.type === 'partner') {
            updateStatistics();
            displayAllTasks();
        } else {
            displayEmployeeTasks();
        }
    }
}

// בחירת תפקיד
function selectRole(role) {
    if (role === 'partner') {
        currentUser = {
            id: 1,
            username: 'admin',
            type: 'partner',
            fullName: 'מנהל המערכת'
        };
        showPartnerScreen();
    } else {
        currentUser = {
            id: 2,
            username: 'employee',
            type: 'employee',
            fullName: 'עובד במערכת'
        };
        showEmployeeScreen();
    }
}

// הצגת מסך שותף
function showPartnerScreen() {
    hideAllScreens();
    document.getElementById('partnerScreen').classList.add('active');
    document.getElementById('currentPartnerName').textContent = currentUser.fullName;
    loadPartnerDashboard();
}

// הצגת מסך עובד
function showEmployeeScreen() {
    hideAllScreens();
    document.getElementById('employeeScreen').classList.add('active');
    document.getElementById('currentUserName').textContent = currentUser.fullName;
    loadEmployeeTasks();
}

// חזרה לבחירת תפקיד
function goBackToRoleSelection() {
    currentUser = null;
    hideAllScreens();
    document.getElementById('roleSelectionScreen').classList.add('active');
}

// הסתרת כל המסכים
function hideAllScreens() {
    document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
    });
}

// טעינת דשבורד שותף
function loadPartnerDashboard() {
    updateStatistics();
    displayAllTasks();
}

// טעינת משימות עובד
function loadEmployeeTasks() {
    displayEmployeeTasks();
}

// === פונקציות סטטיסטיקות ותצוגה ===

// עדכון סטטיסטיקות
function updateStatistics() {
    const total = allTasks.length;
    const inProgress = allTasks.filter(t => t.status === 'בביצוע').length;
    const completed = allTasks.filter(t => t.status === 'הושלם').length;
    const urgent = allTasks.filter(t => t.priority === 'גבוהה' && t.status !== 'הושלם').length;
    
    document.getElementById('totalTasks').textContent = total;
    document.getElementById('inProgressTasks').textContent = inProgress;
    document.getElementById('completedTasks').textContent = completed;
    document.getElementById('urgentTasks').textContent = urgent;
}

// הצגת כל המשימות (שותף)
function displayAllTasks() {
    const container = document.getElementById('allTasksList');
    container.innerHTML = '';
    
    if (allTasks.length === 0) {
        container.innerHTML = '<div class="no-tasks">אין משימות במערכת</div>';
        return;
    }
    
    allTasks.forEach(task => {
        const taskCard = createTaskCard(task, true);
        container.appendChild(taskCard);
    });
}

// הצגת משימות עובד
function displayEmployeeTasks() {
    const container = document.getElementById('tasksList');
    container.innerHTML = '';
    
    const userTasks = allTasks.filter(task => 
        task.assignedPartner === currentUser.fullName || 
        task.additionalEmployee === currentUser.fullName ||
        task.createdBy === currentUser.fullName
    );
    
    if (userTasks.length === 0) {
        container.innerHTML = '<div class="no-tasks">אין לך משימות כרגע</div>';
        return;
    }
    
    userTasks.forEach(task => {
        const taskCard = createTaskCard(task, false);
        container.appendChild(taskCard);
    });
}

// יצירת כרטיס משימה
function createTaskCard(task, isPartnerView) {
    const card = document.createElement('div');
    card.className = `task-card status-${getStatusClass(task.status)}`;
    
    const today = new Date();
    const dueDate = new Date(task.dueDate);
    const isOverdue = dueDate < today && task.status !== 'הושלם';
    
    if (isOverdue) {
        card.classList.add('overdue');
    }
    
    if (task.priority === 'גבוהה') {
        card.classList.add('urgent');
    }
    
    card.innerHTML = `
        <div class="task-header">
            <div class="task-client">${task.client}</div>
            <span class="task-priority priority-${getPriorityClass(task.priority)}">${task.priority}</span>
        </div>
        
        <div class="task-info">
            <div>
                <label>סוג משימה:</label>
                <span>${task.taskType}</span>
            </div>
            <div>
                <label>סטטוס:</label>
                <span class="task-status status-${getStatusClass(task.status)}">${task.status}</span>
            </div>
            <div>
                <label>שותף מטפל:</label>
                <span>${task.assignedPartner}</span>
            </div>
            ${task.additionalEmployee ? `
            <div>
                <label>עובד נוסף:</label>
                <span>${task.additionalEmployee}</span>
            </div>
            ` : ''}
            <div>
                <label>תאריך יעד:</label>
                <span${isOverdue ? ' style="color: #dc3545; font-weight: bold;"' : ''}>${formatDate(task.dueDate)}</span>
            </div>
            <div>
                <label>נוצר על ידי:</label>
                <span>${task.createdBy}</span>
            </div>
        </div>
        
        ${task.notes ? `<div class="task-notes">${task.notes}</div>` : ''}
        
        <div class="task-actions">
            <button class="btn-edit" onclick="editTask(${task.id})">ערוך</button>
            ${isPartnerView ? `<button class="btn-delete" onclick="deleteTask(${task.id})">מחק</button>` : ''}
        </div>
    `;
    
    return card;
}

// === פונקציות עזר ===

// פונקציות עזר לעיצוב
function getStatusClass(status) {
    const statusMap = {
        'טרם התחיל': 'pending',
        'בביצוע': 'progress',
        'הושלם': 'completed',
        'נדחה': 'delayed'
    };
    return statusMap[status] || 'pending';
}

function getPriorityClass(priority) {
    const priorityMap = {
        'גבוהה': 'high',
        'בינונית': 'medium',
        'נמוכה': 'low'
    };
    return priorityMap[priority] || 'medium';
}

function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('he-IL');
}

// === פונקציות משימות ===

// הצגת מודל הוספת משימה
function showAddTaskModal() {
    document.getElementById('addTaskModal').classList.add('active');
    
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('dueDate').value = tomorrow.toISOString().split('T')[0];
}

// הסתרת מודל הוספת משימה
function hideAddTaskModal() {
    document.getElementById('addTaskModal').classList.remove('active');
    clearAddTaskForm();
}

// ניקוי טופס הוספת משימה
function clearAddTaskForm() {
    document.getElementById('clientInput').value = '';
    document.getElementById('assignedPartner').selectedIndex = 0;
    document.getElementById('additionalEmployee').selectedIndex = 0;
    document.getElementById('taskType').selectedIndex = 0;
    document.getElementById('priority').selectedIndex = 1;
    document.getElementById('dueDate').value = '';
    document.getElementById('notes').value = '';
    document.getElementById('clientSuggestions').classList.remove('active');
}

// חיפוש לקוחות
function searchClients(query) {
    const suggestions = document.getElementById('clientSuggestions');
    
    if (!query.trim()) {
        suggestions.classList.remove('active');
        return;
    }
    
    const matches = allClients.filter(client => 
        client.name.toLowerCase().includes(query.toLowerCase())
    ).slice(0, 10);
    
    if (matches.length === 0) {
        suggestions.classList.remove('active');
        return;
    }
    
    suggestions.innerHTML = '';
    matches.forEach(client => {
        const item = document.createElement('div');
        item.className = 'suggestion-item';
        item.textContent = client.name;
        item.onclick = () => selectClient(client.name);
        suggestions.appendChild(item);
    });
    
    suggestions.classList.add('active');
}

// בחירת לקוח
function selectClient(clientName) {
    document.getElementById('clientInput').value = clientName;
    document.getElementById('clientSuggestions').classList.remove('active');
}

// הוספת משימה
async function addTask() {
    const client = document.getElementById('clientInput').value.trim();
    const assignedPartner = document.getElementById('assignedPartner').value;
    const additionalEmployee = document.getElementById('additionalEmployee').value;
    const taskType = document.getElementById('taskType').value;
    const priority = document.getElementById('priority').value;
    const dueDate = document.getElementById('dueDate').value;
    const notes = document.getElementById('notes').value.trim();
    
    if (!client || !assignedPartner || !taskType || !dueDate) {
        showNotification('נא למלא את כל השדות החובה', 'warning');
        return;
    }
    
    const newTask = {
        id: allTasks.length > 0 ? Math.max(...allTasks.map(t => t.id)) + 1 : 1,
        client,
        assignedPartner,
        additionalEmployee,
        taskType,
        status: 'טרם התחיל',
        priority,
        dueDate,
        notes,
        createdBy: currentUser.fullName,
        createdDate: new Date().toISOString().split('T')[0],
        comments: []
    };
    
    allTasks.push(newTask);
    
    // שמירה אוטומטית
    await saveAllData();
    
    if (currentUser.type === 'partner') {
        updateStatistics();
        displayAllTasks();
    } else {
        displayEmployeeTasks();
    }
    
    hideAddTaskModal();
    showNotification('המשימה נוספה בהצלחה!', 'success');
}

// עריכת משימה
function editTask(taskId) {
    const task = allTasks.find(t => t.id === taskId);
    if (!task) return;
    
    currentEditingTask = task;
    
    document.getElementById('editStatus').value = task.status;
    document.getElementById('editNotes').value = '';
    
    displayComments(task.comments || []);
    document.getElementById('editTaskModal').classList.add('active');
}

// הצגת תגובות
function displayComments(comments) {
    const commentsList = document.getElementById('commentsList');
    commentsList.innerHTML = '';
    
    if (comments.length === 0) {
        commentsList.innerHTML = '<p>אין תגובות עדיין</p>';
        return;
    }
    
    comments.forEach(comment => {
        const commentDiv = document.createElement('div');
        commentDiv.innerHTML = `
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-right: 3px solid #667eea;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span style="font-weight: bold; color: #667eea;">${comment.author}</span>
                    <span style="color: #999; font-size: 0.9em;">${formatDate(comment.date)}</span>
                </div>
                <div style="color: #555; line-height: 1.5;">${comment.text}</div>
            </div>
        `;
        commentsList.appendChild(commentDiv);
    });
}

// עדכון משימה
async function updateTask() {
    if (!currentEditingTask) return;
    
    const newStatus = document.getElementById('editStatus').value;
    const newNotes = document.getElementById('editNotes').value.trim();
    
    currentEditingTask.status = newStatus;
    
    if (newNotes) {
        if (!currentEditingTask.notes) {
            currentEditingTask.notes = newNotes;
        } else {
            currentEditingTask.notes += '\n---\n' + newNotes;
        }
    }
    
    await saveAllData();
    
    if (currentUser.type === 'partner') {
        updateStatistics();
        displayAllTasks();
    } else {
        displayEmployeeTasks();
    }
    
    hideEditTaskModal();
    showNotification('המשימה עודכנה בהצלחה!', 'success');
}

// הוספת תגובה
async function addComment() {
    if (!currentEditingTask) return;
    
    const commentText = document.getElementById('editNotes').value.trim();
    
    if (!commentText) {
        showNotification('נא להזין תוכן לתגובה', 'warning');
        return;
    }
    
    const newComment = {
        id: Date.now(),
        author: currentUser.fullName,
        text: commentText,
        date: new Date().toISOString().split('T')[0]
    };
    
    if (!currentEditingTask.comments) {
        currentEditingTask.comments = [];
    }
    currentEditingTask.comments.push(newComment);
    
    displayComments(currentEditingTask.comments);
    document.getElementById('editNotes').value = '';
    
    await saveAllData();
    showNotification('התגובה נוספה בהצלחה!', 'success');
}

// הסתרת מודל עריכת משימה
function hideEditTaskModal() {
    document.getElementById('editTaskModal').classList.remove('active');
    currentEditingTask = null;
}

// מחיקת משימה
async function deleteTask(taskId) {
    if (!confirm('האם אתה בטוח שברצונך למחוק את המשימה?')) {
        return;
    }
    
    allTasks = allTasks.filter(t => t.id !== taskId);
    
    await saveAllData();
    
    if (currentUser.type === 'partner') {
        updateStatistics();
        displayAllTasks();
    } else {
        displayEmployeeTasks();
    }
    
    showNotification('המשימה נמחקה בהצלחה!', 'success');
}

// === פונקציות סינון ===

// סינון משימות עובד
function filterTasks() {
    const statusFilter = document.getElementById('statusFilter').value;
    const priorityFilter = document.getElementById('priorityFilter').value;
    
    const userTasks = allTasks.filter(task => {
        const isUserTask = task.assignedPartner === currentUser.fullName || 
                          task.additionalEmployee === currentUser.fullName ||
                          task.createdBy === currentUser.fullName;
        
        const statusMatch = !statusFilter || task.status === statusFilter;
        const priorityMatch = !priorityFilter || task.priority === priorityFilter;
        
        return isUserTask && statusMatch && priorityMatch;
    });
    
    displayFilteredTasks(userTasks, 'tasksList');
}

// סינון כל המשימות (שותף)
function filterAllTasks() {
    const employeeFilter = document.getElementById('employeeFilter').value;
    const statusFilter = document.getElementById('statusFilterPartner').value;
    const priorityFilter = document.getElementById('priorityFilterPartner').value;
    
    const filteredTasks = allTasks.filter(task => {
        const employeeMatch = !employeeFilter || 
                             task.assignedPartner === employeeFilter || 
                             task.additionalEmployee === employeeFilter;
        
        const statusMatch = !statusFilter || task.status === statusFilter;
        const priorityMatch = !priorityFilter || task.priority === priorityFilter;
        
        return employeeMatch && statusMatch && priorityMatch;
    });
    
    displayFilteredTasks(filteredTasks, 'allTasksList');
}

// הצגת משימות מסוננות
function displayFilteredTasks(tasks, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    
    if (tasks.length === 0) {
        container.innerHTML = '<div class="no-tasks">לא נמצאו משימות התואמות לסינון</div>';
        return;
    }
    
    const isPartnerView = containerId === 'allTasksList';
    
    tasks.forEach(task => {
        const taskCard = createTaskCard(task, isPartnerView);
        container.appendChild(taskCard);
    });
}

// === פונקציות הגדרות ===

// הגדרות
function showSettings() {
    hideAllScreens();
    document.getElementById('settingsScreen').classList.add('active');
    loadSettingsData();
}

function hideSettings() {
    hideAllScreens();
    document.getElementById('partnerScreen').classList.add('active');
}

function loadSettingsData() {
    // עדכון מצב נוכחי
    document.getElementById('currentMode').textContent = isCloudMode ? 'ענן (Google Apps Script)' : 'מקומי';
    document.getElementById('autoSaveStatus').textContent = 'מופעלת';
    
    // עדכון מספר לקוחות
    document.getElementById('clientsCount').textContent = allClients.length;
    
    // הצגת תאריך סנכרון אחרון
    const lastSync = localStorage.getItem('lastClientSync');
    if (lastSync) {
        document.getElementById('lastSyncDate').textContent = formatDate(lastSync);
    }
    
    displayClientsInSettings();
}

function displayClientsInSettings() {
    const container = document.getElementById('clientsList');
    container.innerHTML = '';
    
    allClients.slice(0, 20).forEach(client => {
        const clientDiv = document.createElement('div');
        clientDiv.className = 'list-item';
        clientDiv.innerHTML = `
            <div class="list-item-info">
                <strong>${client.name}</strong>
                ${client.details ? `<br><small>${client.details}</small>` : ''}
            </div>
        `;
        container.appendChild(clientDiv);
    });
    
    if (allClients.length > 20) {
        const moreDiv = document.createElement('div');
        moreDiv.className = 'list-item';
        moreDiv.innerHTML = `<div class="list-item-info">ועוד ${allClients.length - 20} לקוחות...</div>`;
        container.appendChild(moreDiv);
    }
}

// הצגת טאבים בהגדרות
function showSettingsTab(tabName) {
    document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    document.getElementById(tabName + 'Tab').classList.add('active');
    event.target.classList.add('active');
}

// === פונקציות לקוחות ===

// בדיקת חיבור לקוחות
async function testClientsConnection() {
    const spreadsheetId = document.getElementById('clientsSpreadsheetId').value.trim();
    const sheetName = document.getElementById('clientsSheetName').value.trim() || 'Sheet1';
    
    if (!spreadsheetId) {
        showNotification('נא להזין ID של הגיליון', 'warning');
        return;
    }
    
    showLoading();
    try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${sheetName}!A:B?key=AIzaSyDR6k3fBY1aZXW_UhVoCC2N34nKpVDX3vo`;
        const response = await fetch(url);
        
        if (response.ok) {
            const data = await response.json();
            const rowCount = data.values ? data.values.length - 1 : 0;
            showNotification(`חיבור תקין! נמצאו ${rowCount} לקוחות`, 'success');
        } else {
            showNotification('שגיאה בחיבור לגיליון - בדוק את ה-ID וההרשאות', 'error');
        }
    } catch (error) {
        showNotification('שגיאה בחיבור לגיליון', 'error');
    } finally {
        hideLoading();
    }
}

// שמירת הגדרות לקוחות
function saveClientsSettings() {
    const spreadsheetId = document.getElementById('clientsSpreadsheetId').value.trim();
    const sheetName = document.getElementById('clientsSheetName').value.trim() || 'Sheet1';
    
    const settings = {
        spreadsheetId,
        sheetName,
        savedAt: new Date().toISOString()
    };
    
    localStorage.setItem('clientsSettings', JSON.stringify(settings));
    showNotification('הגדרות לקוחות נשמרו בהצלחה!', 'success');
}

// סנכרון לקוחות
async function syncClients() {
    const clientsSettings = JSON.parse(localStorage.getItem('clientsSettings') || '{}');
    const spreadsheetId = clientsSettings.spreadsheetId || document.getElementById('clientsSpreadsheetId').value.trim();
    const sheetName = clientsSettings.sheetName || 'Sheet1';
    
    if (!spreadsheetId) {
        showNotification('נא להגדיר קובץ לקוחות בהגדרות', 'warning');
        return;
    }
    
    showLoading();
    try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${sheetName}!A:B?key=AIzaSyDR6k3fBY1aZXW_UhVoCC2N34nKpVDX3vo`;
        const response = await fetch(url);
        
        if (response.ok) {
            const data = await response.json();
            if (data.values && data.values.length > 1) {
                allClients = data.values.slice(1).map(row => ({
                    name: row[0] || '',
                    details: row[1] || ''
                })).filter(client => client.name.trim());
                
                localStorage.setItem('clients', JSON.stringify(allClients));
                localStorage.setItem('lastClientSync', new Date().toISOString());
                
                showNotification(`סנכרון הושלם! נטענו ${allClients.length} לקוחות`, 'success');
                
                // עדכון התצוגה
                if (document.getElementById('settingsScreen').classList.contains('active')) {
                    loadSettingsData();
                }
            } else {
                showNotification('הגיליון ריק או לא נמצא', 'warning');
            }
        } else {
            showNotification('שגיאה בגישה לגיליון', 'error');
        }
    } catch (error) {
        showNotification('שגיאה בסנכרון לקוחות', 'error');
    } finally {
        hideLoading();
    }
}

// === פונקציות מערכת ===

// בדיקת חיבור Apps Script
async function testAppsScriptConnection() {
    const url = document.getElementById('systemAppsScriptUrl').value.trim();
    
    if (!url) {
        showNotification('נא להזין URL של Apps Script', 'warning');
        return;
    }
    
    showLoading();
    try {
        const response = await fetch(url + '?action=getTasks');
        if (response.ok) {
            showNotification('חיבור ל-Apps Script תקין!', 'success');
        } else {
            showNotification('שגיאה בחיבור ל-Apps Script', 'error');
        }
    } catch (error) {
        showNotification('שגיאה בחיבור ל-Apps Script', 'error');
    } finally {
        hideLoading();
    }
}

// שמירת הגדרות מערכת
function saveSystemSettings() {
    const url = document.getElementById('systemAppsScriptUrl').value.trim();
    
    if (url) {
        appsScriptUrl = url;
        localStorage.setItem('appsScriptUrl', url);
        isCloudMode = true;
        showNotification('הגדרות מערכת נשמרו - מעבר למצב ענן', 'success');
    } else {
        localStorage.removeItem('appsScriptUrl');
        isCloudMode = false;
        showNotification('הגדרות מערכת נשמרו - מעבר למצב מקומי', 'success');
    }
    
    loadSettingsData();
}

// ייצוא נתונים
function exportData() {
    const data = {
        tasks: allTasks,
        users: allUsers.map(u => ({...u, password: '***'})),
        clients: allClients,
        taskTypes: allTaskTypes,
        exportDate: new Date().toISOString(),
        version: '1.0'
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `task-management-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification('הנתונים יוצאו בהצלחה!', 'success');
}

// ייבוא נתונים
function importData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                
                if (data.tasks) allTasks = data.tasks;
                if (data.clients) allClients = data.clients;
                if (data.taskTypes) allTaskTypes = data.taskTypes;
                
                saveDataToLocal();
                updateUI();
                
                showNotification('נתונים יובאו בהצלחה!', 'success');
            } catch (error) {
                showNotification('שגיאה בייבוא הנתונים', 'error');
            }
        };
        reader.readAsText(file);
    };
    input.click();
}

// ניקוי כל הנתונים
function clearAllData() {
    if (!confirm('האם אתה בטוח שברצונך למחוק את כל הנתונים? פעולה זו אינה הפיכה!')) {
        return;
    }
    
    localStorage.clear();
    allTasks = [];
    allUsers = [];
    allClients = [];
    allTaskTypes = [];
    
    showNotification('כל הנתונים נמחקו', 'warning');
    
    // חזרה להגדרה ראשונית
    hideAllScreens();
    document.getElementById('setupScreen').classList.add('active');
}

// יצירת גיבוי
async function createBackup() {
    if (isCloudMode && appsScriptUrl) {
        showLoading();
        try {
            const response = await fetch(appsScriptUrl, {
                method: 'POST',
                body: JSON.stringify({ action: 'createBackup' })
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    showNotification('גיבוי נוצר בהצלחה בענן!', 'success');
                } else {
                    exportData(); // גיבוי מקומי
                }
            } else {
                exportData(); // גיבוי מקומי
            }
        } catch (error) {
            exportData(); // גיבוי מקומי
        } finally {
            hideLoading();
        }
    } else {
        exportData(); // גיבוי מקומי
    }
}

// === פונקציות מודלים ===

// מודלים - הוספת משתמש
function showAddUserModal() {
    document.getElementById('addUserModal').classList.add('active');
}

function hideAddUserModal() {
    document.getElementById('addUserModal').classList.remove('active');
    clearAddUserForm();
}

function clearAddUserForm() {
    document.getElementById('newUsername').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('userType').selectedIndex = 0;
    document.getElementById('fullName').value = '';
}

async function addUser() {
    const username = document.getElementById('newUsername').value.trim();
    const password = document.getElementById('newPassword').value.trim();
    const type = document.getElementById('userType').value;
    const fullName = document.getElementById('fullName').value.trim();
    
    if (!username || !password || !fullName) {
        showNotification('נא למלא את כל השדות', 'warning');
        return;
    }
    
    if (allUsers.some(u => u.username === username)) {
        showNotification('שם המשתמש כבר קיים', 'warning');
        return;
    }
    
    const newUser = {
        id: allUsers.length > 0 ? Math.max(...allUsers.map(u => u.id)) + 1 : 1,
        username,
        password,
        type,
        fullName,
        active: true
    };
    
    allUsers.push(newUser);
    await saveAllData();
    
    hideAddUserModal();
    showNotification('המשתמש נוסף בהצלחה!', 'success');
}

// מודלים - הוספת סוג משימה
function showAddTaskTypeModal() {
    document.getElementById('addTaskTypeModal').classList.add('active');
}

function hideAddTaskTypeModal() {
    document.getElementById('addTaskTypeModal').classList.remove('active');
    document.getElementById('newTaskTypeName').value = '';
}

async function addTaskType() {
    const typeName = document.getElementById('newTaskTypeName').value.trim();
    
    if (!typeName) {
        showNotification('נא להזין שם לסוג המשימה', 'warning');
        return;
    }
    
    if (allTaskTypes.includes(typeName)) {
        showNotification('סוג המשימה כבר קיים', 'warning');
        return;
    }
    
    allTaskTypes.push(typeName);
    await saveAllData();
    
    hideAddTaskTypeModal();
    showNotification('סוג המשימה נוסף בהצלחה!', 'success');
}

// === פונקציות עזר כלליות ===

function showLoading() {
    document.getElementById('loadingIndicator').classList.add('active');
}

function hideLoading() {
    document.getElementById('loadingIndicator').classList.remove('active');
}

function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `notification ${type} active`;
    
    setTimeout(() => {
        notification.classList.remove('active');
    }, 4000);
}

// === Event Listeners ===

// סגירת מודלים בלחיצה מחוץ לתוכן
document.addEventListener('click', function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.classList.remove('active');
    }
});

// סגירת מודלים ב-ESC
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        document.querySelectorAll('.modal.active').forEach(modal => {
            modal.classList.remove('active');
        });
    }
});

// === שמירה אוטומטית ===

// שמירה אוטומטית כל 5 דקות
setInterval(async () => {
    if (currentUser && (allTasks.length > 0 || allUsers.length > 0)) {
        console.log('שמירה אוטומטית...');
        try {
            await saveAllData();
        } catch (error) {
            console.error('שגיאה בשמירה אוטומטית:', error);
        }
    }
}, 5 * 60 * 1000); // 5 דקות

// === פונקציות נוספות שהיו חסרות ===

// פונקציות אחזור נתונים נוספות שעשויות להידרש
function refreshData() {
    loadAllData();
    if (currentUser) {
        updateUI();
    }
}

// פונקציית דיבוג
function debugInfo() {
    console.log('=== Debug Info ===');
    console.log('Current User:', currentUser);
    console.log('Cloud Mode:', isCloudMode);
    console.log('Apps Script URL:', appsScriptUrl);
    console.log('Tasks Count:', allTasks.length);
    console.log('Clients Count:', allClients.length);
    console.log('Users Count:', allUsers.length);
    console.log('Task Types Count:', allTaskTypes.length);
}

// הוספת פונקציית דיבוג למסוף הדפדפן
window.debugTaskSystem = debugInfo;// קובץ script.js - לוגיקה של מערכת ניהול המשימות

// === משתנים גלובליים ===
let currentUser = null;
let allTasks = [];
let allClients = [];
let allUsers = [];
let allTaskTypes = [];
let currentEditingTask = null;
let appsScriptUrl = '';
let isCloudMode = false;

// === אתחול המערכת ===
document.addEventListener('DOMContentLoaded', function() {
    console.log('מערכת ניהול משימות מתקדמת מתחילה...');
    initializeSystem();
});

// אתחול מערכת
function initializeSystem() {
    // בדיקה אם יש URL של Apps Script שמור
    const savedUrl = localStorage.getItem('appsScriptUrl');
    if (savedUrl) {
        appsScriptUrl = savedUrl;
        document.getElementById('appsScriptUrl').value = savedUrl;
        document.getElementById('systemAppsScriptUrl').value = savedUrl;
        isCloudMode = true;
    }

    // טעינת הגדרות לקוחות
    const clientsSettings = JSON.parse(localStorage.getItem('clientsSettings') || '{}');
    if (clientsSettings.spreadsheetId) {
        document.getElementById('clientsSpreadsheetId').value = clientsSettings.spreadsheetId;
        document.getElementById('clientsSheetName').value = clientsSettings.sheetName || 'Sheet1';
    }

    // אתחול נתונים ברירת מחדל
    initializeDefaultData();
}

// === פונקציות הגדרה ראשונית ===

// התחלה עם Google Apps Script
function startWithAppsScript() {
    const url = document.getElementById('appsScriptUrl').value.trim();
    if (url) {
        appsScriptUrl = url;
        localStorage.setItem('appsScriptUrl', url);
        isCloudMode = true;
        showNotification('מחובר ל-Google Apps Script!', 'success');
    } else {
        showNotification('נא להזין URL של Google Apps Script', 'warning');
        return;
    }
    
    hideAllScreens();
    document.getElementById('roleSelectionScreen').classList.add('active');
}

// התחלה במצב מקומי
function startLocalMode() {
    isCloudMode = false;
    hideAllScreens();
    document.getElementById('roleSelectionScreen').classList.add('active');
}

// חזרה להגדרה
function goBackToSetup() {
    hideAllScreens();
    document.getElementById('setupScreen').classList.add('active');
}

// אתחול נתונים ברירת מחדל
function initializeDefaultData() {
    // משימות לדוגמה
    if (!localStorage.getItem('tasks')) {
        const sampleTasks = [
            {
                id: 1,
                client: 'חברת אבג בע"מ',
                assignedPartner: 'מנהל המערכת',
                additionalEmployee: 'עובד 1',
                taskType: 'פגישת ייעוץ',
                status: 'בביצוע',
                priority: 'גבוהה',
                dueDate: '2024-12-25',
                notes: 'פגישה חשובה עם הלקוח לגבי הפרויקט החדש',
                createdBy: 'מנהל המערכת',
                createdDate: '2024-12-15',
                comments: []
            },
            {
                id: 2,
                client: 'מטרו סופר',
                assignedPartner: 'שותף 1',
                additionalEmployee: '',
                taskType: 'הכנת הצעת מחיר',
                status: 'טרם התחיל',
                priority: 'בינונית',
                dueDate: '2024-12-30',
                notes: 'הצעת מחיר למערכת קופות חדשה',
                createdBy: 'שותף 1',
                createdDate: '2024-12-14',
                comments: []
            }
        ];
        localStorage.setItem('tasks', JSON.stringify(sampleTasks));
    }

    // לקוחות לדוגמה
    if (!localStorage.getItem('clients')) {
        const sampleClients = [
            { name: 'חברת אבג בע"מ', details: 'חברת הייטק מובילה' },
            { name: 'מטרו סופר', details: 'רשת סופרמרקטים' },
            { name: 'רשת פיצוחיה', details: 'רשת מזון מהיר' },
            { name: 'בנק הדוגמה', details: 'מוסד פיננסי' }
        ];
        localStorage.setItem('clients', JSON.stringify(sampleClients));
    }

    // משתמשים לדוגמה
    if (!localStorage.getItem('users')) {
        const sampleUsers = [
            {
                id: 1,
                username: 'admin',
                password: 'admin123',
                type: 'partner',
                fullName: 'מנהל המערכת'
            },
            {
                id: 2,
                username: 'employee1',
                password: 'emp123',
                type: 'employee',
                fullName: 'עובד לדוגמה'
            }
        ];
        localStorage.setItem('users', JSON.stringify(sampleUsers));
    }

    // סוגי משימות לדוגמה
    if (!localStorage.getItem('taskTypes')) {
        const sampleTaskTypes = [
            'פגישת ייעוץ',
            'הכנת הצעת מחיר',
            'מעקב הזמנה',
            'שירות לקוחות',
            'תיקון תקלה',
            'פיתוח מוצר'
        ];
        localStorage.setItem('taskTypes', JSON.stringify(sampleTaskTypes));
    }

    // טעינת נתונים לזיכרון
    loadAllData();
}

// === פונקציות טעינה ושמירה ===

// טעינת כל הנתונים
async function loadAllData() {
    showLoading();
    try {
        if (isCloudMode && appsScriptUrl) {
            await loadDataFromCloud();
        } else {
            loadDataFromLocal();
        }
        updateUI();
    } catch (error) {
        console.error('שגיאה בטעינת נתונים:', error);
        showNotification('שגיאה בטעינת נתונים, עובר למצב מקומי', 'warning');
        loadDataFromLocal();
        updateUI();
    } finally {
        hideLoading();
    }
}

// טעינת נתונים מהענן
async function loadDataFromCloud() {
    const requests = [
        fetch(appsScriptUrl + '?action=getTasks'),
        fetch(appsScriptUrl + '?action=getUsers'),
        fetch(appsScriptUrl + '?action=getTaskTypes'),
        fetch(appsScriptUrl + '?action=getClients')
    ];

    const responses = await Promise.all(requests);
    const data = await Promise.all(responses.map(r => r.json()));

    allTasks = data[0] || [];
    allUsers = data[1] || [];
    allTaskTypes = data[2] || [];
    allClients = data[3] || [];

    // שמירה מקומית כגיבוי
    localStorage.setItem('tasks', JSON.stringify(allTasks));
    localStorage.setItem('users', JSON.stringify(allUsers));
    localStorage.setItem('taskTypes', JSON.stringify(allTaskTypes));
    localStorage.setItem('clients', JSON.stringify(allClients));
}

// טעינת נתונים מקומיים
function loadDataFromLocal() {
    allTasks = JSON.parse(localStorage.getItem('tasks') || '[]');
    allUsers = JSON.parse(localStorage.getItem('users') || '[]');
    allTaskTypes = JSON.parse(localStorage.getItem('taskTypes') || '[]');
    allClients = JSON.parse(localStorage.getItem('clients') || '[]');
}

// שמירת כל הנתונים
async function saveAllData() {
    showLoading();
    try {
        if (isCloudMode && appsScriptUrl) {
            await saveDataToCloud();
            showNotification('נתונים נשמרו בענן בהצלחה!', 'success');
        } else {
            saveDataToLocal();
            showNotification('נתונים נשמרו מקומית בהצלחה!', 'success');
        }
    } catch (error) {
        console.error('שגיאה בשמירת נתונים:', error);
        saveDataToLocal();
        showNotification('שגיאה בשמירה בענן, נשמר מקומית', 'warning');
    } finally {
        hideLoading();
    }
}

// שמירת נתונים בענן
async function saveDataToCloud() {
    const requests = [
        fetch(appsScriptUrl, {
            method: 'POST',
            body: JSON.stringify({ action: 'saveTasks', tasks: allTasks })
        }),
        fetch(appsScriptUrl, {
            method: 'POST',
            body: JSON.stringify({ action: 'saveUsers', users: allUsers })
        }),
        fetch(appsScriptUrl, {
            method: 'POST',
            body: JSON.stringify({ action: 'saveTaskTypes', taskTypes:
        
